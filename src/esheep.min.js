const VERSION="0.7",ACTIVATE_DEBUG=!1,DEFAULT_XML="http://esheep.petrucci.ch/script/animation.php",COLLISION_WITH=["div","hr"];class eSheep{constructor(a){this.animationFile=DEFAULT_XML,this.DOMdiv=document.createElement("div"),this.DOMimg=document.createElement("img"),this.DOMinfo=document.createElement("div"),this.parser=new DOMParser,this.xmlDoc=null,this.isChild=null!=a,this.tilesX=1,this.tilesY=1,this.imageW=1,this.imageH=1,this.imageX=1,this.imageY=1,this.flipped=!1,this.dragging=!1,this.infobox=!1,this.animationId=0,this.animationStep=0,this.animationNode=null,this.sprite=new Image,this.HTMLelement=null,this.randS=100*Math.random(),this.screenW=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.screenH=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}Start(a){"undefined"!=typeof a&&null!=a&&(this.animationFile=a);var b=new XMLHttpRequest,c=this;b.open("GET",this.animationFile,!0),b.addEventListener("readystatechange",function(){4==this.readyState&&(200==this.status?c._parseXML(this.responseText):console.error("XML not available:"+this.statusText+"\n"+this.responseText))}),b.send(null)}_parseXML(a){this.xmlDoc=this.parser.parseFromString(a,"text/xml");var b=this.xmlDoc.getElementsByTagName("image")[0];this.tilesX=b.getElementsByTagName("tilesx")[0].textContent,this.tilesY=b.getElementsByTagName("tilesy")[0].textContent,this.sprite.addEventListener("load",function(){var l="width:"+this.sprite.width+"px;height:"+this.sprite.height+"px;position:absolute;top:0px;left:0px;";this.DOMimg.setAttribute("style",l),this.DOMimg.addEventListener("dragstart",function(m){return m.preventDefault(),!1}),this.imageW=this.sprite.width/this.tilesX,this.imageH=this.sprite.height/this.tilesY,l="width:"+this.imageW+"px;height:"+this.imageH+"px;position:fixed;top:"+this.imageY+"px;left:"+this.imageX+"px;transform:rotatey(0deg);cursor:move;z-index:2000;overflow:hidden;",this.DOMdiv.setAttribute("style",l),this.DOMdiv.appendChild(this.DOMimg),this.isChild?this._spawnChild():this._spawnESheep()}.bind(this)),this.sprite.src="data:image/png;base64,"+b.getElementsByTagName("png")[0].textContent,this.DOMimg.setAttribute("src",this.sprite.src),this.DOMdiv.addEventListener("mousemove",function(h){if(!this.dragging&&1==h.buttons&&0==h.button){this.dragging=!0,this.HTMLelement=null;for(var l=this.xmlDoc.getElementsByTagName("animations")[0],m=l.getElementsByTagName("animation"),n=0;n<m.length;n++)if("drag"==m[n].getElementsByTagName("name")[0].textContent){this.animationId=m[n].getAttribute("id"),this.animationStep=0,this.animationNode=m[n];break}}}.bind(this)),document.body.addEventListener("mousemove",function(h){this.dragging&&(this.imageX=parseInt(h.clientX)-this.imageW/2,this.imageY=parseInt(h.clientY)-this.imageH/2,this.DOMdiv.style.left=this.imageX+"px",this.DOMdiv.style.top=this.imageY+"px")}.bind(this)),document.body.addEventListener("resize",function(){this.screenW=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.screenH=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,this.imageY+this.imageH>this.screenH&&(this.imageY=this.screenH-this.imageH,this.DOMdiv.style.top=this.imageY+"px"),this.imageX+this.imageW>this.screenW&&(this.imageX=this.screenW-this.imageW,this.DOMdiv.style.left=this.imageX+"px")}.bind(this)),this.DOMdiv.addEventListener("contextmenu",function(h){return h.preventDefault(),!1}),this.DOMdiv.addEventListener("mouseup",function(){this.dragging?this.dragging=!1:this.infobox?(this.DOMinfo.style.display="none",this.infobox=!1):(this.DOMinfo.style.left=Math.min(this.screenW-200,Math.max(0,parseInt(this.imageX+this.imageW/2-parseInt(this.DOMinfo.style.width)/2)))+"px",this.DOMinfo.style.top=parseInt(this.imageY-parseInt(this.DOMinfo.style.height))+"px",this.DOMinfo.style.display="block",this.infobox=!0)}.bind(this)),this.DOMinfo.addEventListener("mouseup",function(){this.DOMinfo.style.display="none",this.infobox=!1}.bind(this));this.DOMinfo.setAttribute("style","width:200px;height:100px;position:fixed;top:100px;left:10px;display:none;border-width:2px;border-radius:5px;border-style:ridge;border-color:#0000ab;text-align:center;text-shadow: 1px 1px 3px #ffff88;box-shadow: 3px 3px 10px #888888;color:black;opacity:0.9;z-index:9999;overflow:auto;background: linear-gradient(to bottom right, rgba(128,128,255,0.7), rgba(200,200,255,0.4));");var d=document.createElement("b").appendChild(document.createTextNode("eSheep")),f=document.createElement("sup"),g=document.createElement("a");f.appendChild(document.createTextNode("ver: "+VERSION)),f.setAttribute("style","float:right"),g.appendChild(document.createTextNode("http://esheep.petrucci.ch")),g.setAttribute("href","http://esheep.petrucci.ch"),g.setAttribute("target","_blank"),this.DOMinfo.appendChild(d),this.DOMinfo.appendChild(f),this.DOMinfo.appendChild(document.createElement("br")),this.DOMinfo.appendChild(document.createElement("hr")),this.DOMinfo.appendChild(document.createTextNode("Visit the home page of this lovely sheep:")),this.DOMinfo.appendChild(document.createElement("br")),this.DOMinfo.appendChild(g),document.body.appendChild(this.DOMinfo),document.body.appendChild(this.DOMdiv)}_setPosition(a,b,c){c?(this.imageX=parseInt(a),this.imageY=parseInt(b)):(this.imageX=parseInt(this.imageX)+parseInt(a),this.imageY=parseInt(this.imageY)+parseInt(b)),this.DOMdiv.style.left=this.imageX+"px",this.DOMdiv.style.top=this.imageY+"px"}_spawnESheep(){for(var a=this.xmlDoc.getElementsByTagName("spawns")[0],b=a.getElementsByTagName("spawn"),c=0,d=0;d<b.length;d++)c+=parseInt(b[0].getAttribute("probability"));var f=Math.random()*c;for(c=0,d=0;d<b.length;d++)if(c+=parseInt(b[d].getAttribute("probability")),c>=f||d==b.length-1){this._setPosition(this._parseKeyWords(b[d].getElementsByTagName("x")[0].textContent),this._parseKeyWords(b[d].getElementsByTagName("y")[0].textContent),!0),ACTIVATE_DEBUG,this.animationId=b[d].getElementsByTagName("next")[0].textContent,this.animationStep=0;for(var g=this.xmlDoc.getElementsByTagName("animations")[0],h=g.getElementsByTagName("animation"),l=0;l<h.length;l++)if(h[l].getAttribute("id")==this.animationId){this.animationNode=h[l];for(var g=this.xmlDoc.getElementsByTagName("childs")[0],h=g.getElementsByTagName("child"),m=0;m<h.length;m++)if(h[m].getAttribute("animationid")==this.animationId){var n=new eSheep(!0);n.animationId=h[m].getElementsByTagName("next")[0].textContent;var o=h[m].getElementsByTagName("x")[0].textContent,p=h[m].getElementsByTagName("y")[0].textContent;n._setPosition(this._parseKeyWords(o),this._parseKeyWords(p),!0),n.Start(this.animationFile);break}break}break}this._nextESheepStep()}_spawnChild(){for(var a=this.xmlDoc.getElementsByTagName("animations")[0],b=a.getElementsByTagName("animation"),c=0;c<b.length;c++)if(b[c].getAttribute("id")==this.animationId){this.animationNode=b[c];break}this._nextESheepStep()}_parseKeyWords(value){value=value.replace(/screenW/g,this.screenW),value=value.replace(/screenH/g,this.screenH),value=value.replace(/areaW/g,this.screenH),value=value.replace(/areaH/g,this.screenH),value=value.replace(/imageW/g,this.imageW),value=value.replace(/imageH/g,this.imageH),value=value.replace(/random/g,100*Math.random()),value=value.replace(/randS/g,this.randS),value=value.replace(/imageX/g,this.imageX),value=value.replace(/imageY/g,this.imageY);var ret=0;try{ret=eval(value)}catch(a){console.error("Unable to parse this position: \n'"+value+"'\n Error message: \n"+a.message)}return ret}_getNextRandomNode(a){var b=a.getElementsByTagName("next"),c=this.xmlDoc.getElementsByTagName("animations")[0],d=c.getElementsByTagName("animation"),f=0,g=!1;if(0==b.length)return this.isChild?(ACTIVATE_DEBUG,document.body.removeChild(this.DOMinfo),document.body.removeChild(this.DOMdiv),delete this):this._spawnESheep(),!1;for(var h=0;h<b.length;h++)f+=parseInt(b[h].getAttribute("probability"));var l=Math.random()*f,m=0;for(f=0,h=0;h<b.length;h++)if(f+=parseInt(b[h].getAttribute("probability")),f>=l){m=h;break}for(h=0;h<d.length;h++)if(d[h].getAttribute("id")==b[m].textContent){this.animationId=d[h].getAttribute("id"),this.animationStep=0,this.animationNode=d[h],g=!0;break}if(g){var c=this.xmlDoc.getElementsByTagName("childs")[0],d=c.getElementsByTagName("child");for(h=0;h<d.length;h++)if(d[h].getAttribute("animationid")==this.animationId){var n=new eSheep(!0);n.animationId=d[h].getElementsByTagName("next")[0].textContent;var o=d[h].getElementsByTagName("x")[0].textContent,p=d[h].getElementsByTagName("y")[0].textContent;n._setPosition(this._parseKeyWords(o),this._parseKeyWords(p),!0),n.Start(this.animationFile);break}}return g}_checkOverlapping(){var c,a=this.imageX,b=this.imageY+this.imageH,d=20;for(var f in this.HTMLelement&&(d=5),COLLISION_WITH)for(var g=document.body.getElementsByTagName(COLLISION_WITH[f]),h=0;h<g.length;h++)if(c=g[h].getBoundingClientRect(),b>c.top-2&&b<c.top+d&&a>c.left&&a<c.right-this.imageW){var l=window.getComputedStyle(g[h]);if(""!=l.borderTopStyle&&"none"!=l.borderTopStyle&&"none"!=l.display)return g[h]}return!1}_getNodeValue(a,b,c){if(this.animationNode&&this.animationNode.getElementsByTagName(a)){if(this.animationNode.getElementsByTagName(a)[0].getElementsByTagName(b)[0]){var d=this.animationNode.getElementsByTagName(a)[0].getElementsByTagName(b)[0].textContent;return this._parseKeyWords(d)}return c}}_nextESheepStep(){var t,a=this._getNodeValue("start","x",0),b=this._getNodeValue("start","y",0),c=this._getNodeValue("start","offsety",0),d=this._getNodeValue("start","opacity",1),f=this._getNodeValue("start","interval",1e3),g=this._getNodeValue("end","x",0),h=this._getNodeValue("end","y",0),l=this._getNodeValue("end","offsety",0),m=this._getNodeValue("end","interval",1),n=this._getNodeValue("end","interval",1e3),o=this._parseKeyWords(this.animationNode.getElementsByTagName("sequence")[0].getAttribute("repeat")),p=this.animationNode.getElementsByTagName("sequence")[0].getAttribute("repeatfrom"),q=this.animationNode.getElementsByTagName("gravity"),r=this.animationNode.getElementsByTagName("border"),s=this.animationNode.getElementsByTagName("frame").length+(this.animationNode.getElementsByTagName("frame").length-p)*o;if(t=this.animationStep<this.animationNode.getElementsByTagName("frame").length?this.animationNode.getElementsByTagName("frame")[this.animationStep].textContent:0==p?this.animationNode.getElementsByTagName("frame")[this.animationStep%this.animationNode.getElementsByTagName("frame").length].textContent:this.animationNode.getElementsByTagName("frame")[parseInt(p)+parseInt((this.animationStep-p)%(this.animationNode.getElementsByTagName("frame").length-p))].textContent,this.DOMimg.style.left=-this.imageW*(t%this.tilesX)+"px",this.DOMimg.style.top=-this.imageH*parseInt(t/this.tilesX)+"px",this.dragging||this.infobox)return this.animationStep++,void window.setTimeout(function(){this._nextESheepStep()}.bind(this),50);if(this.flipped&&(a=-a,g=-g),0==this.animationStep?this._setPosition(a,b,!1):this._setPosition(parseInt(a)+parseInt((g-a)*this.animationStep/s),parseInt(b)+parseInt((h-b)*this.animationStep/s),!1),this.animationStep++,this.animationStep>=s){if(this.animationNode.getElementsByTagName("action")[0])switch(this.animationNode.getElementsByTagName("action")[0].textContent){case"flip":"rotateY(0deg)"==this.DOMdiv.style.transform?(this.DOMdiv.style.transform="rotateY(180deg)",this.flipped=!0):(this.DOMdiv.style.transform="rotateY(0deg)",this.flipped=!1);break;default:}if(!this._getNextRandomNode(this.animationNode.getElementsByTagName("sequence")[0]))return}var u=!1;return r&&r[0]&&r[0].getElementsByTagName("next")&&(0>g&&0>this.imageX?(this.imageX=0,u=!0):0<g&&this.imageX>this.screenW-this.imageW?(this.imageX=this.screenW-this.imageW,this.DOMdiv.style.left=parseInt(this.imageX)+"px",u=!0):0>h&&0>this.imageY?(this.imageY=0,u=!0):0<h&&this.imageY>this.screenH-this.imageH?(this.imageY=this.screenH-this.imageH,u=!0):0<h?this._checkOverlapping()&&this.imageY>this.imageH&&(this.HTMLelement=this._checkOverlapping(),this.imageY=Math.ceil(this.HTMLelement.getBoundingClientRect().top)-this.imageH,u=!0):this.HTMLelement&&!this._checkOverlapping()&&(this.imageY+this.imageH>this.HTMLelement.getBoundingClientRect().top+3||this.imageY+this.imageH<this.HTMLelement.getBoundingClientRect().top-3?this.HTMLelement=null:this.imageX<this.HTMLelement.getBoundingClientRect().left?(this.imageX=parseInt(this.imageX+3),u=!0):(this.imageX=parseInt(this.imageX-3),u=!0),this.DOMdiv.style.left=parseInt(this.imageX)+"px"),u&&!this._getNextRandomNode(r[0]))||!u&&q&&q[0]&&q[0].getElementsByTagName("next")&&this.imageY<this.screenH-this.imageH-2&&(null==this.HTMLelement?u=!0:!this._checkOverlapping()&&(u=!0,this.HTMLelement=null),u&&!this._getNextRandomNode(q[0]))?void 0:!u&&(this.imageX<-this.imageW&&0>g||this.imageX>this.screenW&&0<g||this.imageY<-this.imageH&&0>b||this.imageY>this.screenH&&0<h)?(u=!0,void(this.isChild||this._spawnESheep())):void window.setTimeout(function(){this._nextESheepStep()}.bind(this),parseInt(f)+parseInt((n-f)*this.animationStep/s))}}