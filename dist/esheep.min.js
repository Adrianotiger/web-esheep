"use strict";

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/*
 * Project:
 *                eSheep - Webpage
 *
 * Date:
 *                04.april 2018
 *
 * Author:
 *                Adriano Petrucci (http://esheep.petrucci.ch)
 *
 * Version:       0.9.0
 *
 * Introduction:
 *                As "wrapper" for the OpenSource C# project
 *                (see https://github.com/Adrianotiger/desktopPet),
 *                this javascript "class" was written to get the animations also inside your
 *                webpage. It doesn't work like the Windows version, but show much animations from it.
 *
 * Description:
 *                Add a walking pet (sheep to your home page) with just a few lines of code!
 *                Will add a lovely sheep (stray sheep) and this will walk around your page and over
 *                all <hr>s and <div>s with a border. You can also select another animation, using your
 *                personal XML file or one from the database.
 *
 * How to use:
 *                Add this line in your <header>:
 *                <script src="https://adrianotiger.github.io/web-esheep/src/esheep.js"></script>
 *                Add this lines in your <body> (at the end if possible):
 *                <script>
                    var pet = new eSheep();
                    pet.Start();
                  </script>
 *                That's all!
 *
 * Requirement:
 *                Tested on IE11, Edge and Opera
 *
 * Changelog:
 *                Version 0.9.0 - 11.07.2019:
 *                  - Updated animation link to the main project animation
 *                  - Recompiled with new Yarn version (security vulnerability)
 *                Version 0.8.0 - 29.05.2018:
 *                  - Moved animation files to github
 *                  - Added options to the script 
 *                  - Load an animation from the GitHub animations from the popup window
 *                Version 0.7.1 - 04.04.2018:
 *                  - Add max-width: none to ensure the image is properly shown
 *                Version 0.7 - 13.11.2017:
 *                  - better Javascript structure
 *                  - GitHub version (https://github.com/Adrianotiger/web-esheep)
 *                  - Childs animations added
 *                  - Better comments
 *                  - Replaced alerts with console.error
 *                Version 0.5 - 12.07.2017:
 *                  - animations starts only once the image was loaded (thanks RedSparr0w)
 *                Version 0.x:
 *                  - still beta versions...
 */

var VERSION = '0.8.0'; // web eSheep version
var ACTIVATE_DEBUG = false; // show log on console
var DEFAULT_XML = "https://adrianotiger.github.io/desktopPet/Pets/esheep64/animations.xml"; // default XML animation
var COLLISION_WITH = ["div", "hr"]; // elements on page to detect for collisions

/*
 * eSheep class.
 * Create a new class of this type if you want a new pet. Will create the components for the pet.
 * Once created, you can call [variableName].Start() to start the animation with your desired pet.
 */

var eSheep = function () {
  /* Parameters for options [default]:
   * - allowPets: [none], all
   * - allowPopup: [yes], no
   */
  function eSheep(options, isChild) {
    _classCallCheck(this, eSheep);

    this.userOptions = options ? options : { allowPets: "none", allowPopup: "yes" };
    if (!this.userOptions.allowPopup) this.userOptions.allowPopup = "yes";
    if (!this.userOptions.allowPets) this.userOptions.allowPets = "none";

    // CORS: Cross calls are not accepted by new browsers.
    this.animationFile = DEFAULT_XML;

    this.id = Date.now() + Math.random();

    this.DOMdiv = document.createElement("div"); // Div added to webpage, containing the sheep
    this.DOMdiv.setAttribute("id", this.id);
    this.DOMimg = document.createElement("img"); // Tile image, will be positioned inside the div
    this.DOMinfo = document.createElement("div"); // about dialog, if you press on the sheep

    this.parser = new DOMParser(); // XML parser
    this.xmlDoc = null; // parsed XML Document
    this.prepareToDie = false; // when removed, animations should be stopped

    this.isChild = isChild != null; // Child will be removed once they reached the end

    this.tilesX = 1; // Quantity of images inside Tile
    this.tilesY = 1; // Quantity of images inside Tile
    this.imageW = 1; // Width of the sprite image
    this.imageH = 1; // Height of the sprite image
    this.imageX = 1; // Position of sprite inside webpage
    this.imageY = 1; // Position of sprite inside webpage
    this.flipped = false; // if sprite is flipped
    this.dragging = false; // if user is dragging the sheep
    this.infobox = false; // if infobox is visible
    this.animationId = 0; // current animation ID
    this.animationStep = 0; // current animation step
    this.animationNode = null; // current animation DOM node
    this.sprite = new Image(); // sprite image (Tiles)
    this.HTMLelement = null; // the HTML element where the pet is walking on
    this.randS = Math.random() * 100; // random value, will change when page is reloaded

    this.screenW = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; // window width

    this.screenH = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight; // window height
  }

  /*
   * Start new animation on the page.
   * if animation is not set, the default sheep will be taken
   */


  _createClass(eSheep, [{
    key: "Start",
    value: function Start(animation) {
      if (typeof animation !== 'undefined' && animation != null) {
        this.animationFile = animation;
      }

      var ajax = new XMLHttpRequest();
      var sheepClass = this;

      ajax.open("GET", this.animationFile, true);
      ajax.addEventListener("readystatechange", function () {
        if (this.readyState == 4) {
          if (this.status == 200)
            // successfully loaded XML, parse it and create first esheep.
            sheepClass._parseXML(this.responseText);else console.error("XML not available:" + this.statusText + "\n" + this.responseText);
        }
      });
      ajax.send(null);
    }
  }, {
    key: "remove",
    value: function remove() {
      var _this = this;

      this.prepareToDie = true;
      this.DOMinfo.Hide();
      setTimeout(function () {
        _this.DOMdiv = _this.DOMimg = _this.DOMinfo = null;
        document.getElementById(_this.id).outerHTML = '';
      }, 500);
    }

    /*
     * Parse loaded XML, contains spawn, animations and childs
     */

  }, {
    key: "_parseXML",
    value: function _parseXML(text) {
      var _this2 = this;

      this.xmlDoc = this.parser.parseFromString(text, 'text/xml');
      var image = this.xmlDoc.getElementsByTagName('image')[0];
      this.tilesX = image.getElementsByTagName("tilesx")[0].textContent;
      this.tilesY = image.getElementsByTagName("tilesy")[0].textContent;
      // Event listener: Sprite was loaded =>
      //   play animation only when the sprite is loaded
      this.sprite.addEventListener("load", function () {
        if (ACTIVATE_DEBUG) console.log("Sprite image loaded");
        var attribute = "width:" + _this2.sprite.width + "px;" + "height:" + _this2.sprite.height + "px;" + "position:absolute;" + "top:0px;" + "left:0px;" + "max-width: none;";
        _this2.DOMimg.setAttribute("style", attribute);
        // prevent to move image (will show the entire sprite sheet if not catched)
        _this2.DOMimg.addEventListener("dragstart", function (e) {
          e.preventDefault();return false;
        });
        _this2.imageW = _this2.sprite.width / _this2.tilesX;
        _this2.imageH = _this2.sprite.height / _this2.tilesY;
        attribute = "width:" + _this2.imageW + "px;" + "height:" + _this2.imageH + "px;" + "position:fixed;" + "top:" + _this2.imageY + "px;" + "left:" + _this2.imageX + "px;" + "transform:rotatey(0deg);" + "cursor:move;" + "z-index:2000;" + "overflow:hidden;";
        _this2.DOMdiv.setAttribute("style", attribute);
        _this2.DOMdiv.appendChild(_this2.DOMimg);

        if (_this2.isChild) _this2._spawnChild();else _this2._spawnESheep();
      });

      this.sprite.src = 'data:image/png;base64,' + image.getElementsByTagName("png")[0].textContent;
      this.DOMimg.setAttribute("src", this.sprite.src);

      // Mouse move over eSheep, check if eSheep should be moved over the screen
      this.DOMdiv.addEventListener("mousemove", function (e) {
        if (!_this2.dragging && e.buttons == 1 && e.button == 0) {
          _this2.dragging = true;
          _this2.HTMLelement = null;
          var childsRoot = _this2.xmlDoc.getElementsByTagName('animations')[0];
          var childs = childsRoot.getElementsByTagName('animation');
          for (var k = 0; k < childs.length; k++) {
            if (childs[k].getElementsByTagName('name')[0].textContent == "drag") {
              _this2.animationId = childs[k].getAttribute("id");
              _this2.animationStep = 0;
              _this2.animationNode = childs[k];
              break;
            }
          }
        }
      });
      // Add event listener to body, if mouse moved too fast over the dragging eSheep
      document.body.addEventListener("mousemove", function (e) {
        if (_this2.dragging) {
          _this2.imageX = parseInt(e.clientX) - _this2.imageW / 2;
          _this2.imageY = parseInt(e.clientY) - _this2.imageH / 2;

          _this2.DOMdiv.style.left = _this2.imageX + "px";
          _this2.DOMdiv.style.top = _this2.imageY + "px";
          _this2.DOMinfo.style.left = parseInt(_this2.imageX + _this2.imageW / 2) + "px";
          _this2.DOMinfo.style.top = _this2.imageY + "px";
        }
      });
      // Window resized, recalculate eSheep bounds
      document.body.addEventListener("resize", function () {
        _this2.screenW = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;

        _this2.screenH = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

        if (_this2.imageY + _this2.imageH > _this2.screenH) {
          _this2.imageY = _this2.screenH - _this2.imageH;
          _this2.DOMdiv.style.top = _this2.imageY + "px";
        }
        if (_this2.imageX + _this2.imageW > _this2.screenW) {
          _this2.imageX = _this2.screenW - _this2.imageW;
          _this2.DOMdiv.style.left = _this2.imageX + "px";
        }
      });
      // Don't allow contextmenu over the sheep
      this.DOMdiv.addEventListener("contextmenu", function (e) {
        e.preventDefault();
        return false;
      });
      // Mouse released
      this.DOMdiv.addEventListener("mouseup", function (e) {
        if (_this2.dragging) {
          _this2.dragging = false;
        } else if (_this2.infobox) {
          _this2.DOMinfo.Hide();
          _this2.infobox = false;
        } else {
          if (_this2.userOptions.allowPopup === "yes") {
            _this2.DOMinfo.style.left = Math.min(_this2.screenW - _this2.imageW, Math.max(_this2.imageW, parseInt(_this2.imageX + _this2.imageW / 2))) + "px";
            _this2.DOMinfo.style.top = parseInt(_this2.imageY) + "px";
            _this2.DOMinfo.Show();
            _this2.infobox = true;
          }
        }
      });
      // Mouse released over the info box
      this.DOMinfo.addEventListener("mouseup", function (e) {
        _this2.DOMinfo.Hide();
        _this2.infobox = false;
      });
      // Create About box
      var attribute = "width:200px;" + "height:100px;" + "transform:translate(-50%, -50%) scale(0.1);" + "position:fixed;" + "top:100px;left:10px;" + "display:none;" + "border-width:2px;" + "border-radius:5px;" + "border-style:ridge;" + "border-color:#0000ab;" + "text-align:center;" + "text-shadow: 1px 1px 3px #ffff88;" + "box-shadow: 3px 3px 10px #888888;" + "color:black;" + "opacity:0.9;" + "z-index:9999;" + "overflow:auto;" + "transition:transform 0.3s ease;" + "background: linear-gradient(to bottom right, rgba(128,128,255,0.7), rgba(200,200,255,0.4));";
      this.DOMinfo.setAttribute("style", attribute);
      var headerNode = this.xmlDoc.getElementsByTagName('header')[0];
      var htmlT = document.createElement("b").appendChild(document.createTextNode(headerNode.getElementsByTagName('title')[0].textContent));
      var htmlV = document.createElement("sup");
      var htmlL = document.createElement("a");
      var htmlP = document.createElement("p");
      htmlV.appendChild(document.createTextNode("App v." + VERSION));
      htmlV.appendChild(document.createElement("br"));
      htmlV.appendChild(document.createTextNode("Pet v." + headerNode.getElementsByTagName('version')[0].textContent));
      htmlV.setAttribute("style", "float:right;text-align:right;");
      htmlL.appendChild(document.createTextNode("\uD83C\uDFE0"));
      htmlL.setAttribute("href", "https://github.com/Adrianotiger/web-esheep");
      htmlL.setAttribute("target", "_blank");
      htmlL.setAttribute("style", "float:left");
      htmlP.appendChild(document.createTextNode(headerNode.getElementsByTagName('info')[0].textContent));
      htmlP.setAttribute("style", "font-size:" + (100 - parseInt(headerNode.getElementsByTagName('info')[0].textContent.length / 10)) + "%;");
      this.DOMinfo.appendChild(htmlV);
      this.DOMinfo.appendChild(htmlL);
      if (this.userOptions.allowPets !== "none") {
        htmlL = document.createElement("a");
        htmlL.appendChild(document.createTextNode("\u2699"));
        htmlL.setAttribute("href", "javascript:;");
        htmlL.setAttribute("style", "float:left");
        this.DOMinfo.appendChild(htmlL);
        setTimeout(function () {
          _this2._loadPetList(htmlL);
        }, 100);
      }
      this.DOMinfo.appendChild(htmlT);
      this.DOMinfo.appendChild(document.createElement("br"));
      this.DOMinfo.appendChild(document.createElement("hr"));
      this.DOMinfo.appendChild(htmlP);
      // Add about and sheep elements to the body
      document.body.appendChild(this.DOMinfo);
      document.body.appendChild(this.DOMdiv);

      this.DOMinfo.Show = function () {
        _this2.DOMinfo.style.display = "block";
        _this2.DOMinfo.style.transform = "translate(-50%, -100%) scale(1.0)";
      };
      this.DOMinfo.Hide = function () {
        _this2.DOMinfo.style.transform = "translate(-50%, -50%) scale(0.1)";
        setTimeout(function () {
          _this2.DOMinfo.style.display = "none";
        }, 300);
      };
    }
  }, {
    key: "_setPosition",


    /*
     * Set new position for the pet
     * If absolute is true, the x and y coordinates are used as absolute values.
     * If false, x and y are added to the current position
     */
    value: function _setPosition(x, y, absolute) {
      if (this.DOMdiv) {
        if (absolute) {
          this.imageX = parseInt(x);
          this.imageY = parseInt(y);
        } else {
          this.imageX = parseInt(this.imageX) + parseInt(x);
          this.imageY = parseInt(this.imageY) + parseInt(y);
        }
        this.DOMdiv.style.left = this.imageX + "px";
        this.DOMdiv.style.top = this.imageY + "px";
      }
    }

    /*
     * Spawn new esheep, this is called if the XML was loaded successfully
     */

  }, {
    key: "_spawnESheep",
    value: function _spawnESheep() {
      var spawnsRoot = this.xmlDoc.getElementsByTagName('spawns')[0];
      var spawns = spawnsRoot.getElementsByTagName('spawn');
      var prob = 0;
      for (var i = 0; i < spawns.length; i++) {
        prob += parseInt(spawns[0].getAttribute("probability"));
      }var rand = Math.random() * prob;
      prob = 0;
      for (i = 0; i < spawns.length; i++) {
        prob += parseInt(spawns[i].getAttribute("probability"));
        if (prob >= rand || i == spawns.length - 1) {
          this._setPosition(this._parseKeyWords(spawns[i].getElementsByTagName('x')[0].textContent), this._parseKeyWords(spawns[i].getElementsByTagName('y')[0].textContent), true);
          if (ACTIVATE_DEBUG) console.log("Spawn: " + this.imageX + ", " + this.imageY);
          this.animationId = spawns[i].getElementsByTagName('next')[0].textContent;
          this.animationStep = 0;
          var childsRoot = this.xmlDoc.getElementsByTagName('animations')[0];
          var childs = childsRoot.getElementsByTagName('animation');
          for (var k = 0; k < childs.length; k++) {
            if (childs[k].getAttribute("id") == this.animationId) {
              this.animationNode = childs[k];

              // Check if child should be loaded toghether with this animation
              var childsRoot = this.xmlDoc.getElementsByTagName('childs')[0];
              var childs = childsRoot.getElementsByTagName('child');
              for (var j = 0; j < childs.length; j++) {
                if (childs[j].getAttribute("animationid") == this.animationId) {
                  if (ACTIVATE_DEBUG) console.log("Child from Spawn");
                  var eSheepChild = new eSheep(null, true);
                  eSheepChild.animationId = childs[j].getElementsByTagName('next')[0].textContent;
                  var x = childs[j].getElementsByTagName('x')[0].textContent; //
                  var y = childs[j].getElementsByTagName('y')[0].textContent;
                  eSheepChild._setPosition(this._parseKeyWords(x), this._parseKeyWords(y), true);
                  // Start animation
                  eSheepChild.Start(this.animationFile);
                  break;
                }
              }
              break;
            }
          }
          break;
        }
      }
      // Play next step
      this._nextESheepStep();
    }

    /*
     * Like spawnESheep, but for Childs
     */

  }, {
    key: "_spawnChild",
    value: function _spawnChild() {
      var childsRoot = this.xmlDoc.getElementsByTagName('animations')[0];
      var childs = childsRoot.getElementsByTagName('animation');
      for (var k = 0; k < childs.length; k++) {
        if (childs[k].getAttribute("id") == this.animationId) {
          this.animationNode = childs[k];
          break;
        }
      }
      this._nextESheepStep();
    }

    // Parse the human readable expression from XML to a computer readable expression

  }, {
    key: "_parseKeyWords",
    value: function _parseKeyWords(value) {
      value = value.replace(/screenW/g, this.screenW);
      value = value.replace(/screenH/g, this.screenH);
      value = value.replace(/areaW/g, this.screenH);
      value = value.replace(/areaH/g, this.screenH);
      value = value.replace(/imageW/g, this.imageW);
      value = value.replace(/imageH/g, this.imageH);
      value = value.replace(/random/g, Math.random() * 100);
      value = value.replace(/randS/g, this.randS);
      value = value.replace(/imageX/g, this.imageX);
      value = value.replace(/imageY/g, this.imageY);

      var ret = 0;
      try {
        ret = eval(value);
      } catch (err) {
        console.error("Unable to parse this position: \n'" + value + "'\n Error message: \n" + err.message);
      }
      return ret;
    }

    /*
     * Once the animation is over, get the next animation to play
     */

  }, {
    key: "_getNextRandomNode",
    value: function _getNextRandomNode(parentNode) {
      var baseNode = parentNode.getElementsByTagName('next');
      var childsRoot = this.xmlDoc.getElementsByTagName('animations')[0];
      var childs = childsRoot.getElementsByTagName('animation');
      var prob = 0;
      var nodeFound = false;

      // no more animations (it was the last one)
      if (baseNode.length == 0) {
        // If it is a child, remove the child from document
        if (this.isChild) {
          // remove child
          if (ACTIVATE_DEBUG) console.log("Remove child");
          document.body.removeChild(this.DOMinfo);
          document.body.removeChild(this.DOMdiv);
          delete this;
        }
        // else, spawn sheep again
        else {
            this._spawnESheep();
          }
        return false;
      }

      for (var k = 0; k < baseNode.length; k++) {
        prob += parseInt(baseNode[k].getAttribute("probability"));
      }
      var rand = Math.random() * prob;
      var index = 0;
      prob = 0;
      for (k = 0; k < baseNode.length; k++) {
        prob += parseInt(baseNode[k].getAttribute("probability"));
        if (prob >= rand) {
          index = k;
          break;
        }
      }
      for (k = 0; k < childs.length; k++) {
        if (childs[k].getAttribute("id") == baseNode[index].textContent) {
          this.animationId = childs[k].getAttribute("id");
          this.animationStep = 0;
          this.animationNode = childs[k];
          nodeFound = true;
          break;
        }
      }

      if (nodeFound) // create Child, if present
        {
          var childsRoot = this.xmlDoc.getElementsByTagName('childs')[0];
          var childs = childsRoot.getElementsByTagName('child');
          for (k = 0; k < childs.length; k++) {
            if (childs[k].getAttribute("animationid") == this.animationId) {
              if (ACTIVATE_DEBUG) console.log("Child from Animation");
              var eSheepChild = new eSheep(null, true);
              eSheepChild.animationId = childs[k].getElementsByTagName('next')[0].textContent;
              var x = childs[k].getElementsByTagName('x')[0].textContent; //
              var y = childs[k].getElementsByTagName('y')[0].textContent;
              eSheepChild._setPosition(this._parseKeyWords(x), this._parseKeyWords(y), true);
              eSheepChild.Start(this.animationFile);
              break;
            }
          }
        }

      return nodeFound;
    }

    /*
     * Check if sheep is walking over a defined HTML TAG-element
     */

  }, {
    key: "_checkOverlapping",
    value: function _checkOverlapping() {
      var x = this.imageX;
      var y = this.imageY + this.imageH;
      var rect;
      var margin = 20;
      if (this.HTMLelement) margin = 5;
      for (var index in COLLISION_WITH) {
        var els = document.body.getElementsByTagName(COLLISION_WITH[index]);

        for (var i = 0; i < els.length; i++) {
          rect = els[i].getBoundingClientRect();

          if (y > rect.top - 2 && y < rect.top + margin) {
            if (x > rect.left && x < rect.right - this.imageW) {
              var style = window.getComputedStyle(els[i]);
              if (style.borderTopStyle != "" && style.borderTopStyle != "none" && style.display != "none") {
                return els[i];
              }
            }
          }
        }
      }
      return false;
    }

    /*
     * Try to get the value of a node (from the current animationNode), if it is not possible returns the defaultValue
     */

  }, {
    key: "_getNodeValue",
    value: function _getNodeValue(nodeName, valueName, defaultValue) {
      if (!this.animationNode || !this.animationNode.getElementsByTagName(nodeName)) return;
      if (this.animationNode.getElementsByTagName(nodeName)[0].getElementsByTagName(valueName)[0]) {
        var value = this.animationNode.getElementsByTagName(nodeName)[0].getElementsByTagName(valueName)[0].textContent;

        return this._parseKeyWords(value);
      } else {
        return defaultValue;
      }
    }

    /*
     * Next step (each frame is a step)
     */

  }, {
    key: "_nextESheepStep",
    value: function _nextESheepStep() {
      if (this.prepareToDie) return;

      var x1 = this._getNodeValue('start', 'x', 0);
      var y1 = this._getNodeValue('start', 'y', 0);
      var off1 = this._getNodeValue('start', 'offsety', 0);
      var opa1 = this._getNodeValue('start', 'opacity', 1);
      var del1 = this._getNodeValue('start', 'interval', 1000);
      var x2 = this._getNodeValue('end', 'x', 0);
      var y2 = this._getNodeValue('end', 'y', 0);
      var off2 = this._getNodeValue('end', 'offsety', 0);
      var opa2 = this._getNodeValue('end', 'interval', 1);
      var del2 = this._getNodeValue('end', 'interval', 1000);

      var repeat = this._parseKeyWords(this.animationNode.getElementsByTagName('sequence')[0].getAttribute('repeat'));
      var repeatfrom = this.animationNode.getElementsByTagName('sequence')[0].getAttribute('repeatfrom');
      var gravity = this.animationNode.getElementsByTagName('gravity');
      var border = this.animationNode.getElementsByTagName('border');

      var steps = this.animationNode.getElementsByTagName('frame').length + (this.animationNode.getElementsByTagName('frame').length - repeatfrom) * repeat;

      var index;

      if (this.animationStep < this.animationNode.getElementsByTagName('frame').length) index = this.animationNode.getElementsByTagName('frame')[this.animationStep].textContent;else if (repeatfrom == 0) index = this.animationNode.getElementsByTagName('frame')[this.animationStep % this.animationNode.getElementsByTagName('frame').length].textContent;else index = this.animationNode.getElementsByTagName('frame')[parseInt(repeatfrom) + parseInt((this.animationStep - repeatfrom) % (this.animationNode.getElementsByTagName('frame').length - repeatfrom))].textContent;

      this.DOMimg.style.left = -this.imageW * (index % this.tilesX) + "px";
      this.DOMimg.style.top = -this.imageH * parseInt(index / this.tilesX) + "px";

      if (this.dragging || this.infobox) {
        this.animationStep++;
        setTimeout(this._nextESheepStep.bind(this), 50);
        return;
      }

      if (this.flipped) {
        x1 = -x1;
        x2 = -x2;
      }

      if (this.animationStep == 0) this._setPosition(x1, y1, false);else this._setPosition(parseInt(x1) + parseInt((x2 - x1) * this.animationStep / steps), parseInt(y1) + parseInt((y2 - y1) * this.animationStep / steps), false);

      this.animationStep++;

      if (this.animationStep >= steps) {
        if (this.animationNode.getElementsByTagName('action')[0]) {
          switch (this.animationNode.getElementsByTagName('action')[0].textContent) {
            case "flip":
              if (this.DOMdiv.style.transform == "rotateY(0deg)") {
                this.DOMdiv.style.transform = "rotateY(180deg)";
                this.flipped = true;
              } else {
                this.DOMdiv.style.transform = "rotateY(0deg)";
                this.flipped = false;
              }
              break;
            default:

              break;
          }
        }
        if (!this._getNextRandomNode(this.animationNode.getElementsByTagName('sequence')[0])) return;
      }

      var setNext = false;

      if (border && border[0] && border[0].getElementsByTagName('next')) {
        if (x2 < 0 && this.imageX < 0) {
          this.imageX = 0;
          setNext = true;
        } else if (x2 > 0 && this.imageX > this.screenW - this.imageW) {
          this.imageX = this.screenW - this.imageW;
          this.DOMdiv.style.left = parseInt(this.imageX) + "px";
          setNext = true;
        } else if (y2 < 0 && this.imageY < 0) {
          this.imageY = 0;
          setNext = true;
        } else if (y2 > 0 && this.imageY > this.screenH - this.imageH) {
          this.imageY = this.screenH - this.imageH;
          setNext = true;
        } else if (y2 > 0) {
          if (this._checkOverlapping()) {
            if (this.imageY > this.imageH) {
              this.HTMLelement = this._checkOverlapping();
              this.imageY = Math.ceil(this.HTMLelement.getBoundingClientRect().top) - this.imageH;
              setNext = true;
            }
          }
        } else if (this.HTMLelement) {
          if (!this._checkOverlapping()) {
            if (this.imageY + this.imageH > this.HTMLelement.getBoundingClientRect().top + 3 || this.imageY + this.imageH < this.HTMLelement.getBoundingClientRect().top - 3) {
              this.HTMLelement = null;
            } else if (this.imageX < this.HTMLelement.getBoundingClientRect().left) {
              this.imageX = parseInt(this.imageX + 3);
              setNext = true;
            } else {
              this.imageX = parseInt(this.imageX - 3);
              setNext = true;
            }
            this.DOMdiv.style.left = parseInt(this.imageX) + "px";
          }
        }
        if (setNext) {
          if (!this._getNextRandomNode(border[0])) return;
        }
      }
      if (!setNext && gravity && gravity[0] && gravity[0].getElementsByTagName('next')) {
        if (this.imageY < this.screenH - this.imageH - 2) {
          if (this.HTMLelement == null) {
            setNext = true;
          } else {
            if (!this._checkOverlapping()) {
              setNext = true;
              this.HTMLelement = null;
            }
          }

          if (setNext) {
            if (!this._getNextRandomNode(gravity[0])) return;
          }
        }
      }
      if (!setNext) {
        if (this.imageX < -this.imageW && x2 < 0 || this.imageX > this.screenW && x2 > 0 || this.imageY < -this.imageH && y1 < 0 || this.imageY > this.screenH && y2 > 0) {
          setNext = true;
          if (!this.isChild) {
            this._spawnESheep();
          }
          return;
        }
      }

      setTimeout(this._nextESheepStep.bind(this), parseInt(del1) + parseInt((del2 - del1) * this.animationStep / steps));
    }

    /*
     * Load Pet List from GitHub, so user can change it
     */

  }, {
    key: "_loadPetList",
    value: function _loadPetList(element) {
      var _this3 = this;

      fetch("https://adrianotiger.github.io/web-esheep/pets/pets.json", {
        credentials: 'same-origin',
        cache: "force-cache"
      }).then(function (response) {
        return response.json();
      }).then(function (json) {
        console.log(json);
        if (json.pets) {
          element.addEventListener("mouseup", function (e) {
            e.preventDefault();
            e.stopPropagation();

            var div = document.createElement("div");
            div.setAttribute("style", "position:absolute;left:0px;top:20px;width:183px;height:100%;min-height:80px;background:linear-gradient(to bottom, #8080ff, #3030a1);color:yellow;");
            element.parentNode.appendChild(div);

            var _loop = function _loop(k) {
              pet = document.createElement("b");

              pet.setAttribute("style", "cursor:pointer;display:block;");
              pet.appendChild(document.createTextNode(json.pets[k].name));
              pet.addEventListener("click", function () {
                var x = new eSheep(_this3.userOptions);
                x.Start("https://adrianotiger.github.io/web-esheep/pets/" + json.pets[k].file);
                _this3.remove();
              });
              div.appendChild(pet);
            };

            for (var k in json.pets) {
              var pet;

              _loop(k);
            }

            div.addEventListener("click", function (e) {
              element.parentNode.removeChild(div);
            });
          });
        }
      });
    }
  }]);

  return eSheep;
}();

;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJlc2hlZXAubWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG52YXIgX2NyZWF0ZUNsYXNzID0gZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKFwidmFsdWVcIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSgpO1xuXG5mdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoXCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb25cIik7IH0gfVxuXG4vKlxyXG4gKiBQcm9qZWN0OlxyXG4gKiAgICAgICAgICAgICAgICBlU2hlZXAgLSBXZWJwYWdlXHJcbiAqXHJcbiAqIERhdGU6XHJcbiAqICAgICAgICAgICAgICAgIDA0LmFwcmlsIDIwMThcclxuICpcclxuICogQXV0aG9yOlxyXG4gKiAgICAgICAgICAgICAgICBBZHJpYW5vIFBldHJ1Y2NpIChodHRwOi8vZXNoZWVwLnBldHJ1Y2NpLmNoKVxyXG4gKlxyXG4gKiBWZXJzaW9uOiAgICAgICAwLjkuMFxyXG4gKlxyXG4gKiBJbnRyb2R1Y3Rpb246XHJcbiAqICAgICAgICAgICAgICAgIEFzIFwid3JhcHBlclwiIGZvciB0aGUgT3BlblNvdXJjZSBDIyBwcm9qZWN0XHJcbiAqICAgICAgICAgICAgICAgIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL0Fkcmlhbm90aWdlci9kZXNrdG9wUGV0KSxcclxuICogICAgICAgICAgICAgICAgdGhpcyBqYXZhc2NyaXB0IFwiY2xhc3NcIiB3YXMgd3JpdHRlbiB0byBnZXQgdGhlIGFuaW1hdGlvbnMgYWxzbyBpbnNpZGUgeW91clxyXG4gKiAgICAgICAgICAgICAgICB3ZWJwYWdlLiBJdCBkb2Vzbid0IHdvcmsgbGlrZSB0aGUgV2luZG93cyB2ZXJzaW9uLCBidXQgc2hvdyBtdWNoIGFuaW1hdGlvbnMgZnJvbSBpdC5cclxuICpcclxuICogRGVzY3JpcHRpb246XHJcbiAqICAgICAgICAgICAgICAgIEFkZCBhIHdhbGtpbmcgcGV0IChzaGVlcCB0byB5b3VyIGhvbWUgcGFnZSkgd2l0aCBqdXN0IGEgZmV3IGxpbmVzIG9mIGNvZGUhXHJcbiAqICAgICAgICAgICAgICAgIFdpbGwgYWRkIGEgbG92ZWx5IHNoZWVwIChzdHJheSBzaGVlcCkgYW5kIHRoaXMgd2lsbCB3YWxrIGFyb3VuZCB5b3VyIHBhZ2UgYW5kIG92ZXJcclxuICogICAgICAgICAgICAgICAgYWxsIDxocj5zIGFuZCA8ZGl2PnMgd2l0aCBhIGJvcmRlci4gWW91IGNhbiBhbHNvIHNlbGVjdCBhbm90aGVyIGFuaW1hdGlvbiwgdXNpbmcgeW91clxyXG4gKiAgICAgICAgICAgICAgICBwZXJzb25hbCBYTUwgZmlsZSBvciBvbmUgZnJvbSB0aGUgZGF0YWJhc2UuXHJcbiAqXHJcbiAqIEhvdyB0byB1c2U6XHJcbiAqICAgICAgICAgICAgICAgIEFkZCB0aGlzIGxpbmUgaW4geW91ciA8aGVhZGVyPjpcclxuICogICAgICAgICAgICAgICAgPHNjcmlwdCBzcmM9XCJodHRwczovL2Fkcmlhbm90aWdlci5naXRodWIuaW8vd2ViLWVzaGVlcC9zcmMvZXNoZWVwLmpzXCI+PC9zY3JpcHQ+XHJcbiAqICAgICAgICAgICAgICAgIEFkZCB0aGlzIGxpbmVzIGluIHlvdXIgPGJvZHk+IChhdCB0aGUgZW5kIGlmIHBvc3NpYmxlKTpcclxuICogICAgICAgICAgICAgICAgPHNjcmlwdD5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgcGV0ID0gbmV3IGVTaGVlcCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBldC5TdGFydCgpO1xyXG4gICAgICAgICAgICAgICAgICA8L3NjcmlwdD5cclxuICogICAgICAgICAgICAgICAgVGhhdCdzIGFsbCFcclxuICpcclxuICogUmVxdWlyZW1lbnQ6XHJcbiAqICAgICAgICAgICAgICAgIFRlc3RlZCBvbiBJRTExLCBFZGdlIGFuZCBPcGVyYVxyXG4gKlxyXG4gKiBDaGFuZ2Vsb2c6XHJcbiAqICAgICAgICAgICAgICAgIFZlcnNpb24gMC45LjAgLSAxMS4wNy4yMDE5OlxyXG4gKiAgICAgICAgICAgICAgICAgIC0gVXBkYXRlZCBhbmltYXRpb24gbGluayB0byB0aGUgbWFpbiBwcm9qZWN0IGFuaW1hdGlvblxyXG4gKiAgICAgICAgICAgICAgICAgIC0gUmVjb21waWxlZCB3aXRoIG5ldyBZYXJuIHZlcnNpb24gKHNlY3VyaXR5IHZ1bG5lcmFiaWxpdHkpXHJcbiAqICAgICAgICAgICAgICAgIFZlcnNpb24gMC44LjAgLSAyOS4wNS4yMDE4OlxyXG4gKiAgICAgICAgICAgICAgICAgIC0gTW92ZWQgYW5pbWF0aW9uIGZpbGVzIHRvIGdpdGh1YlxyXG4gKiAgICAgICAgICAgICAgICAgIC0gQWRkZWQgb3B0aW9ucyB0byB0aGUgc2NyaXB0IFxyXG4gKiAgICAgICAgICAgICAgICAgIC0gTG9hZCBhbiBhbmltYXRpb24gZnJvbSB0aGUgR2l0SHViIGFuaW1hdGlvbnMgZnJvbSB0aGUgcG9wdXAgd2luZG93XHJcbiAqICAgICAgICAgICAgICAgIFZlcnNpb24gMC43LjEgLSAwNC4wNC4yMDE4OlxyXG4gKiAgICAgICAgICAgICAgICAgIC0gQWRkIG1heC13aWR0aDogbm9uZSB0byBlbnN1cmUgdGhlIGltYWdlIGlzIHByb3Blcmx5IHNob3duXHJcbiAqICAgICAgICAgICAgICAgIFZlcnNpb24gMC43IC0gMTMuMTEuMjAxNzpcclxuICogICAgICAgICAgICAgICAgICAtIGJldHRlciBKYXZhc2NyaXB0IHN0cnVjdHVyZVxyXG4gKiAgICAgICAgICAgICAgICAgIC0gR2l0SHViIHZlcnNpb24gKGh0dHBzOi8vZ2l0aHViLmNvbS9BZHJpYW5vdGlnZXIvd2ViLWVzaGVlcClcclxuICogICAgICAgICAgICAgICAgICAtIENoaWxkcyBhbmltYXRpb25zIGFkZGVkXHJcbiAqICAgICAgICAgICAgICAgICAgLSBCZXR0ZXIgY29tbWVudHNcclxuICogICAgICAgICAgICAgICAgICAtIFJlcGxhY2VkIGFsZXJ0cyB3aXRoIGNvbnNvbGUuZXJyb3JcclxuICogICAgICAgICAgICAgICAgVmVyc2lvbiAwLjUgLSAxMi4wNy4yMDE3OlxyXG4gKiAgICAgICAgICAgICAgICAgIC0gYW5pbWF0aW9ucyBzdGFydHMgb25seSBvbmNlIHRoZSBpbWFnZSB3YXMgbG9hZGVkICh0aGFua3MgUmVkU3BhcnIwdylcclxuICogICAgICAgICAgICAgICAgVmVyc2lvbiAwLng6XHJcbiAqICAgICAgICAgICAgICAgICAgLSBzdGlsbCBiZXRhIHZlcnNpb25zLi4uXHJcbiAqL1xuXG52YXIgVkVSU0lPTiA9ICcwLjguMCc7IC8vIHdlYiBlU2hlZXAgdmVyc2lvblxudmFyIEFDVElWQVRFX0RFQlVHID0gZmFsc2U7IC8vIHNob3cgbG9nIG9uIGNvbnNvbGVcbnZhciBERUZBVUxUX1hNTCA9IFwiaHR0cHM6Ly9hZHJpYW5vdGlnZXIuZ2l0aHViLmlvL2Rlc2t0b3BQZXQvUGV0cy9lc2hlZXA2NC9hbmltYXRpb25zLnhtbFwiOyAvLyBkZWZhdWx0IFhNTCBhbmltYXRpb25cbnZhciBDT0xMSVNJT05fV0lUSCA9IFtcImRpdlwiLCBcImhyXCJdOyAvLyBlbGVtZW50cyBvbiBwYWdlIHRvIGRldGVjdCBmb3IgY29sbGlzaW9uc1xuXG4vKlxyXG4gKiBlU2hlZXAgY2xhc3MuXHJcbiAqIENyZWF0ZSBhIG5ldyBjbGFzcyBvZiB0aGlzIHR5cGUgaWYgeW91IHdhbnQgYSBuZXcgcGV0LiBXaWxsIGNyZWF0ZSB0aGUgY29tcG9uZW50cyBmb3IgdGhlIHBldC5cclxuICogT25jZSBjcmVhdGVkLCB5b3UgY2FuIGNhbGwgW3ZhcmlhYmxlTmFtZV0uU3RhcnQoKSB0byBzdGFydCB0aGUgYW5pbWF0aW9uIHdpdGggeW91ciBkZXNpcmVkIHBldC5cclxuICovXG5cbnZhciBlU2hlZXAgPSBmdW5jdGlvbiAoKSB7XG4gIC8qIFBhcmFtZXRlcnMgZm9yIG9wdGlvbnMgW2RlZmF1bHRdOlxyXG4gICAqIC0gYWxsb3dQZXRzOiBbbm9uZV0sIGFsbFxyXG4gICAqIC0gYWxsb3dQb3B1cDogW3llc10sIG5vXHJcbiAgICovXG4gIGZ1bmN0aW9uIGVTaGVlcChvcHRpb25zLCBpc0NoaWxkKSB7XG4gICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIGVTaGVlcCk7XG5cbiAgICB0aGlzLnVzZXJPcHRpb25zID0gb3B0aW9ucyA/IG9wdGlvbnMgOiB7IGFsbG93UGV0czogXCJub25lXCIsIGFsbG93UG9wdXA6IFwieWVzXCIgfTtcbiAgICBpZiAoIXRoaXMudXNlck9wdGlvbnMuYWxsb3dQb3B1cCkgdGhpcy51c2VyT3B0aW9ucy5hbGxvd1BvcHVwID0gXCJ5ZXNcIjtcbiAgICBpZiAoIXRoaXMudXNlck9wdGlvbnMuYWxsb3dQZXRzKSB0aGlzLnVzZXJPcHRpb25zLmFsbG93UGV0cyA9IFwibm9uZVwiO1xuXG4gICAgLy8gQ09SUzogQ3Jvc3MgY2FsbHMgYXJlIG5vdCBhY2NlcHRlZCBieSBuZXcgYnJvd3NlcnMuXG4gICAgdGhpcy5hbmltYXRpb25GaWxlID0gREVGQVVMVF9YTUw7XG5cbiAgICB0aGlzLmlkID0gRGF0ZS5ub3coKSArIE1hdGgucmFuZG9tKCk7XG5cbiAgICB0aGlzLkRPTWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7IC8vIERpdiBhZGRlZCB0byB3ZWJwYWdlLCBjb250YWluaW5nIHRoZSBzaGVlcFxuICAgIHRoaXMuRE9NZGl2LnNldEF0dHJpYnV0ZShcImlkXCIsIHRoaXMuaWQpO1xuICAgIHRoaXMuRE9NaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImltZ1wiKTsgLy8gVGlsZSBpbWFnZSwgd2lsbCBiZSBwb3NpdGlvbmVkIGluc2lkZSB0aGUgZGl2XG4gICAgdGhpcy5ET01pbmZvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTsgLy8gYWJvdXQgZGlhbG9nLCBpZiB5b3UgcHJlc3Mgb24gdGhlIHNoZWVwXG5cbiAgICB0aGlzLnBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsgLy8gWE1MIHBhcnNlclxuICAgIHRoaXMueG1sRG9jID0gbnVsbDsgLy8gcGFyc2VkIFhNTCBEb2N1bWVudFxuICAgIHRoaXMucHJlcGFyZVRvRGllID0gZmFsc2U7IC8vIHdoZW4gcmVtb3ZlZCwgYW5pbWF0aW9ucyBzaG91bGQgYmUgc3RvcHBlZFxuXG4gICAgdGhpcy5pc0NoaWxkID0gaXNDaGlsZCAhPSBudWxsOyAvLyBDaGlsZCB3aWxsIGJlIHJlbW92ZWQgb25jZSB0aGV5IHJlYWNoZWQgdGhlIGVuZFxuXG4gICAgdGhpcy50aWxlc1ggPSAxOyAvLyBRdWFudGl0eSBvZiBpbWFnZXMgaW5zaWRlIFRpbGVcbiAgICB0aGlzLnRpbGVzWSA9IDE7IC8vIFF1YW50aXR5IG9mIGltYWdlcyBpbnNpZGUgVGlsZVxuICAgIHRoaXMuaW1hZ2VXID0gMTsgLy8gV2lkdGggb2YgdGhlIHNwcml0ZSBpbWFnZVxuICAgIHRoaXMuaW1hZ2VIID0gMTsgLy8gSGVpZ2h0IG9mIHRoZSBzcHJpdGUgaW1hZ2VcbiAgICB0aGlzLmltYWdlWCA9IDE7IC8vIFBvc2l0aW9uIG9mIHNwcml0ZSBpbnNpZGUgd2VicGFnZVxuICAgIHRoaXMuaW1hZ2VZID0gMTsgLy8gUG9zaXRpb24gb2Ygc3ByaXRlIGluc2lkZSB3ZWJwYWdlXG4gICAgdGhpcy5mbGlwcGVkID0gZmFsc2U7IC8vIGlmIHNwcml0ZSBpcyBmbGlwcGVkXG4gICAgdGhpcy5kcmFnZ2luZyA9IGZhbHNlOyAvLyBpZiB1c2VyIGlzIGRyYWdnaW5nIHRoZSBzaGVlcFxuICAgIHRoaXMuaW5mb2JveCA9IGZhbHNlOyAvLyBpZiBpbmZvYm94IGlzIHZpc2libGVcbiAgICB0aGlzLmFuaW1hdGlvbklkID0gMDsgLy8gY3VycmVudCBhbmltYXRpb24gSURcbiAgICB0aGlzLmFuaW1hdGlvblN0ZXAgPSAwOyAvLyBjdXJyZW50IGFuaW1hdGlvbiBzdGVwXG4gICAgdGhpcy5hbmltYXRpb25Ob2RlID0gbnVsbDsgLy8gY3VycmVudCBhbmltYXRpb24gRE9NIG5vZGVcbiAgICB0aGlzLnNwcml0ZSA9IG5ldyBJbWFnZSgpOyAvLyBzcHJpdGUgaW1hZ2UgKFRpbGVzKVxuICAgIHRoaXMuSFRNTGVsZW1lbnQgPSBudWxsOyAvLyB0aGUgSFRNTCBlbGVtZW50IHdoZXJlIHRoZSBwZXQgaXMgd2Fsa2luZyBvblxuICAgIHRoaXMucmFuZFMgPSBNYXRoLnJhbmRvbSgpICogMTAwOyAvLyByYW5kb20gdmFsdWUsIHdpbGwgY2hhbmdlIHdoZW4gcGFnZSBpcyByZWxvYWRlZFxuXG4gICAgdGhpcy5zY3JlZW5XID0gd2luZG93LmlubmVyV2lkdGggfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoIHx8IGRvY3VtZW50LmJvZHkuY2xpZW50V2lkdGg7IC8vIHdpbmRvdyB3aWR0aFxuXG4gICAgdGhpcy5zY3JlZW5IID0gd2luZG93LmlubmVySGVpZ2h0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQgfHwgZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQ7IC8vIHdpbmRvdyBoZWlnaHRcbiAgfVxuXG4gIC8qXHJcbiAgICogU3RhcnQgbmV3IGFuaW1hdGlvbiBvbiB0aGUgcGFnZS5cclxuICAgKiBpZiBhbmltYXRpb24gaXMgbm90IHNldCwgdGhlIGRlZmF1bHQgc2hlZXAgd2lsbCBiZSB0YWtlblxyXG4gICAqL1xuXG5cbiAgX2NyZWF0ZUNsYXNzKGVTaGVlcCwgW3tcbiAgICBrZXk6IFwiU3RhcnRcIixcbiAgICB2YWx1ZTogZnVuY3Rpb24gU3RhcnQoYW5pbWF0aW9uKSB7XG4gICAgICBpZiAodHlwZW9mIGFuaW1hdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgYW5pbWF0aW9uICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5hbmltYXRpb25GaWxlID0gYW5pbWF0aW9uO1xuICAgICAgfVxuXG4gICAgICB2YXIgYWpheCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgdmFyIHNoZWVwQ2xhc3MgPSB0aGlzO1xuXG4gICAgICBhamF4Lm9wZW4oXCJHRVRcIiwgdGhpcy5hbmltYXRpb25GaWxlLCB0cnVlKTtcbiAgICAgIGFqYXguYWRkRXZlbnRMaXN0ZW5lcihcInJlYWR5c3RhdGVjaGFuZ2VcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09IDQpIHtcbiAgICAgICAgICBpZiAodGhpcy5zdGF0dXMgPT0gMjAwKVxuICAgICAgICAgICAgLy8gc3VjY2Vzc2Z1bGx5IGxvYWRlZCBYTUwsIHBhcnNlIGl0IGFuZCBjcmVhdGUgZmlyc3QgZXNoZWVwLlxuICAgICAgICAgICAgc2hlZXBDbGFzcy5fcGFyc2VYTUwodGhpcy5yZXNwb25zZVRleHQpO2Vsc2UgY29uc29sZS5lcnJvcihcIlhNTCBub3QgYXZhaWxhYmxlOlwiICsgdGhpcy5zdGF0dXNUZXh0ICsgXCJcXG5cIiArIHRoaXMucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBhamF4LnNlbmQobnVsbCk7XG4gICAgfVxuICB9LCB7XG4gICAga2V5OiBcInJlbW92ZVwiLFxuICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmUoKSB7XG4gICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuXG4gICAgICB0aGlzLnByZXBhcmVUb0RpZSA9IHRydWU7XG4gICAgICB0aGlzLkRPTWluZm8uSGlkZSgpO1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIF90aGlzLkRPTWRpdiA9IF90aGlzLkRPTWltZyA9IF90aGlzLkRPTWluZm8gPSBudWxsO1xuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChfdGhpcy5pZCkub3V0ZXJIVE1MID0gJyc7XG4gICAgICB9LCA1MDApO1xuICAgIH1cblxuICAgIC8qXHJcbiAgICAgKiBQYXJzZSBsb2FkZWQgWE1MLCBjb250YWlucyBzcGF3biwgYW5pbWF0aW9ucyBhbmQgY2hpbGRzXHJcbiAgICAgKi9cblxuICB9LCB7XG4gICAga2V5OiBcIl9wYXJzZVhNTFwiLFxuICAgIHZhbHVlOiBmdW5jdGlvbiBfcGFyc2VYTUwodGV4dCkge1xuICAgICAgdmFyIF90aGlzMiA9IHRoaXM7XG5cbiAgICAgIHRoaXMueG1sRG9jID0gdGhpcy5wYXJzZXIucGFyc2VGcm9tU3RyaW5nKHRleHQsICd0ZXh0L3htbCcpO1xuICAgICAgdmFyIGltYWdlID0gdGhpcy54bWxEb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ltYWdlJylbMF07XG4gICAgICB0aGlzLnRpbGVzWCA9IGltYWdlLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwidGlsZXN4XCIpWzBdLnRleHRDb250ZW50O1xuICAgICAgdGhpcy50aWxlc1kgPSBpbWFnZS5nZXRFbGVtZW50c0J5VGFnTmFtZShcInRpbGVzeVwiKVswXS50ZXh0Q29udGVudDtcbiAgICAgIC8vIEV2ZW50IGxpc3RlbmVyOiBTcHJpdGUgd2FzIGxvYWRlZCA9PlxuICAgICAgLy8gICBwbGF5IGFuaW1hdGlvbiBvbmx5IHdoZW4gdGhlIHNwcml0ZSBpcyBsb2FkZWRcbiAgICAgIHRoaXMuc3ByaXRlLmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKEFDVElWQVRFX0RFQlVHKSBjb25zb2xlLmxvZyhcIlNwcml0ZSBpbWFnZSBsb2FkZWRcIik7XG4gICAgICAgIHZhciBhdHRyaWJ1dGUgPSBcIndpZHRoOlwiICsgX3RoaXMyLnNwcml0ZS53aWR0aCArIFwicHg7XCIgKyBcImhlaWdodDpcIiArIF90aGlzMi5zcHJpdGUuaGVpZ2h0ICsgXCJweDtcIiArIFwicG9zaXRpb246YWJzb2x1dGU7XCIgKyBcInRvcDowcHg7XCIgKyBcImxlZnQ6MHB4O1wiICsgXCJtYXgtd2lkdGg6IG5vbmU7XCI7XG4gICAgICAgIF90aGlzMi5ET01pbWcuc2V0QXR0cmlidXRlKFwic3R5bGVcIiwgYXR0cmlidXRlKTtcbiAgICAgICAgLy8gcHJldmVudCB0byBtb3ZlIGltYWdlICh3aWxsIHNob3cgdGhlIGVudGlyZSBzcHJpdGUgc2hlZXQgaWYgbm90IGNhdGNoZWQpXG4gICAgICAgIF90aGlzMi5ET01pbWcuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdzdGFydFwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtyZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgICAgICBfdGhpczIuaW1hZ2VXID0gX3RoaXMyLnNwcml0ZS53aWR0aCAvIF90aGlzMi50aWxlc1g7XG4gICAgICAgIF90aGlzMi5pbWFnZUggPSBfdGhpczIuc3ByaXRlLmhlaWdodCAvIF90aGlzMi50aWxlc1k7XG4gICAgICAgIGF0dHJpYnV0ZSA9IFwid2lkdGg6XCIgKyBfdGhpczIuaW1hZ2VXICsgXCJweDtcIiArIFwiaGVpZ2h0OlwiICsgX3RoaXMyLmltYWdlSCArIFwicHg7XCIgKyBcInBvc2l0aW9uOmZpeGVkO1wiICsgXCJ0b3A6XCIgKyBfdGhpczIuaW1hZ2VZICsgXCJweDtcIiArIFwibGVmdDpcIiArIF90aGlzMi5pbWFnZVggKyBcInB4O1wiICsgXCJ0cmFuc2Zvcm06cm90YXRleSgwZGVnKTtcIiArIFwiY3Vyc29yOm1vdmU7XCIgKyBcInotaW5kZXg6MjAwMDtcIiArIFwib3ZlcmZsb3c6aGlkZGVuO1wiO1xuICAgICAgICBfdGhpczIuRE9NZGl2LnNldEF0dHJpYnV0ZShcInN0eWxlXCIsIGF0dHJpYnV0ZSk7XG4gICAgICAgIF90aGlzMi5ET01kaXYuYXBwZW5kQ2hpbGQoX3RoaXMyLkRPTWltZyk7XG5cbiAgICAgICAgaWYgKF90aGlzMi5pc0NoaWxkKSBfdGhpczIuX3NwYXduQ2hpbGQoKTtlbHNlIF90aGlzMi5fc3Bhd25FU2hlZXAoKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnNwcml0ZS5zcmMgPSAnZGF0YTppbWFnZS9wbmc7YmFzZTY0LCcgKyBpbWFnZS5nZXRFbGVtZW50c0J5VGFnTmFtZShcInBuZ1wiKVswXS50ZXh0Q29udGVudDtcbiAgICAgIHRoaXMuRE9NaW1nLnNldEF0dHJpYnV0ZShcInNyY1wiLCB0aGlzLnNwcml0ZS5zcmMpO1xuXG4gICAgICAvLyBNb3VzZSBtb3ZlIG92ZXIgZVNoZWVwLCBjaGVjayBpZiBlU2hlZXAgc2hvdWxkIGJlIG1vdmVkIG92ZXIgdGhlIHNjcmVlblxuICAgICAgdGhpcy5ET01kaXYuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBpZiAoIV90aGlzMi5kcmFnZ2luZyAmJiBlLmJ1dHRvbnMgPT0gMSAmJiBlLmJ1dHRvbiA9PSAwKSB7XG4gICAgICAgICAgX3RoaXMyLmRyYWdnaW5nID0gdHJ1ZTtcbiAgICAgICAgICBfdGhpczIuSFRNTGVsZW1lbnQgPSBudWxsO1xuICAgICAgICAgIHZhciBjaGlsZHNSb290ID0gX3RoaXMyLnhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYW5pbWF0aW9ucycpWzBdO1xuICAgICAgICAgIHZhciBjaGlsZHMgPSBjaGlsZHNSb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhbmltYXRpb24nKTtcbiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IGNoaWxkcy5sZW5ndGg7IGsrKykge1xuICAgICAgICAgICAgaWYgKGNoaWxkc1trXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbmFtZScpWzBdLnRleHRDb250ZW50ID09IFwiZHJhZ1wiKSB7XG4gICAgICAgICAgICAgIF90aGlzMi5hbmltYXRpb25JZCA9IGNoaWxkc1trXS5nZXRBdHRyaWJ1dGUoXCJpZFwiKTtcbiAgICAgICAgICAgICAgX3RoaXMyLmFuaW1hdGlvblN0ZXAgPSAwO1xuICAgICAgICAgICAgICBfdGhpczIuYW5pbWF0aW9uTm9kZSA9IGNoaWxkc1trXTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIC8vIEFkZCBldmVudCBsaXN0ZW5lciB0byBib2R5LCBpZiBtb3VzZSBtb3ZlZCB0b28gZmFzdCBvdmVyIHRoZSBkcmFnZ2luZyBlU2hlZXBcbiAgICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBpZiAoX3RoaXMyLmRyYWdnaW5nKSB7XG4gICAgICAgICAgX3RoaXMyLmltYWdlWCA9IHBhcnNlSW50KGUuY2xpZW50WCkgLSBfdGhpczIuaW1hZ2VXIC8gMjtcbiAgICAgICAgICBfdGhpczIuaW1hZ2VZID0gcGFyc2VJbnQoZS5jbGllbnRZKSAtIF90aGlzMi5pbWFnZUggLyAyO1xuXG4gICAgICAgICAgX3RoaXMyLkRPTWRpdi5zdHlsZS5sZWZ0ID0gX3RoaXMyLmltYWdlWCArIFwicHhcIjtcbiAgICAgICAgICBfdGhpczIuRE9NZGl2LnN0eWxlLnRvcCA9IF90aGlzMi5pbWFnZVkgKyBcInB4XCI7XG4gICAgICAgICAgX3RoaXMyLkRPTWluZm8uc3R5bGUubGVmdCA9IHBhcnNlSW50KF90aGlzMi5pbWFnZVggKyBfdGhpczIuaW1hZ2VXIC8gMikgKyBcInB4XCI7XG4gICAgICAgICAgX3RoaXMyLkRPTWluZm8uc3R5bGUudG9wID0gX3RoaXMyLmltYWdlWSArIFwicHhcIjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICAvLyBXaW5kb3cgcmVzaXplZCwgcmVjYWxjdWxhdGUgZVNoZWVwIGJvdW5kc1xuICAgICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKFwicmVzaXplXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgX3RoaXMyLnNjcmVlblcgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGggfHwgZG9jdW1lbnQuYm9keS5jbGllbnRXaWR0aDtcblxuICAgICAgICBfdGhpczIuc2NyZWVuSCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0IHx8IGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0O1xuXG4gICAgICAgIGlmIChfdGhpczIuaW1hZ2VZICsgX3RoaXMyLmltYWdlSCA+IF90aGlzMi5zY3JlZW5IKSB7XG4gICAgICAgICAgX3RoaXMyLmltYWdlWSA9IF90aGlzMi5zY3JlZW5IIC0gX3RoaXMyLmltYWdlSDtcbiAgICAgICAgICBfdGhpczIuRE9NZGl2LnN0eWxlLnRvcCA9IF90aGlzMi5pbWFnZVkgKyBcInB4XCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF90aGlzMi5pbWFnZVggKyBfdGhpczIuaW1hZ2VXID4gX3RoaXMyLnNjcmVlblcpIHtcbiAgICAgICAgICBfdGhpczIuaW1hZ2VYID0gX3RoaXMyLnNjcmVlblcgLSBfdGhpczIuaW1hZ2VXO1xuICAgICAgICAgIF90aGlzMi5ET01kaXYuc3R5bGUubGVmdCA9IF90aGlzMi5pbWFnZVggKyBcInB4XCI7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgLy8gRG9uJ3QgYWxsb3cgY29udGV4dG1lbnUgb3ZlciB0aGUgc2hlZXBcbiAgICAgIHRoaXMuRE9NZGl2LmFkZEV2ZW50TGlzdGVuZXIoXCJjb250ZXh0bWVudVwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0pO1xuICAgICAgLy8gTW91c2UgcmVsZWFzZWRcbiAgICAgIHRoaXMuRE9NZGl2LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZXVwXCIsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgIGlmIChfdGhpczIuZHJhZ2dpbmcpIHtcbiAgICAgICAgICBfdGhpczIuZHJhZ2dpbmcgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIGlmIChfdGhpczIuaW5mb2JveCkge1xuICAgICAgICAgIF90aGlzMi5ET01pbmZvLkhpZGUoKTtcbiAgICAgICAgICBfdGhpczIuaW5mb2JveCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChfdGhpczIudXNlck9wdGlvbnMuYWxsb3dQb3B1cCA9PT0gXCJ5ZXNcIikge1xuICAgICAgICAgICAgX3RoaXMyLkRPTWluZm8uc3R5bGUubGVmdCA9IE1hdGgubWluKF90aGlzMi5zY3JlZW5XIC0gX3RoaXMyLmltYWdlVywgTWF0aC5tYXgoX3RoaXMyLmltYWdlVywgcGFyc2VJbnQoX3RoaXMyLmltYWdlWCArIF90aGlzMi5pbWFnZVcgLyAyKSkpICsgXCJweFwiO1xuICAgICAgICAgICAgX3RoaXMyLkRPTWluZm8uc3R5bGUudG9wID0gcGFyc2VJbnQoX3RoaXMyLmltYWdlWSkgKyBcInB4XCI7XG4gICAgICAgICAgICBfdGhpczIuRE9NaW5mby5TaG93KCk7XG4gICAgICAgICAgICBfdGhpczIuaW5mb2JveCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIC8vIE1vdXNlIHJlbGVhc2VkIG92ZXIgdGhlIGluZm8gYm94XG4gICAgICB0aGlzLkRPTWluZm8uYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgX3RoaXMyLkRPTWluZm8uSGlkZSgpO1xuICAgICAgICBfdGhpczIuaW5mb2JveCA9IGZhbHNlO1xuICAgICAgfSk7XG4gICAgICAvLyBDcmVhdGUgQWJvdXQgYm94XG4gICAgICB2YXIgYXR0cmlidXRlID0gXCJ3aWR0aDoyMDBweDtcIiArIFwiaGVpZ2h0OjEwMHB4O1wiICsgXCJ0cmFuc2Zvcm06dHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKDAuMSk7XCIgKyBcInBvc2l0aW9uOmZpeGVkO1wiICsgXCJ0b3A6MTAwcHg7bGVmdDoxMHB4O1wiICsgXCJkaXNwbGF5Om5vbmU7XCIgKyBcImJvcmRlci13aWR0aDoycHg7XCIgKyBcImJvcmRlci1yYWRpdXM6NXB4O1wiICsgXCJib3JkZXItc3R5bGU6cmlkZ2U7XCIgKyBcImJvcmRlci1jb2xvcjojMDAwMGFiO1wiICsgXCJ0ZXh0LWFsaWduOmNlbnRlcjtcIiArIFwidGV4dC1zaGFkb3c6IDFweCAxcHggM3B4ICNmZmZmODg7XCIgKyBcImJveC1zaGFkb3c6IDNweCAzcHggMTBweCAjODg4ODg4O1wiICsgXCJjb2xvcjpibGFjaztcIiArIFwib3BhY2l0eTowLjk7XCIgKyBcInotaW5kZXg6OTk5OTtcIiArIFwib3ZlcmZsb3c6YXV0bztcIiArIFwidHJhbnNpdGlvbjp0cmFuc2Zvcm0gMC4zcyBlYXNlO1wiICsgXCJiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tIHJpZ2h0LCByZ2JhKDEyOCwxMjgsMjU1LDAuNyksIHJnYmEoMjAwLDIwMCwyNTUsMC40KSk7XCI7XG4gICAgICB0aGlzLkRPTWluZm8uc2V0QXR0cmlidXRlKFwic3R5bGVcIiwgYXR0cmlidXRlKTtcbiAgICAgIHZhciBoZWFkZXJOb2RlID0gdGhpcy54bWxEb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWRlcicpWzBdO1xuICAgICAgdmFyIGh0bWxUID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJcIikuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoaGVhZGVyTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGl0bGUnKVswXS50ZXh0Q29udGVudCkpO1xuICAgICAgdmFyIGh0bWxWID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInN1cFwiKTtcbiAgICAgIHZhciBodG1sTCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhXCIpO1xuICAgICAgdmFyIGh0bWxQID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInBcIik7XG4gICAgICBodG1sVi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShcIkFwcCB2LlwiICsgVkVSU0lPTikpO1xuICAgICAgaHRtbFYuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJyXCIpKTtcbiAgICAgIGh0bWxWLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFwiUGV0IHYuXCIgKyBoZWFkZXJOb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd2ZXJzaW9uJylbMF0udGV4dENvbnRlbnQpKTtcbiAgICAgIGh0bWxWLnNldEF0dHJpYnV0ZShcInN0eWxlXCIsIFwiZmxvYXQ6cmlnaHQ7dGV4dC1hbGlnbjpyaWdodDtcIik7XG4gICAgICBodG1sTC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShcIlxcdUQ4M0NcXHVERkUwXCIpKTtcbiAgICAgIGh0bWxMLnNldEF0dHJpYnV0ZShcImhyZWZcIiwgXCJodHRwczovL2dpdGh1Yi5jb20vQWRyaWFub3RpZ2VyL3dlYi1lc2hlZXBcIik7XG4gICAgICBodG1sTC5zZXRBdHRyaWJ1dGUoXCJ0YXJnZXRcIiwgXCJfYmxhbmtcIik7XG4gICAgICBodG1sTC5zZXRBdHRyaWJ1dGUoXCJzdHlsZVwiLCBcImZsb2F0OmxlZnRcIik7XG4gICAgICBodG1sUC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShoZWFkZXJOb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbmZvJylbMF0udGV4dENvbnRlbnQpKTtcbiAgICAgIGh0bWxQLnNldEF0dHJpYnV0ZShcInN0eWxlXCIsIFwiZm9udC1zaXplOlwiICsgKDEwMCAtIHBhcnNlSW50KGhlYWRlck5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2luZm8nKVswXS50ZXh0Q29udGVudC5sZW5ndGggLyAxMCkpICsgXCIlO1wiKTtcbiAgICAgIHRoaXMuRE9NaW5mby5hcHBlbmRDaGlsZChodG1sVik7XG4gICAgICB0aGlzLkRPTWluZm8uYXBwZW5kQ2hpbGQoaHRtbEwpO1xuICAgICAgaWYgKHRoaXMudXNlck9wdGlvbnMuYWxsb3dQZXRzICE9PSBcIm5vbmVcIikge1xuICAgICAgICBodG1sTCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhXCIpO1xuICAgICAgICBodG1sTC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShcIlxcdTI2OTlcIikpO1xuICAgICAgICBodG1sTC5zZXRBdHRyaWJ1dGUoXCJocmVmXCIsIFwiamF2YXNjcmlwdDo7XCIpO1xuICAgICAgICBodG1sTC5zZXRBdHRyaWJ1dGUoXCJzdHlsZVwiLCBcImZsb2F0OmxlZnRcIik7XG4gICAgICAgIHRoaXMuRE9NaW5mby5hcHBlbmRDaGlsZChodG1sTCk7XG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIF90aGlzMi5fbG9hZFBldExpc3QoaHRtbEwpO1xuICAgICAgICB9LCAxMDApO1xuICAgICAgfVxuICAgICAgdGhpcy5ET01pbmZvLmFwcGVuZENoaWxkKGh0bWxUKTtcbiAgICAgIHRoaXMuRE9NaW5mby5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnJcIikpO1xuICAgICAgdGhpcy5ET01pbmZvLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJoclwiKSk7XG4gICAgICB0aGlzLkRPTWluZm8uYXBwZW5kQ2hpbGQoaHRtbFApO1xuICAgICAgLy8gQWRkIGFib3V0IGFuZCBzaGVlcCBlbGVtZW50cyB0byB0aGUgYm9keVxuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLkRPTWluZm8pO1xuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLkRPTWRpdik7XG5cbiAgICAgIHRoaXMuRE9NaW5mby5TaG93ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBfdGhpczIuRE9NaW5mby5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xuICAgICAgICBfdGhpczIuRE9NaW5mby5zdHlsZS50cmFuc2Zvcm0gPSBcInRyYW5zbGF0ZSgtNTAlLCAtMTAwJSkgc2NhbGUoMS4wKVwiO1xuICAgICAgfTtcbiAgICAgIHRoaXMuRE9NaW5mby5IaWRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBfdGhpczIuRE9NaW5mby5zdHlsZS50cmFuc2Zvcm0gPSBcInRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwLjEpXCI7XG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIF90aGlzMi5ET01pbmZvLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICAgICAgfSwgMzAwKTtcbiAgICAgIH07XG4gICAgfVxuICB9LCB7XG4gICAga2V5OiBcIl9zZXRQb3NpdGlvblwiLFxuXG5cbiAgICAvKlxyXG4gICAgICogU2V0IG5ldyBwb3NpdGlvbiBmb3IgdGhlIHBldFxyXG4gICAgICogSWYgYWJzb2x1dGUgaXMgdHJ1ZSwgdGhlIHggYW5kIHkgY29vcmRpbmF0ZXMgYXJlIHVzZWQgYXMgYWJzb2x1dGUgdmFsdWVzLlxyXG4gICAgICogSWYgZmFsc2UsIHggYW5kIHkgYXJlIGFkZGVkIHRvIHRoZSBjdXJyZW50IHBvc2l0aW9uXHJcbiAgICAgKi9cbiAgICB2YWx1ZTogZnVuY3Rpb24gX3NldFBvc2l0aW9uKHgsIHksIGFic29sdXRlKSB7XG4gICAgICBpZiAodGhpcy5ET01kaXYpIHtcbiAgICAgICAgaWYgKGFic29sdXRlKSB7XG4gICAgICAgICAgdGhpcy5pbWFnZVggPSBwYXJzZUludCh4KTtcbiAgICAgICAgICB0aGlzLmltYWdlWSA9IHBhcnNlSW50KHkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuaW1hZ2VYID0gcGFyc2VJbnQodGhpcy5pbWFnZVgpICsgcGFyc2VJbnQoeCk7XG4gICAgICAgICAgdGhpcy5pbWFnZVkgPSBwYXJzZUludCh0aGlzLmltYWdlWSkgKyBwYXJzZUludCh5KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLkRPTWRpdi5zdHlsZS5sZWZ0ID0gdGhpcy5pbWFnZVggKyBcInB4XCI7XG4gICAgICAgIHRoaXMuRE9NZGl2LnN0eWxlLnRvcCA9IHRoaXMuaW1hZ2VZICsgXCJweFwiO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8qXHJcbiAgICAgKiBTcGF3biBuZXcgZXNoZWVwLCB0aGlzIGlzIGNhbGxlZCBpZiB0aGUgWE1MIHdhcyBsb2FkZWQgc3VjY2Vzc2Z1bGx5XHJcbiAgICAgKi9cblxuICB9LCB7XG4gICAga2V5OiBcIl9zcGF3bkVTaGVlcFwiLFxuICAgIHZhbHVlOiBmdW5jdGlvbiBfc3Bhd25FU2hlZXAoKSB7XG4gICAgICB2YXIgc3Bhd25zUm9vdCA9IHRoaXMueG1sRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzcGF3bnMnKVswXTtcbiAgICAgIHZhciBzcGF3bnMgPSBzcGF3bnNSb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzcGF3bicpO1xuICAgICAgdmFyIHByb2IgPSAwO1xuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGF3bnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcHJvYiArPSBwYXJzZUludChzcGF3bnNbMF0uZ2V0QXR0cmlidXRlKFwicHJvYmFiaWxpdHlcIikpO1xuICAgICAgfXZhciByYW5kID0gTWF0aC5yYW5kb20oKSAqIHByb2I7XG4gICAgICBwcm9iID0gMDtcbiAgICAgIGZvciAoaSA9IDA7IGkgPCBzcGF3bnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcHJvYiArPSBwYXJzZUludChzcGF3bnNbaV0uZ2V0QXR0cmlidXRlKFwicHJvYmFiaWxpdHlcIikpO1xuICAgICAgICBpZiAocHJvYiA+PSByYW5kIHx8IGkgPT0gc3Bhd25zLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICB0aGlzLl9zZXRQb3NpdGlvbih0aGlzLl9wYXJzZUtleVdvcmRzKHNwYXduc1tpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgneCcpWzBdLnRleHRDb250ZW50KSwgdGhpcy5fcGFyc2VLZXlXb3JkcyhzcGF3bnNbaV0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3knKVswXS50ZXh0Q29udGVudCksIHRydWUpO1xuICAgICAgICAgIGlmIChBQ1RJVkFURV9ERUJVRykgY29uc29sZS5sb2coXCJTcGF3bjogXCIgKyB0aGlzLmltYWdlWCArIFwiLCBcIiArIHRoaXMuaW1hZ2VZKTtcbiAgICAgICAgICB0aGlzLmFuaW1hdGlvbklkID0gc3Bhd25zW2ldLmdldEVsZW1lbnRzQnlUYWdOYW1lKCduZXh0JylbMF0udGV4dENvbnRlbnQ7XG4gICAgICAgICAgdGhpcy5hbmltYXRpb25TdGVwID0gMDtcbiAgICAgICAgICB2YXIgY2hpbGRzUm9vdCA9IHRoaXMueG1sRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhbmltYXRpb25zJylbMF07XG4gICAgICAgICAgdmFyIGNoaWxkcyA9IGNoaWxkc1Jvb3QuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2FuaW1hdGlvbicpO1xuICAgICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgY2hpbGRzLmxlbmd0aDsgaysrKSB7XG4gICAgICAgICAgICBpZiAoY2hpbGRzW2tdLmdldEF0dHJpYnV0ZShcImlkXCIpID09IHRoaXMuYW5pbWF0aW9uSWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5hbmltYXRpb25Ob2RlID0gY2hpbGRzW2tdO1xuXG4gICAgICAgICAgICAgIC8vIENoZWNrIGlmIGNoaWxkIHNob3VsZCBiZSBsb2FkZWQgdG9naGV0aGVyIHdpdGggdGhpcyBhbmltYXRpb25cbiAgICAgICAgICAgICAgdmFyIGNoaWxkc1Jvb3QgPSB0aGlzLnhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnY2hpbGRzJylbMF07XG4gICAgICAgICAgICAgIHZhciBjaGlsZHMgPSBjaGlsZHNSb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdjaGlsZCcpO1xuICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGNoaWxkcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgIGlmIChjaGlsZHNbal0uZ2V0QXR0cmlidXRlKFwiYW5pbWF0aW9uaWRcIikgPT0gdGhpcy5hbmltYXRpb25JZCkge1xuICAgICAgICAgICAgICAgICAgaWYgKEFDVElWQVRFX0RFQlVHKSBjb25zb2xlLmxvZyhcIkNoaWxkIGZyb20gU3Bhd25cIik7XG4gICAgICAgICAgICAgICAgICB2YXIgZVNoZWVwQ2hpbGQgPSBuZXcgZVNoZWVwKG51bGwsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgZVNoZWVwQ2hpbGQuYW5pbWF0aW9uSWQgPSBjaGlsZHNbal0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ25leHQnKVswXS50ZXh0Q29udGVudDtcbiAgICAgICAgICAgICAgICAgIHZhciB4ID0gY2hpbGRzW2pdLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd4JylbMF0udGV4dENvbnRlbnQ7IC8vXG4gICAgICAgICAgICAgICAgICB2YXIgeSA9IGNoaWxkc1tqXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgneScpWzBdLnRleHRDb250ZW50O1xuICAgICAgICAgICAgICAgICAgZVNoZWVwQ2hpbGQuX3NldFBvc2l0aW9uKHRoaXMuX3BhcnNlS2V5V29yZHMoeCksIHRoaXMuX3BhcnNlS2V5V29yZHMoeSksIHRydWUpO1xuICAgICAgICAgICAgICAgICAgLy8gU3RhcnQgYW5pbWF0aW9uXG4gICAgICAgICAgICAgICAgICBlU2hlZXBDaGlsZC5TdGFydCh0aGlzLmFuaW1hdGlvbkZpbGUpO1xuICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gUGxheSBuZXh0IHN0ZXBcbiAgICAgIHRoaXMuX25leHRFU2hlZXBTdGVwKCk7XG4gICAgfVxuXG4gICAgLypcclxuICAgICAqIExpa2Ugc3Bhd25FU2hlZXAsIGJ1dCBmb3IgQ2hpbGRzXHJcbiAgICAgKi9cblxuICB9LCB7XG4gICAga2V5OiBcIl9zcGF3bkNoaWxkXCIsXG4gICAgdmFsdWU6IGZ1bmN0aW9uIF9zcGF3bkNoaWxkKCkge1xuICAgICAgdmFyIGNoaWxkc1Jvb3QgPSB0aGlzLnhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYW5pbWF0aW9ucycpWzBdO1xuICAgICAgdmFyIGNoaWxkcyA9IGNoaWxkc1Jvb3QuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2FuaW1hdGlvbicpO1xuICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBjaGlsZHMubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgaWYgKGNoaWxkc1trXS5nZXRBdHRyaWJ1dGUoXCJpZFwiKSA9PSB0aGlzLmFuaW1hdGlvbklkKSB7XG4gICAgICAgICAgdGhpcy5hbmltYXRpb25Ob2RlID0gY2hpbGRzW2tdO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLl9uZXh0RVNoZWVwU3RlcCgpO1xuICAgIH1cblxuICAgIC8vIFBhcnNlIHRoZSBodW1hbiByZWFkYWJsZSBleHByZXNzaW9uIGZyb20gWE1MIHRvIGEgY29tcHV0ZXIgcmVhZGFibGUgZXhwcmVzc2lvblxuXG4gIH0sIHtcbiAgICBrZXk6IFwiX3BhcnNlS2V5V29yZHNcIixcbiAgICB2YWx1ZTogZnVuY3Rpb24gX3BhcnNlS2V5V29yZHModmFsdWUpIHtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvc2NyZWVuVy9nLCB0aGlzLnNjcmVlblcpO1xuICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9zY3JlZW5IL2csIHRoaXMuc2NyZWVuSCk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL2FyZWFXL2csIHRoaXMuc2NyZWVuSCk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL2FyZWFIL2csIHRoaXMuc2NyZWVuSCk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL2ltYWdlVy9nLCB0aGlzLmltYWdlVyk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL2ltYWdlSC9nLCB0aGlzLmltYWdlSCk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL3JhbmRvbS9nLCBNYXRoLnJhbmRvbSgpICogMTAwKTtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvcmFuZFMvZywgdGhpcy5yYW5kUyk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL2ltYWdlWC9nLCB0aGlzLmltYWdlWCk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL2ltYWdlWS9nLCB0aGlzLmltYWdlWSk7XG5cbiAgICAgIHZhciByZXQgPSAwO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0ID0gZXZhbCh2YWx1ZSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIlVuYWJsZSB0byBwYXJzZSB0aGlzIHBvc2l0aW9uOiBcXG4nXCIgKyB2YWx1ZSArIFwiJ1xcbiBFcnJvciBtZXNzYWdlOiBcXG5cIiArIGVyci5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG4gICAgLypcclxuICAgICAqIE9uY2UgdGhlIGFuaW1hdGlvbiBpcyBvdmVyLCBnZXQgdGhlIG5leHQgYW5pbWF0aW9uIHRvIHBsYXlcclxuICAgICAqL1xuXG4gIH0sIHtcbiAgICBrZXk6IFwiX2dldE5leHRSYW5kb21Ob2RlXCIsXG4gICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXROZXh0UmFuZG9tTm9kZShwYXJlbnROb2RlKSB7XG4gICAgICB2YXIgYmFzZU5vZGUgPSBwYXJlbnROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCduZXh0Jyk7XG4gICAgICB2YXIgY2hpbGRzUm9vdCA9IHRoaXMueG1sRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhbmltYXRpb25zJylbMF07XG4gICAgICB2YXIgY2hpbGRzID0gY2hpbGRzUm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYW5pbWF0aW9uJyk7XG4gICAgICB2YXIgcHJvYiA9IDA7XG4gICAgICB2YXIgbm9kZUZvdW5kID0gZmFsc2U7XG5cbiAgICAgIC8vIG5vIG1vcmUgYW5pbWF0aW9ucyAoaXQgd2FzIHRoZSBsYXN0IG9uZSlcbiAgICAgIGlmIChiYXNlTm9kZS5sZW5ndGggPT0gMCkge1xuICAgICAgICAvLyBJZiBpdCBpcyBhIGNoaWxkLCByZW1vdmUgdGhlIGNoaWxkIGZyb20gZG9jdW1lbnRcbiAgICAgICAgaWYgKHRoaXMuaXNDaGlsZCkge1xuICAgICAgICAgIC8vIHJlbW92ZSBjaGlsZFxuICAgICAgICAgIGlmIChBQ1RJVkFURV9ERUJVRykgY29uc29sZS5sb2coXCJSZW1vdmUgY2hpbGRcIik7XG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLkRPTWluZm8pO1xuICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5ET01kaXYpO1xuICAgICAgICAgIGRlbGV0ZSB0aGlzO1xuICAgICAgICB9XG4gICAgICAgIC8vIGVsc2UsIHNwYXduIHNoZWVwIGFnYWluXG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fc3Bhd25FU2hlZXAoKTtcbiAgICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBiYXNlTm9kZS5sZW5ndGg7IGsrKykge1xuICAgICAgICBwcm9iICs9IHBhcnNlSW50KGJhc2VOb2RlW2tdLmdldEF0dHJpYnV0ZShcInByb2JhYmlsaXR5XCIpKTtcbiAgICAgIH1cbiAgICAgIHZhciByYW5kID0gTWF0aC5yYW5kb20oKSAqIHByb2I7XG4gICAgICB2YXIgaW5kZXggPSAwO1xuICAgICAgcHJvYiA9IDA7XG4gICAgICBmb3IgKGsgPSAwOyBrIDwgYmFzZU5vZGUubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgcHJvYiArPSBwYXJzZUludChiYXNlTm9kZVtrXS5nZXRBdHRyaWJ1dGUoXCJwcm9iYWJpbGl0eVwiKSk7XG4gICAgICAgIGlmIChwcm9iID49IHJhbmQpIHtcbiAgICAgICAgICBpbmRleCA9IGs7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGZvciAoayA9IDA7IGsgPCBjaGlsZHMubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgaWYgKGNoaWxkc1trXS5nZXRBdHRyaWJ1dGUoXCJpZFwiKSA9PSBiYXNlTm9kZVtpbmRleF0udGV4dENvbnRlbnQpIHtcbiAgICAgICAgICB0aGlzLmFuaW1hdGlvbklkID0gY2hpbGRzW2tdLmdldEF0dHJpYnV0ZShcImlkXCIpO1xuICAgICAgICAgIHRoaXMuYW5pbWF0aW9uU3RlcCA9IDA7XG4gICAgICAgICAgdGhpcy5hbmltYXRpb25Ob2RlID0gY2hpbGRzW2tdO1xuICAgICAgICAgIG5vZGVGb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKG5vZGVGb3VuZCkgLy8gY3JlYXRlIENoaWxkLCBpZiBwcmVzZW50XG4gICAgICAgIHtcbiAgICAgICAgICB2YXIgY2hpbGRzUm9vdCA9IHRoaXMueG1sRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdjaGlsZHMnKVswXTtcbiAgICAgICAgICB2YXIgY2hpbGRzID0gY2hpbGRzUm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnY2hpbGQnKTtcbiAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgY2hpbGRzLmxlbmd0aDsgaysrKSB7XG4gICAgICAgICAgICBpZiAoY2hpbGRzW2tdLmdldEF0dHJpYnV0ZShcImFuaW1hdGlvbmlkXCIpID09IHRoaXMuYW5pbWF0aW9uSWQpIHtcbiAgICAgICAgICAgICAgaWYgKEFDVElWQVRFX0RFQlVHKSBjb25zb2xlLmxvZyhcIkNoaWxkIGZyb20gQW5pbWF0aW9uXCIpO1xuICAgICAgICAgICAgICB2YXIgZVNoZWVwQ2hpbGQgPSBuZXcgZVNoZWVwKG51bGwsIHRydWUpO1xuICAgICAgICAgICAgICBlU2hlZXBDaGlsZC5hbmltYXRpb25JZCA9IGNoaWxkc1trXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbmV4dCcpWzBdLnRleHRDb250ZW50O1xuICAgICAgICAgICAgICB2YXIgeCA9IGNoaWxkc1trXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgneCcpWzBdLnRleHRDb250ZW50OyAvL1xuICAgICAgICAgICAgICB2YXIgeSA9IGNoaWxkc1trXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgneScpWzBdLnRleHRDb250ZW50O1xuICAgICAgICAgICAgICBlU2hlZXBDaGlsZC5fc2V0UG9zaXRpb24odGhpcy5fcGFyc2VLZXlXb3Jkcyh4KSwgdGhpcy5fcGFyc2VLZXlXb3Jkcyh5KSwgdHJ1ZSk7XG4gICAgICAgICAgICAgIGVTaGVlcENoaWxkLlN0YXJ0KHRoaXMuYW5pbWF0aW9uRmlsZSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICByZXR1cm4gbm9kZUZvdW5kO1xuICAgIH1cblxuICAgIC8qXHJcbiAgICAgKiBDaGVjayBpZiBzaGVlcCBpcyB3YWxraW5nIG92ZXIgYSBkZWZpbmVkIEhUTUwgVEFHLWVsZW1lbnRcclxuICAgICAqL1xuXG4gIH0sIHtcbiAgICBrZXk6IFwiX2NoZWNrT3ZlcmxhcHBpbmdcIixcbiAgICB2YWx1ZTogZnVuY3Rpb24gX2NoZWNrT3ZlcmxhcHBpbmcoKSB7XG4gICAgICB2YXIgeCA9IHRoaXMuaW1hZ2VYO1xuICAgICAgdmFyIHkgPSB0aGlzLmltYWdlWSArIHRoaXMuaW1hZ2VIO1xuICAgICAgdmFyIHJlY3Q7XG4gICAgICB2YXIgbWFyZ2luID0gMjA7XG4gICAgICBpZiAodGhpcy5IVE1MZWxlbWVudCkgbWFyZ2luID0gNTtcbiAgICAgIGZvciAodmFyIGluZGV4IGluIENPTExJU0lPTl9XSVRIKSB7XG4gICAgICAgIHZhciBlbHMgPSBkb2N1bWVudC5ib2R5LmdldEVsZW1lbnRzQnlUYWdOYW1lKENPTExJU0lPTl9XSVRIW2luZGV4XSk7XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICByZWN0ID0gZWxzW2ldLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuXG4gICAgICAgICAgaWYgKHkgPiByZWN0LnRvcCAtIDIgJiYgeSA8IHJlY3QudG9wICsgbWFyZ2luKSB7XG4gICAgICAgICAgICBpZiAoeCA+IHJlY3QubGVmdCAmJiB4IDwgcmVjdC5yaWdodCAtIHRoaXMuaW1hZ2VXKSB7XG4gICAgICAgICAgICAgIHZhciBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsc1tpXSk7XG4gICAgICAgICAgICAgIGlmIChzdHlsZS5ib3JkZXJUb3BTdHlsZSAhPSBcIlwiICYmIHN0eWxlLmJvcmRlclRvcFN0eWxlICE9IFwibm9uZVwiICYmIHN0eWxlLmRpc3BsYXkgIT0gXCJub25lXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZWxzW2ldO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLypcclxuICAgICAqIFRyeSB0byBnZXQgdGhlIHZhbHVlIG9mIGEgbm9kZSAoZnJvbSB0aGUgY3VycmVudCBhbmltYXRpb25Ob2RlKSwgaWYgaXQgaXMgbm90IHBvc3NpYmxlIHJldHVybnMgdGhlIGRlZmF1bHRWYWx1ZVxyXG4gICAgICovXG5cbiAgfSwge1xuICAgIGtleTogXCJfZ2V0Tm9kZVZhbHVlXCIsXG4gICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXROb2RlVmFsdWUobm9kZU5hbWUsIHZhbHVlTmFtZSwgZGVmYXVsdFZhbHVlKSB7XG4gICAgICBpZiAoIXRoaXMuYW5pbWF0aW9uTm9kZSB8fCAhdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKG5vZGVOYW1lKSkgcmV0dXJuO1xuICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZShub2RlTmFtZSlbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUodmFsdWVOYW1lKVswXSkge1xuICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmFuaW1hdGlvbk5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUobm9kZU5hbWUpWzBdLmdldEVsZW1lbnRzQnlUYWdOYW1lKHZhbHVlTmFtZSlbMF0udGV4dENvbnRlbnQ7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlS2V5V29yZHModmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvKlxyXG4gICAgICogTmV4dCBzdGVwIChlYWNoIGZyYW1lIGlzIGEgc3RlcClcclxuICAgICAqL1xuXG4gIH0sIHtcbiAgICBrZXk6IFwiX25leHRFU2hlZXBTdGVwXCIsXG4gICAgdmFsdWU6IGZ1bmN0aW9uIF9uZXh0RVNoZWVwU3RlcCgpIHtcbiAgICAgIGlmICh0aGlzLnByZXBhcmVUb0RpZSkgcmV0dXJuO1xuXG4gICAgICB2YXIgeDEgPSB0aGlzLl9nZXROb2RlVmFsdWUoJ3N0YXJ0JywgJ3gnLCAwKTtcbiAgICAgIHZhciB5MSA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnc3RhcnQnLCAneScsIDApO1xuICAgICAgdmFyIG9mZjEgPSB0aGlzLl9nZXROb2RlVmFsdWUoJ3N0YXJ0JywgJ29mZnNldHknLCAwKTtcbiAgICAgIHZhciBvcGExID0gdGhpcy5fZ2V0Tm9kZVZhbHVlKCdzdGFydCcsICdvcGFjaXR5JywgMSk7XG4gICAgICB2YXIgZGVsMSA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnc3RhcnQnLCAnaW50ZXJ2YWwnLCAxMDAwKTtcbiAgICAgIHZhciB4MiA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnZW5kJywgJ3gnLCAwKTtcbiAgICAgIHZhciB5MiA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnZW5kJywgJ3knLCAwKTtcbiAgICAgIHZhciBvZmYyID0gdGhpcy5fZ2V0Tm9kZVZhbHVlKCdlbmQnLCAnb2Zmc2V0eScsIDApO1xuICAgICAgdmFyIG9wYTIgPSB0aGlzLl9nZXROb2RlVmFsdWUoJ2VuZCcsICdpbnRlcnZhbCcsIDEpO1xuICAgICAgdmFyIGRlbDIgPSB0aGlzLl9nZXROb2RlVmFsdWUoJ2VuZCcsICdpbnRlcnZhbCcsIDEwMDApO1xuXG4gICAgICB2YXIgcmVwZWF0ID0gdGhpcy5fcGFyc2VLZXlXb3Jkcyh0aGlzLmFuaW1hdGlvbk5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NlcXVlbmNlJylbMF0uZ2V0QXR0cmlidXRlKCdyZXBlYXQnKSk7XG4gICAgICB2YXIgcmVwZWF0ZnJvbSA9IHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2VxdWVuY2UnKVswXS5nZXRBdHRyaWJ1dGUoJ3JlcGVhdGZyb20nKTtcbiAgICAgIHZhciBncmF2aXR5ID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdncmF2aXR5Jyk7XG4gICAgICB2YXIgYm9yZGVyID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib3JkZXInKTtcblxuICAgICAgdmFyIHN0ZXBzID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmcmFtZScpLmxlbmd0aCArICh0aGlzLmFuaW1hdGlvbk5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ZyYW1lJykubGVuZ3RoIC0gcmVwZWF0ZnJvbSkgKiByZXBlYXQ7XG5cbiAgICAgIHZhciBpbmRleDtcblxuICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uU3RlcCA8IHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZnJhbWUnKS5sZW5ndGgpIGluZGV4ID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmcmFtZScpW3RoaXMuYW5pbWF0aW9uU3RlcF0udGV4dENvbnRlbnQ7ZWxzZSBpZiAocmVwZWF0ZnJvbSA9PSAwKSBpbmRleCA9IHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZnJhbWUnKVt0aGlzLmFuaW1hdGlvblN0ZXAgJSB0aGlzLmFuaW1hdGlvbk5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ZyYW1lJykubGVuZ3RoXS50ZXh0Q29udGVudDtlbHNlIGluZGV4ID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmcmFtZScpW3BhcnNlSW50KHJlcGVhdGZyb20pICsgcGFyc2VJbnQoKHRoaXMuYW5pbWF0aW9uU3RlcCAtIHJlcGVhdGZyb20pICUgKHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZnJhbWUnKS5sZW5ndGggLSByZXBlYXRmcm9tKSldLnRleHRDb250ZW50O1xuXG4gICAgICB0aGlzLkRPTWltZy5zdHlsZS5sZWZ0ID0gLXRoaXMuaW1hZ2VXICogKGluZGV4ICUgdGhpcy50aWxlc1gpICsgXCJweFwiO1xuICAgICAgdGhpcy5ET01pbWcuc3R5bGUudG9wID0gLXRoaXMuaW1hZ2VIICogcGFyc2VJbnQoaW5kZXggLyB0aGlzLnRpbGVzWCkgKyBcInB4XCI7XG5cbiAgICAgIGlmICh0aGlzLmRyYWdnaW5nIHx8IHRoaXMuaW5mb2JveCkge1xuICAgICAgICB0aGlzLmFuaW1hdGlvblN0ZXArKztcbiAgICAgICAgc2V0VGltZW91dCh0aGlzLl9uZXh0RVNoZWVwU3RlcC5iaW5kKHRoaXMpLCA1MCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuZmxpcHBlZCkge1xuICAgICAgICB4MSA9IC14MTtcbiAgICAgICAgeDIgPSAteDI7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmFuaW1hdGlvblN0ZXAgPT0gMCkgdGhpcy5fc2V0UG9zaXRpb24oeDEsIHkxLCBmYWxzZSk7ZWxzZSB0aGlzLl9zZXRQb3NpdGlvbihwYXJzZUludCh4MSkgKyBwYXJzZUludCgoeDIgLSB4MSkgKiB0aGlzLmFuaW1hdGlvblN0ZXAgLyBzdGVwcyksIHBhcnNlSW50KHkxKSArIHBhcnNlSW50KCh5MiAtIHkxKSAqIHRoaXMuYW5pbWF0aW9uU3RlcCAvIHN0ZXBzKSwgZmFsc2UpO1xuXG4gICAgICB0aGlzLmFuaW1hdGlvblN0ZXArKztcblxuICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uU3RlcCA+PSBzdGVwcykge1xuICAgICAgICBpZiAodGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhY3Rpb24nKVswXSkge1xuICAgICAgICAgIHN3aXRjaCAodGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhY3Rpb24nKVswXS50ZXh0Q29udGVudCkge1xuICAgICAgICAgICAgY2FzZSBcImZsaXBcIjpcbiAgICAgICAgICAgICAgaWYgKHRoaXMuRE9NZGl2LnN0eWxlLnRyYW5zZm9ybSA9PSBcInJvdGF0ZVkoMGRlZylcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuRE9NZGl2LnN0eWxlLnRyYW5zZm9ybSA9IFwicm90YXRlWSgxODBkZWcpXCI7XG4gICAgICAgICAgICAgICAgdGhpcy5mbGlwcGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLkRPTWRpdi5zdHlsZS50cmFuc2Zvcm0gPSBcInJvdGF0ZVkoMGRlZylcIjtcbiAgICAgICAgICAgICAgICB0aGlzLmZsaXBwZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG5cbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5fZ2V0TmV4dFJhbmRvbU5vZGUodGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzZXF1ZW5jZScpWzBdKSkgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB2YXIgc2V0TmV4dCA9IGZhbHNlO1xuXG4gICAgICBpZiAoYm9yZGVyICYmIGJvcmRlclswXSAmJiBib3JkZXJbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ25leHQnKSkge1xuICAgICAgICBpZiAoeDIgPCAwICYmIHRoaXMuaW1hZ2VYIDwgMCkge1xuICAgICAgICAgIHRoaXMuaW1hZ2VYID0gMDtcbiAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh4MiA+IDAgJiYgdGhpcy5pbWFnZVggPiB0aGlzLnNjcmVlblcgLSB0aGlzLmltYWdlVykge1xuICAgICAgICAgIHRoaXMuaW1hZ2VYID0gdGhpcy5zY3JlZW5XIC0gdGhpcy5pbWFnZVc7XG4gICAgICAgICAgdGhpcy5ET01kaXYuc3R5bGUubGVmdCA9IHBhcnNlSW50KHRoaXMuaW1hZ2VYKSArIFwicHhcIjtcbiAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh5MiA8IDAgJiYgdGhpcy5pbWFnZVkgPCAwKSB7XG4gICAgICAgICAgdGhpcy5pbWFnZVkgPSAwO1xuICAgICAgICAgIHNldE5leHQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHkyID4gMCAmJiB0aGlzLmltYWdlWSA+IHRoaXMuc2NyZWVuSCAtIHRoaXMuaW1hZ2VIKSB7XG4gICAgICAgICAgdGhpcy5pbWFnZVkgPSB0aGlzLnNjcmVlbkggLSB0aGlzLmltYWdlSDtcbiAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh5MiA+IDApIHtcbiAgICAgICAgICBpZiAodGhpcy5fY2hlY2tPdmVybGFwcGluZygpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pbWFnZVkgPiB0aGlzLmltYWdlSCkge1xuICAgICAgICAgICAgICB0aGlzLkhUTUxlbGVtZW50ID0gdGhpcy5fY2hlY2tPdmVybGFwcGluZygpO1xuICAgICAgICAgICAgICB0aGlzLmltYWdlWSA9IE1hdGguY2VpbCh0aGlzLkhUTUxlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCkgLSB0aGlzLmltYWdlSDtcbiAgICAgICAgICAgICAgc2V0TmV4dCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuSFRNTGVsZW1lbnQpIHtcbiAgICAgICAgICBpZiAoIXRoaXMuX2NoZWNrT3ZlcmxhcHBpbmcoKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuaW1hZ2VZICsgdGhpcy5pbWFnZUggPiB0aGlzLkhUTUxlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCArIDMgfHwgdGhpcy5pbWFnZVkgKyB0aGlzLmltYWdlSCA8IHRoaXMuSFRNTGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wIC0gMykge1xuICAgICAgICAgICAgICB0aGlzLkhUTUxlbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbWFnZVggPCB0aGlzLkhUTUxlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQpIHtcbiAgICAgICAgICAgICAgdGhpcy5pbWFnZVggPSBwYXJzZUludCh0aGlzLmltYWdlWCArIDMpO1xuICAgICAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMuaW1hZ2VYID0gcGFyc2VJbnQodGhpcy5pbWFnZVggLSAzKTtcbiAgICAgICAgICAgICAgc2V0TmV4dCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLkRPTWRpdi5zdHlsZS5sZWZ0ID0gcGFyc2VJbnQodGhpcy5pbWFnZVgpICsgXCJweFwiO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoc2V0TmV4dCkge1xuICAgICAgICAgIGlmICghdGhpcy5fZ2V0TmV4dFJhbmRvbU5vZGUoYm9yZGVyWzBdKSkgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIXNldE5leHQgJiYgZ3Jhdml0eSAmJiBncmF2aXR5WzBdICYmIGdyYXZpdHlbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ25leHQnKSkge1xuICAgICAgICBpZiAodGhpcy5pbWFnZVkgPCB0aGlzLnNjcmVlbkggLSB0aGlzLmltYWdlSCAtIDIpIHtcbiAgICAgICAgICBpZiAodGhpcy5IVE1MZWxlbWVudCA9PSBudWxsKSB7XG4gICAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCF0aGlzLl9jaGVja092ZXJsYXBwaW5nKCkpIHtcbiAgICAgICAgICAgICAgc2V0TmV4dCA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMuSFRNTGVsZW1lbnQgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChzZXROZXh0KSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX2dldE5leHRSYW5kb21Ob2RlKGdyYXZpdHlbMF0pKSByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIXNldE5leHQpIHtcbiAgICAgICAgaWYgKHRoaXMuaW1hZ2VYIDwgLXRoaXMuaW1hZ2VXICYmIHgyIDwgMCB8fCB0aGlzLmltYWdlWCA+IHRoaXMuc2NyZWVuVyAmJiB4MiA+IDAgfHwgdGhpcy5pbWFnZVkgPCAtdGhpcy5pbWFnZUggJiYgeTEgPCAwIHx8IHRoaXMuaW1hZ2VZID4gdGhpcy5zY3JlZW5IICYmIHkyID4gMCkge1xuICAgICAgICAgIHNldE5leHQgPSB0cnVlO1xuICAgICAgICAgIGlmICghdGhpcy5pc0NoaWxkKSB7XG4gICAgICAgICAgICB0aGlzLl9zcGF3bkVTaGVlcCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgc2V0VGltZW91dCh0aGlzLl9uZXh0RVNoZWVwU3RlcC5iaW5kKHRoaXMpLCBwYXJzZUludChkZWwxKSArIHBhcnNlSW50KChkZWwyIC0gZGVsMSkgKiB0aGlzLmFuaW1hdGlvblN0ZXAgLyBzdGVwcykpO1xuICAgIH1cblxuICAgIC8qXHJcbiAgICAgKiBMb2FkIFBldCBMaXN0IGZyb20gR2l0SHViLCBzbyB1c2VyIGNhbiBjaGFuZ2UgaXRcclxuICAgICAqL1xuXG4gIH0sIHtcbiAgICBrZXk6IFwiX2xvYWRQZXRMaXN0XCIsXG4gICAgdmFsdWU6IGZ1bmN0aW9uIF9sb2FkUGV0TGlzdChlbGVtZW50KSB7XG4gICAgICB2YXIgX3RoaXMzID0gdGhpcztcblxuICAgICAgZmV0Y2goXCJodHRwczovL2Fkcmlhbm90aWdlci5naXRodWIuaW8vd2ViLWVzaGVlcC9wZXRzL3BldHMuanNvblwiLCB7XG4gICAgICAgIGNyZWRlbnRpYWxzOiAnc2FtZS1vcmlnaW4nLFxuICAgICAgICBjYWNoZTogXCJmb3JjZS1jYWNoZVwiXG4gICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAoanNvbikge1xuICAgICAgICBjb25zb2xlLmxvZyhqc29uKTtcbiAgICAgICAgaWYgKGpzb24ucGV0cykge1xuICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgICAgICAgZGl2LnNldEF0dHJpYnV0ZShcInN0eWxlXCIsIFwicG9zaXRpb246YWJzb2x1dGU7bGVmdDowcHg7dG9wOjIwcHg7d2lkdGg6MTgzcHg7aGVpZ2h0OjEwMCU7bWluLWhlaWdodDo4MHB4O2JhY2tncm91bmQ6bGluZWFyLWdyYWRpZW50KHRvIGJvdHRvbSwgIzgwODBmZiwgIzMwMzBhMSk7Y29sb3I6eWVsbG93O1wiKTtcbiAgICAgICAgICAgIGVsZW1lbnQucGFyZW50Tm9kZS5hcHBlbmRDaGlsZChkaXYpO1xuXG4gICAgICAgICAgICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcChrKSB7XG4gICAgICAgICAgICAgIHBldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJiXCIpO1xuXG4gICAgICAgICAgICAgIHBldC5zZXRBdHRyaWJ1dGUoXCJzdHlsZVwiLCBcImN1cnNvcjpwb2ludGVyO2Rpc3BsYXk6YmxvY2s7XCIpO1xuICAgICAgICAgICAgICBwZXQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoanNvbi5wZXRzW2tdLm5hbWUpKTtcbiAgICAgICAgICAgICAgcGV0LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHggPSBuZXcgZVNoZWVwKF90aGlzMy51c2VyT3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgeC5TdGFydChcImh0dHBzOi8vYWRyaWFub3RpZ2VyLmdpdGh1Yi5pby93ZWItZXNoZWVwL3BldHMvXCIgKyBqc29uLnBldHNba10uZmlsZSk7XG4gICAgICAgICAgICAgICAgX3RoaXMzLnJlbW92ZSgpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHBldCk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBmb3IgKHZhciBrIGluIGpzb24ucGV0cykge1xuICAgICAgICAgICAgICB2YXIgcGV0O1xuXG4gICAgICAgICAgICAgIF9sb29wKGspO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgIGVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkaXYpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfV0pO1xuXG4gIHJldHVybiBlU2hlZXA7XG59KCk7XG5cbjsiXSwiZmlsZSI6ImVzaGVlcC5taW4uanMifQ==
