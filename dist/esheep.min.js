"use strict";

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

/*
 * Project:
 *                eSheep - Webpage
 *
 * Date:
 *                04.april 2018
 *
 * Author:
 *                Adriano Petrucci (http://esheep.petrucci.ch)
 *
 * Version:       0.9.0
 *
 * Introduction:
 *                As "wrapper" for the OpenSource C# project
 *                (see https://github.com/Adrianotiger/desktopPet),
 *                this javascript "class" was written to get the animations also inside your
 *                webpage. It doesn't work like the Windows version, but show much animations from it.
 *
 * Description:
 *                Add a walking pet (sheep to your home page) with just a few lines of code!
 *                Will add a lovely sheep (stray sheep) and this will walk around your page and over
 *                all <hr>s and <div>s with a border. You can also select another animation, using your
 *                personal XML file or one from the database.
 *
 * How to use:
 *                Add this line in your <header>:
 *                <script src="https://adrianotiger.github.io/web-esheep/src/esheep.js"></script>
 *                Add this lines in your <body> (at the end if possible):
 *                <script>
                    var pet = new eSheep();
                    pet.Start();
                  </script>
 *                That's all!
 *
 * Requirement:
 *                Tested on IE11, Edge and Opera
 *
 * Changelog:
 *                Version 0.9.0 - 11.07.2019:
 *                  - Updated animation link to the main project animation
 *                  - Recompiled with new Yarn version (security vulnerability)
 *                Version 0.8.0 - 29.05.2018:
 *                  - Moved animation files to github
 *                  - Added options to the script 
 *                  - Load an animation from the GitHub animations from the popup window
 *                Version 0.7.1 - 04.04.2018:
 *                  - Add max-width: none to ensure the image is properly shown
 *                Version 0.7 - 13.11.2017:
 *                  - better Javascript structure
 *                  - GitHub version (https://github.com/Adrianotiger/web-esheep)
 *                  - Childs animations added
 *                  - Better comments
 *                  - Replaced alerts with console.error
 *                Version 0.5 - 12.07.2017:
 *                  - animations starts only once the image was loaded (thanks RedSparr0w)
 *                Version 0.x:
 *                  - still beta versions...
 */
var VERSION = '0.9.1'; // web eSheep version

var ACTIVATE_DEBUG = false; // show log on console

var DEFAULT_XML = "https://adrianotiger.github.io/desktopPet/Pets/esheep64/animations.xml"; // default XML animation

var COLLISION_WITH = ["div", "hr"]; // elements on page to detect for collisions

/*
 * eSheep class.
 * Create a new class of this type if you want a new pet. Will create the components for the pet.
 * Once created, you can call [variableName].Start() to start the animation with your desired pet.
 */

var eSheep = /*#__PURE__*/function () {
  /* Parameters for options [default]:
   * - allowPets: [none], all
   * - allowPopup: [yes], no
   */
  function eSheep(options, isChild) {
    _classCallCheck(this, eSheep);

    this.userOptions = options ? options : {
      allowPets: "none",
      allowPopup: "yes"
    };
    if (!this.userOptions.allowPopup) this.userOptions.allowPopup = "yes";
    if (!this.userOptions.allowPets) this.userOptions.allowPets = "none"; // CORS: Cross calls are not accepted by new browsers.

    this.animationFile = DEFAULT_XML;
    this.id = Date.now() + Math.random();
    this.DOMdiv = document.createElement("div"); // Div added to webpage, containing the sheep

    this.DOMdiv.setAttribute("id", this.id);
    this.DOMimg = document.createElement("img"); // Tile image, will be positioned inside the div

    this.DOMinfo = document.createElement("div"); // about dialog, if you press on the sheep

    this.parser = new DOMParser(); // XML parser

    this.xmlDoc = null; // parsed XML Document

    this.prepareToDie = false; // when removed, animations should be stopped

    this.isChild = isChild != null; // Child will be removed once they reached the end

    this.tilesX = 1; // Quantity of images inside Tile

    this.tilesY = 1; // Quantity of images inside Tile

    this.imageW = 1; // Width of the sprite image

    this.imageH = 1; // Height of the sprite image

    this.imageX = 1; // Position of sprite inside webpage

    this.imageY = 1; // Position of sprite inside webpage

    this.flipped = false; // if sprite is flipped

    this.dragging = false; // if user is dragging the sheep

    this.infobox = false; // if infobox is visible

    this.animationId = 0; // current animation ID

    this.animationStep = 0; // current animation step

    this.animationNode = null; // current animation DOM node

    this.sprite = new Image(); // sprite image (Tiles)

    this.HTMLelement = null; // the HTML element where the pet is walking on

    this.randS = Math.random() * 100; // random value, will change when page is reloaded

    this.screenW = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; // window width

    this.screenH = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight; // window height
  }
  /*
   * Start new animation on the page.
   * if animation is not set, the default sheep will be taken
   */


  _createClass(eSheep, [{
    key: "Start",
    value: function Start(animation) {
      if (typeof animation !== 'undefined' && animation != null) {
        this.animationFile = animation;
      }

      var ajax = new XMLHttpRequest();
      var sheepClass = this;
      ajax.open("GET", this.animationFile, true);
      ajax.addEventListener("readystatechange", function () {
        if (this.readyState == 4) {
          if (this.status == 200) // successfully loaded XML, parse it and create first esheep.
            sheepClass._parseXML(this.responseText);else console.error("XML not available:" + this.statusText + "\n" + this.responseText);
        }
      });
      ajax.send(null);
    }
  }, {
    key: "remove",
    value: function remove() {
      var _this = this;

      this.prepareToDie = true;
      this.DOMinfo.Hide();
      setTimeout(function () {
        _this.DOMdiv = _this.DOMimg = _this.DOMinfo = null;
        document.getElementById(_this.id).outerHTML = '';
      }, 500);
    }
    /*
     * Parse loaded XML, contains spawn, animations and childs
     */

  }, {
    key: "_parseXML",
    value: function _parseXML(text) {
      var _this2 = this;

      this.xmlDoc = this.parser.parseFromString(text, 'text/xml');
      var image = this.xmlDoc.getElementsByTagName('image')[0];
      this.tilesX = image.getElementsByTagName("tilesx")[0].textContent;
      this.tilesY = image.getElementsByTagName("tilesy")[0].textContent; // Event listener: Sprite was loaded =>
      //   play animation only when the sprite is loaded

      this.sprite.addEventListener("load", function () {
        if (ACTIVATE_DEBUG) console.log("Sprite image loaded");
        var attribute = "width:" + _this2.sprite.width + "px;" + "height:" + _this2.sprite.height + "px;" + "position:absolute;" + "top:0px;" + "left:0px;" + "max-width: none;";

        _this2.DOMimg.setAttribute("style", attribute); // prevent to move image (will show the entire sprite sheet if not catched)


        _this2.DOMimg.addEventListener("dragstart", function (e) {
          e.preventDefault();
          return false;
        });

        _this2.imageW = _this2.sprite.width / _this2.tilesX;
        _this2.imageH = _this2.sprite.height / _this2.tilesY;
        attribute = "width:" + _this2.imageW + "px;" + "height:" + _this2.imageH + "px;" + "position:fixed;" + "top:" + _this2.imageY + "px;" + "left:" + _this2.imageX + "px;" + "transform:rotatey(0deg);" + "cursor:move;" + "z-index:2000;" + "overflow:hidden;";

        _this2.DOMdiv.setAttribute("style", attribute);

        _this2.DOMdiv.appendChild(_this2.DOMimg);

        if (_this2.isChild) _this2._spawnChild();else _this2._spawnESheep();
      });
      this.sprite.src = 'data:image/png;base64,' + image.getElementsByTagName("png")[0].textContent;
      this.DOMimg.setAttribute("src", this.sprite.src); // Mouse move over eSheep, check if eSheep should be moved over the screen

      this.DOMdiv.addEventListener("mousemove", function (e) {
        if (!_this2.dragging && e.buttons == 1 && e.button == 0) {
          _this2.dragging = true;
          _this2.HTMLelement = null;

          var childsRoot = _this2.xmlDoc.getElementsByTagName('animations')[0];

          var childs = childsRoot.getElementsByTagName('animation');

          for (var k = 0; k < childs.length; k++) {
            if (childs[k].getElementsByTagName('name')[0].textContent == "drag") {
              _this2.animationId = childs[k].getAttribute("id");
              _this2.animationStep = 0;
              _this2.animationNode = childs[k];
              break;
            }
          }
        }
      }); // Add event listener to body, if mouse moved too fast over the dragging eSheep

      document.body.addEventListener("mousemove", function (e) {
        if (_this2.dragging) {
          _this2.imageX = parseInt(e.clientX) - _this2.imageW / 2;
          _this2.imageY = parseInt(e.clientY) - _this2.imageH / 2;
          _this2.DOMdiv.style.left = _this2.imageX + "px";
          _this2.DOMdiv.style.top = _this2.imageY + "px";
          _this2.DOMinfo.style.left = parseInt(_this2.imageX + _this2.imageW / 2) + "px";
          _this2.DOMinfo.style.top = _this2.imageY + "px";
        }
      }); // Window resized, recalculate eSheep bounds

      document.body.addEventListener("resize", function () {
        _this2.screenW = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
        _this2.screenH = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

        if (_this2.imageY + _this2.imageH > _this2.screenH) {
          _this2.imageY = _this2.screenH - _this2.imageH;
          _this2.DOMdiv.style.top = _this2.imageY + "px";
        }

        if (_this2.imageX + _this2.imageW > _this2.screenW) {
          _this2.imageX = _this2.screenW - _this2.imageW;
          _this2.DOMdiv.style.left = _this2.imageX + "px";
        }
      }); // Don't allow contextmenu over the sheep

      this.DOMdiv.addEventListener("contextmenu", function (e) {
        e.preventDefault();
        return false;
      }); // Mouse released

      this.DOMdiv.addEventListener("mouseup", function (e) {
        if (_this2.dragging) {
          _this2.dragging = false;
        } else if (_this2.infobox) {
          _this2.DOMinfo.Hide();

          _this2.infobox = false;
        } else {
          if (_this2.userOptions.allowPopup === "yes") {
            _this2.DOMinfo.style.left = Math.min(_this2.screenW - _this2.imageW, Math.max(_this2.imageW, parseInt(_this2.imageX + _this2.imageW / 2))) + "px";
            _this2.DOMinfo.style.top = parseInt(_this2.imageY) + "px";

            _this2.DOMinfo.Show();

            _this2.infobox = true;
          }
        }
      }); // Mouse released over the info box

      this.DOMinfo.addEventListener("mouseup", function (e) {
        _this2.DOMinfo.Hide();

        _this2.infobox = false;
      }); // Create About box

      var attribute = "width:200px;" + "height:100px;" + "transform:translate(-50%, -50%) scale(0.1);" + "position:fixed;" + "top:100px;left:10px;" + "display:none;" + "border-width:2px;" + "border-radius:5px;" + "border-style:ridge;" + "border-color:#0000ab;" + "text-align:center;" + "text-shadow: 1px 1px 3px #ffff88;" + "box-shadow: 3px 3px 10px #888888;" + "color:black;" + "opacity:0.9;" + "z-index:9999;" + "overflow:auto;" + "transition:transform 0.3s ease;" + "background: linear-gradient(to bottom right, rgba(128,128,255,0.7), rgba(200,200,255,0.4));";
      this.DOMinfo.setAttribute("style", attribute);
      var headerNode = this.xmlDoc.getElementsByTagName('header')[0];
      var htmlT = document.createElement("b").appendChild(document.createTextNode(headerNode.getElementsByTagName('title')[0].textContent));
      var htmlV = document.createElement("sup");
      var htmlL = document.createElement("a");
      var htmlP = document.createElement("p");
      htmlV.appendChild(document.createTextNode("App v." + VERSION));
      htmlV.appendChild(document.createElement("br"));
      htmlV.appendChild(document.createTextNode("Pet v." + headerNode.getElementsByTagName('version')[0].textContent));
      htmlV.setAttribute("style", "float:right;text-align:right;");
      htmlL.appendChild(document.createTextNode("\uD83C\uDFE0"));
      htmlL.setAttribute("href", "https://github.com/Adrianotiger/web-esheep");
      htmlL.setAttribute("target", "_blank");
      htmlL.setAttribute("style", "float:left");
      htmlP.appendChild(document.createTextNode(headerNode.getElementsByTagName('info')[0].textContent));
      htmlP.setAttribute("style", "font-size:" + (100 - parseInt(headerNode.getElementsByTagName('info')[0].textContent.length / 10)) + "%;");
      this.DOMinfo.appendChild(htmlV);
      this.DOMinfo.appendChild(htmlL);

      if (this.userOptions.allowPets !== "none") {
        htmlL = document.createElement("a");
        htmlL.appendChild(document.createTextNode("\u2699"));
        htmlL.setAttribute("href", "javascript:;");
        htmlL.setAttribute("style", "float:left");
        this.DOMinfo.appendChild(htmlL);
        setTimeout(function () {
          _this2._loadPetList(htmlL);
        }, 100);
      }

      this.DOMinfo.appendChild(htmlT);
      this.DOMinfo.appendChild(document.createElement("br"));
      this.DOMinfo.appendChild(document.createElement("hr"));
      this.DOMinfo.appendChild(htmlP); // Add about and sheep elements to the body

      document.body.appendChild(this.DOMinfo);
      document.body.appendChild(this.DOMdiv);

      this.DOMinfo.Show = function () {
        _this2.DOMinfo.style.display = "block";
        _this2.DOMinfo.style.transform = "translate(-50%, -100%) scale(1.0)";
      };

      this.DOMinfo.Hide = function () {
        _this2.DOMinfo.style.transform = "translate(-50%, -50%) scale(0.1)";
        setTimeout(function () {
          _this2.DOMinfo.style.display = "none";
        }, 300);
      };
    }
  }, {
    key: "_setPosition",

    /*
     * Set new position for the pet
     * If absolute is true, the x and y coordinates are used as absolute values.
     * If false, x and y are added to the current position
     */
    value: function _setPosition(x, y, absolute) {
      if (this.DOMdiv) {
        if (absolute) {
          this.imageX = parseInt(x);
          this.imageY = parseInt(y);
        } else {
          this.imageX = parseInt(this.imageX) + parseInt(x);
          this.imageY = parseInt(this.imageY) + parseInt(y);
        }

        this.DOMdiv.style.left = this.imageX + "px";
        this.DOMdiv.style.top = this.imageY + "px";
      }
    }
    /*
     * Spawn new esheep, this is called if the XML was loaded successfully
     */

  }, {
    key: "_spawnESheep",
    value: function _spawnESheep() {
      var spawnsRoot = this.xmlDoc.getElementsByTagName('spawns')[0];
      var spawns = spawnsRoot.getElementsByTagName('spawn');
      var prob = 0;

      for (var i = 0; i < spawns.length; i++) {
        prob += parseInt(spawns[0].getAttribute("probability"));
      }

      var rand = Math.random() * prob;
      prob = 0;

      for (i = 0; i < spawns.length; i++) {
        prob += parseInt(spawns[i].getAttribute("probability"));

        if (prob >= rand || i == spawns.length - 1) {
          this._setPosition(this._parseKeyWords(spawns[i].getElementsByTagName('x')[0].textContent), this._parseKeyWords(spawns[i].getElementsByTagName('y')[0].textContent), true);

          if (ACTIVATE_DEBUG) console.log("Spawn: " + this.imageX + ", " + this.imageY);
          this.animationId = spawns[i].getElementsByTagName('next')[0].textContent;
          this.animationStep = 0;
          var childsRoot = this.xmlDoc.getElementsByTagName('animations')[0];
          var childs = childsRoot.getElementsByTagName('animation');

          for (var k = 0; k < childs.length; k++) {
            if (childs[k].getAttribute("id") == this.animationId) {
              this.animationNode = childs[k]; // Check if child should be loaded toghether with this animation

              var childsRoot = this.xmlDoc.getElementsByTagName('childs')[0];
              var childs = childsRoot.getElementsByTagName('child');

              for (var j = 0; j < childs.length; j++) {
                if (childs[j].getAttribute("animationid") == this.animationId) {
                  if (ACTIVATE_DEBUG) console.log("Child from Spawn");
                  var eSheepChild = new eSheep(null, true);
                  eSheepChild.animationId = childs[j].getElementsByTagName('next')[0].textContent;
                  var x = childs[j].getElementsByTagName('x')[0].textContent; //

                  var y = childs[j].getElementsByTagName('y')[0].textContent;

                  eSheepChild._setPosition(this._parseKeyWords(x), this._parseKeyWords(y), true); // Start animation


                  eSheepChild.Start(this.animationFile);
                  break;
                }
              }

              break;
            }
          }

          break;
        }
      } // Play next step


      this._nextESheepStep();
    }
    /*
     * Like spawnESheep, but for Childs
     */

  }, {
    key: "_spawnChild",
    value: function _spawnChild() {
      var childsRoot = this.xmlDoc.getElementsByTagName('animations')[0];
      var childs = childsRoot.getElementsByTagName('animation');

      for (var k = 0; k < childs.length; k++) {
        if (childs[k].getAttribute("id") == this.animationId) {
          this.animationNode = childs[k];
          break;
        }
      }

      this._nextESheepStep();
    } // Parse the human readable expression from XML to a computer readable expression

  }, {
    key: "_parseKeyWords",
    value: function _parseKeyWords(value) {
      value = value.replace(/screenW/g, this.screenW);
      value = value.replace(/screenH/g, this.screenH);
      value = value.replace(/areaW/g, this.screenH);
      value = value.replace(/areaH/g, this.screenH);
      value = value.replace(/imageW/g, this.imageW);
      value = value.replace(/imageH/g, this.imageH);
      value = value.replace(/random/g, Math.random() * 100);
      value = value.replace(/randS/g, this.randS);
      value = value.replace(/imageX/g, this.imageX);
      value = value.replace(/imageY/g, this.imageY);
      var ret = 0;

      try {
        ret = eval(value);
      } catch (err) {
        console.error("Unable to parse this position: \n'" + value + "'\n Error message: \n" + err.message);
      }

      return ret;
    }
    /*
     * Once the animation is over, get the next animation to play
     */

  }, {
    key: "_getNextRandomNode",
    value: function _getNextRandomNode(parentNode) {
      var baseNode = parentNode.getElementsByTagName('next');
      var childsRoot = this.xmlDoc.getElementsByTagName('animations')[0];
      var childs = childsRoot.getElementsByTagName('animation');
      var prob = 0;
      var nodeFound = false; // no more animations (it was the last one)

      if (baseNode.length == 0) {
        // If it is a child, remove the child from document
        if (this.isChild) {
          // remove child
          if (ACTIVATE_DEBUG) console.log("Remove child");
          document.body.removeChild(this.DOMinfo);
          document.body.removeChild(this.DOMdiv);
          delete this;
        } // else, spawn sheep again
        else {
            this._spawnESheep();
          }

        return false;
      }

      for (var k = 0; k < baseNode.length; k++) {
        prob += parseInt(baseNode[k].getAttribute("probability"));
      }

      var rand = Math.random() * prob;
      var index = 0;
      prob = 0;

      for (k = 0; k < baseNode.length; k++) {
        prob += parseInt(baseNode[k].getAttribute("probability"));

        if (prob >= rand) {
          index = k;
          break;
        }
      }

      for (k = 0; k < childs.length; k++) {
        if (childs[k].getAttribute("id") == baseNode[index].textContent) {
          this.animationId = childs[k].getAttribute("id");
          this.animationStep = 0;
          this.animationNode = childs[k];
          nodeFound = true;
          break;
        }
      }

      if (nodeFound) // create Child, if present
        {
          var childsRoot = this.xmlDoc.getElementsByTagName('childs')[0];
          var childs = childsRoot.getElementsByTagName('child');

          for (k = 0; k < childs.length; k++) {
            if (childs[k].getAttribute("animationid") == this.animationId) {
              if (ACTIVATE_DEBUG) console.log("Child from Animation");
              var eSheepChild = new eSheep(null, true);
              eSheepChild.animationId = childs[k].getElementsByTagName('next')[0].textContent;
              var x = childs[k].getElementsByTagName('x')[0].textContent; //

              var y = childs[k].getElementsByTagName('y')[0].textContent;

              eSheepChild._setPosition(this._parseKeyWords(x), this._parseKeyWords(y), true);

              eSheepChild.Start(this.animationFile);
              break;
            }
          }
        }

      return nodeFound;
    }
    /*
     * Check if sheep is walking over a defined HTML TAG-element
     */

  }, {
    key: "_checkOverlapping",
    value: function _checkOverlapping() {
      var x = this.imageX;
      var y = this.imageY + this.imageH;
      var rect;
      var margin = 20;
      if (this.HTMLelement) margin = 5;

      for (var index in COLLISION_WITH) {
        var els = document.body.getElementsByTagName(COLLISION_WITH[index]);

        for (var i = 0; i < els.length; i++) {
          rect = els[i].getBoundingClientRect();

          if (y > rect.top - 2 && y < rect.top + margin) {
            if (x > rect.left && x < rect.right - this.imageW) {
              var style = window.getComputedStyle(els[i]);

              if (style.borderTopStyle != "" && style.borderTopStyle != "none" && style.display != "none") {
                return els[i];
              }
            }
          }
        }
      }

      return false;
    }
    /*
     * Try to get the value of a node (from the current animationNode), if it is not possible returns the defaultValue
     */

  }, {
    key: "_getNodeValue",
    value: function _getNodeValue(nodeName, valueName, defaultValue) {
      if (!this.animationNode || !this.animationNode.getElementsByTagName(nodeName)) return;

      if (this.animationNode.getElementsByTagName(nodeName)[0].getElementsByTagName(valueName)[0]) {
        var value = this.animationNode.getElementsByTagName(nodeName)[0].getElementsByTagName(valueName)[0].textContent;
        return this._parseKeyWords(value);
      } else {
        return defaultValue;
      }
    }
    /*
     * Next step (each frame is a step)
     */

  }, {
    key: "_nextESheepStep",
    value: function _nextESheepStep() {
      if (this.prepareToDie) return;

      var x1 = this._getNodeValue('start', 'x', 0);

      var y1 = this._getNodeValue('start', 'y', 0);

      var off1 = this._getNodeValue('start', 'offsety', 0);

      var opa1 = this._getNodeValue('start', 'opacity', 1);

      var del1 = this._getNodeValue('start', 'interval', 1000);

      var x2 = this._getNodeValue('end', 'x', 0);

      var y2 = this._getNodeValue('end', 'y', 0);

      var off2 = this._getNodeValue('end', 'offsety', 0);

      var opa2 = this._getNodeValue('end', 'interval', 1);

      var del2 = this._getNodeValue('end', 'interval', 1000);

      var repeat = this._parseKeyWords(this.animationNode.getElementsByTagName('sequence')[0].getAttribute('repeat'));

      var repeatfrom = this.animationNode.getElementsByTagName('sequence')[0].getAttribute('repeatfrom');
      var gravity = this.animationNode.getElementsByTagName('gravity');
      var border = this.animationNode.getElementsByTagName('border');
      var steps = this.animationNode.getElementsByTagName('frame').length + (this.animationNode.getElementsByTagName('frame').length - repeatfrom) * repeat;
      var index;
      if (this.animationStep < this.animationNode.getElementsByTagName('frame').length) index = this.animationNode.getElementsByTagName('frame')[this.animationStep].textContent;else if (repeatfrom == 0) index = this.animationNode.getElementsByTagName('frame')[this.animationStep % this.animationNode.getElementsByTagName('frame').length].textContent;else index = this.animationNode.getElementsByTagName('frame')[parseInt(repeatfrom) + parseInt((this.animationStep - repeatfrom) % (this.animationNode.getElementsByTagName('frame').length - repeatfrom))].textContent;
      this.DOMimg.style.left = -this.imageW * (index % this.tilesX) + "px";
      this.DOMimg.style.top = -this.imageH * parseInt(index / this.tilesX) + "px";

      if (this.dragging || this.infobox) {
        this.animationStep++;
        setTimeout(this._nextESheepStep.bind(this), 50);
        return;
      }

      if (this.flipped) {
        x1 = -x1;
        x2 = -x2;
      }

      if (this.animationStep == 0) this._setPosition(x1, y1, false);else this._setPosition(parseInt(x1) + parseInt((x2 - x1) * this.animationStep / steps), parseInt(y1) + parseInt((y2 - y1) * this.animationStep / steps), false);
      this.animationStep++;

      if (this.animationStep >= steps) {
        if (this.animationNode.getElementsByTagName('action')[0]) {
          switch (this.animationNode.getElementsByTagName('action')[0].textContent) {
            case "flip":
              if (this.DOMdiv.style.transform == "rotateY(0deg)") {
                this.DOMdiv.style.transform = "rotateY(180deg)";
                this.flipped = true;
              } else {
                this.DOMdiv.style.transform = "rotateY(0deg)";
                this.flipped = false;
              }

              break;

            default:
              break;
          }
        }

        if (!this._getNextRandomNode(this.animationNode.getElementsByTagName('sequence')[0])) return;
      }

      var setNext = false;

      if (border && border[0] && border[0].getElementsByTagName('next')) {
        if (x2 < 0 && this.imageX < 0) {
          this.imageX = 0;
          setNext = true;
        } else if (x2 > 0 && this.imageX > this.screenW - this.imageW) {
          this.imageX = this.screenW - this.imageW;
          this.DOMdiv.style.left = parseInt(this.imageX) + "px";
          setNext = true;
        } else if (y2 < 0 && this.imageY < 0) {
          this.imageY = 0;
          setNext = true;
        } else if (y2 > 0 && this.imageY > this.screenH - this.imageH) {
          this.imageY = this.screenH - this.imageH;
          setNext = true;
        } else if (y2 > 0) {
          if (this._checkOverlapping()) {
            if (this.imageY > this.imageH) {
              this.HTMLelement = this._checkOverlapping();
              this.imageY = Math.ceil(this.HTMLelement.getBoundingClientRect().top) - this.imageH;
              setNext = true;
            }
          }
        } else if (this.HTMLelement) {
          if (!this._checkOverlapping()) {
            if (this.imageY + this.imageH > this.HTMLelement.getBoundingClientRect().top + 3 || this.imageY + this.imageH < this.HTMLelement.getBoundingClientRect().top - 3) {
              this.HTMLelement = null;
            } else if (this.imageX < this.HTMLelement.getBoundingClientRect().left) {
              this.imageX = parseInt(this.imageX + 3);
              setNext = true;
            } else {
              this.imageX = parseInt(this.imageX - 3);
              setNext = true;
            }

            this.DOMdiv.style.left = parseInt(this.imageX) + "px";
          }
        }

        if (setNext) {
          if (!this._getNextRandomNode(border[0])) return;
        }
      }

      if (!setNext && gravity && gravity[0] && gravity[0].getElementsByTagName('next')) {
        if (this.imageY < this.screenH - this.imageH - 2) {
          if (this.HTMLelement == null) {
            setNext = true;
          } else {
            if (!this._checkOverlapping()) {
              setNext = true;
              this.HTMLelement = null;
            }
          }

          if (setNext) {
            if (!this._getNextRandomNode(gravity[0])) return;
          }
        }
      }

      if (!setNext) {
        if (this.imageX < -this.imageW && x2 < 0 || this.imageX > this.screenW && x2 > 0 || this.imageY < -this.imageH && y1 < 0 || this.imageY > this.screenH && y2 > 0) {
          setNext = true;

          if (!this.isChild) {
            this._spawnESheep();
          }

          return;
        }
      }

      setTimeout(this._nextESheepStep.bind(this), parseInt(del1) + parseInt((del2 - del1) * this.animationStep / steps));
    }
    /*
     * Load Pet List from GitHub, so user can change it
     */

  }, {
    key: "_loadPetList",
    value: function _loadPetList(element) {
      var _this3 = this;

      fetch("https://adrianotiger.github.io/desktopPet/Pets/pets.json", {
        credentials: 'same-origin',
        cache: "force-cache"
      }).then(function (response) {
        return response.json();
      }).then(function (json) {
        console.log(json);

        if (json.pets) {
          element.addEventListener("mouseup", function (e) {
            e.preventDefault();
            e.stopPropagation();
            var div = document.createElement("div");
            div.setAttribute("style", "position:absolute;left:0px;top:20px;width:183px;min-height:100px;background:linear-gradient(to bottom, #8080ff, #3030a1);color:yellow;");
            element.parentNode.appendChild(div);

            var _loop = function _loop(k) {
              pet = document.createElement("b");
              pet.setAttribute("style", "cursor:pointer;display:block;");
              pet.appendChild(document.createTextNode(json.pets[k].folder));
              pet.addEventListener("click", function () {
                var x = new eSheep(_this3.userOptions);
                x.Start("https://adrianotiger.github.io/desktopPet/Pets/" + json.pets[k].folder + "/animations.xml");

                _this3.remove();
              });
              div.appendChild(pet);
            };

            for (var k in json.pets) {
              var pet;

              _loop(k);
            }

            div.addEventListener("click", function (e) {
              element.parentNode.removeChild(div);
            });
          });
        }
      });
    }
  }]);

  return eSheep;
}();

;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJlc2hlZXAubWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5mdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoXCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb25cIik7IH0gfVxuXG5mdW5jdGlvbiBfZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmIChcInZhbHVlXCIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9XG5cbmZ1bmN0aW9uIF9jcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIF9kZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9XG5cbi8qXHJcbiAqIFByb2plY3Q6XHJcbiAqICAgICAgICAgICAgICAgIGVTaGVlcCAtIFdlYnBhZ2VcclxuICpcclxuICogRGF0ZTpcclxuICogICAgICAgICAgICAgICAgMDQuYXByaWwgMjAxOFxyXG4gKlxyXG4gKiBBdXRob3I6XHJcbiAqICAgICAgICAgICAgICAgIEFkcmlhbm8gUGV0cnVjY2kgKGh0dHA6Ly9lc2hlZXAucGV0cnVjY2kuY2gpXHJcbiAqXHJcbiAqIFZlcnNpb246ICAgICAgIDAuOS4wXHJcbiAqXHJcbiAqIEludHJvZHVjdGlvbjpcclxuICogICAgICAgICAgICAgICAgQXMgXCJ3cmFwcGVyXCIgZm9yIHRoZSBPcGVuU291cmNlIEMjIHByb2plY3RcclxuICogICAgICAgICAgICAgICAgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vQWRyaWFub3RpZ2VyL2Rlc2t0b3BQZXQpLFxyXG4gKiAgICAgICAgICAgICAgICB0aGlzIGphdmFzY3JpcHQgXCJjbGFzc1wiIHdhcyB3cml0dGVuIHRvIGdldCB0aGUgYW5pbWF0aW9ucyBhbHNvIGluc2lkZSB5b3VyXHJcbiAqICAgICAgICAgICAgICAgIHdlYnBhZ2UuIEl0IGRvZXNuJ3Qgd29yayBsaWtlIHRoZSBXaW5kb3dzIHZlcnNpb24sIGJ1dCBzaG93IG11Y2ggYW5pbWF0aW9ucyBmcm9tIGl0LlxyXG4gKlxyXG4gKiBEZXNjcmlwdGlvbjpcclxuICogICAgICAgICAgICAgICAgQWRkIGEgd2Fsa2luZyBwZXQgKHNoZWVwIHRvIHlvdXIgaG9tZSBwYWdlKSB3aXRoIGp1c3QgYSBmZXcgbGluZXMgb2YgY29kZSFcclxuICogICAgICAgICAgICAgICAgV2lsbCBhZGQgYSBsb3ZlbHkgc2hlZXAgKHN0cmF5IHNoZWVwKSBhbmQgdGhpcyB3aWxsIHdhbGsgYXJvdW5kIHlvdXIgcGFnZSBhbmQgb3ZlclxyXG4gKiAgICAgICAgICAgICAgICBhbGwgPGhyPnMgYW5kIDxkaXY+cyB3aXRoIGEgYm9yZGVyLiBZb3UgY2FuIGFsc28gc2VsZWN0IGFub3RoZXIgYW5pbWF0aW9uLCB1c2luZyB5b3VyXHJcbiAqICAgICAgICAgICAgICAgIHBlcnNvbmFsIFhNTCBmaWxlIG9yIG9uZSBmcm9tIHRoZSBkYXRhYmFzZS5cclxuICpcclxuICogSG93IHRvIHVzZTpcclxuICogICAgICAgICAgICAgICAgQWRkIHRoaXMgbGluZSBpbiB5b3VyIDxoZWFkZXI+OlxyXG4gKiAgICAgICAgICAgICAgICA8c2NyaXB0IHNyYz1cImh0dHBzOi8vYWRyaWFub3RpZ2VyLmdpdGh1Yi5pby93ZWItZXNoZWVwL3NyYy9lc2hlZXAuanNcIj48L3NjcmlwdD5cclxuICogICAgICAgICAgICAgICAgQWRkIHRoaXMgbGluZXMgaW4geW91ciA8Ym9keT4gKGF0IHRoZSBlbmQgaWYgcG9zc2libGUpOlxyXG4gKiAgICAgICAgICAgICAgICA8c2NyaXB0PlxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwZXQgPSBuZXcgZVNoZWVwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcGV0LlN0YXJ0KCk7XHJcbiAgICAgICAgICAgICAgICAgIDwvc2NyaXB0PlxyXG4gKiAgICAgICAgICAgICAgICBUaGF0J3MgYWxsIVxyXG4gKlxyXG4gKiBSZXF1aXJlbWVudDpcclxuICogICAgICAgICAgICAgICAgVGVzdGVkIG9uIElFMTEsIEVkZ2UgYW5kIE9wZXJhXHJcbiAqXHJcbiAqIENoYW5nZWxvZzpcclxuICogICAgICAgICAgICAgICAgVmVyc2lvbiAwLjkuMCAtIDExLjA3LjIwMTk6XHJcbiAqICAgICAgICAgICAgICAgICAgLSBVcGRhdGVkIGFuaW1hdGlvbiBsaW5rIHRvIHRoZSBtYWluIHByb2plY3QgYW5pbWF0aW9uXHJcbiAqICAgICAgICAgICAgICAgICAgLSBSZWNvbXBpbGVkIHdpdGggbmV3IFlhcm4gdmVyc2lvbiAoc2VjdXJpdHkgdnVsbmVyYWJpbGl0eSlcclxuICogICAgICAgICAgICAgICAgVmVyc2lvbiAwLjguMCAtIDI5LjA1LjIwMTg6XHJcbiAqICAgICAgICAgICAgICAgICAgLSBNb3ZlZCBhbmltYXRpb24gZmlsZXMgdG8gZ2l0aHViXHJcbiAqICAgICAgICAgICAgICAgICAgLSBBZGRlZCBvcHRpb25zIHRvIHRoZSBzY3JpcHQgXHJcbiAqICAgICAgICAgICAgICAgICAgLSBMb2FkIGFuIGFuaW1hdGlvbiBmcm9tIHRoZSBHaXRIdWIgYW5pbWF0aW9ucyBmcm9tIHRoZSBwb3B1cCB3aW5kb3dcclxuICogICAgICAgICAgICAgICAgVmVyc2lvbiAwLjcuMSAtIDA0LjA0LjIwMTg6XHJcbiAqICAgICAgICAgICAgICAgICAgLSBBZGQgbWF4LXdpZHRoOiBub25lIHRvIGVuc3VyZSB0aGUgaW1hZ2UgaXMgcHJvcGVybHkgc2hvd25cclxuICogICAgICAgICAgICAgICAgVmVyc2lvbiAwLjcgLSAxMy4xMS4yMDE3OlxyXG4gKiAgICAgICAgICAgICAgICAgIC0gYmV0dGVyIEphdmFzY3JpcHQgc3RydWN0dXJlXHJcbiAqICAgICAgICAgICAgICAgICAgLSBHaXRIdWIgdmVyc2lvbiAoaHR0cHM6Ly9naXRodWIuY29tL0Fkcmlhbm90aWdlci93ZWItZXNoZWVwKVxyXG4gKiAgICAgICAgICAgICAgICAgIC0gQ2hpbGRzIGFuaW1hdGlvbnMgYWRkZWRcclxuICogICAgICAgICAgICAgICAgICAtIEJldHRlciBjb21tZW50c1xyXG4gKiAgICAgICAgICAgICAgICAgIC0gUmVwbGFjZWQgYWxlcnRzIHdpdGggY29uc29sZS5lcnJvclxyXG4gKiAgICAgICAgICAgICAgICBWZXJzaW9uIDAuNSAtIDEyLjA3LjIwMTc6XHJcbiAqICAgICAgICAgICAgICAgICAgLSBhbmltYXRpb25zIHN0YXJ0cyBvbmx5IG9uY2UgdGhlIGltYWdlIHdhcyBsb2FkZWQgKHRoYW5rcyBSZWRTcGFycjB3KVxyXG4gKiAgICAgICAgICAgICAgICBWZXJzaW9uIDAueDpcclxuICogICAgICAgICAgICAgICAgICAtIHN0aWxsIGJldGEgdmVyc2lvbnMuLi5cclxuICovXG52YXIgVkVSU0lPTiA9ICcwLjkuMSc7IC8vIHdlYiBlU2hlZXAgdmVyc2lvblxuXG52YXIgQUNUSVZBVEVfREVCVUcgPSBmYWxzZTsgLy8gc2hvdyBsb2cgb24gY29uc29sZVxuXG52YXIgREVGQVVMVF9YTUwgPSBcImh0dHBzOi8vYWRyaWFub3RpZ2VyLmdpdGh1Yi5pby9kZXNrdG9wUGV0L1BldHMvZXNoZWVwNjQvYW5pbWF0aW9ucy54bWxcIjsgLy8gZGVmYXVsdCBYTUwgYW5pbWF0aW9uXG5cbnZhciBDT0xMSVNJT05fV0lUSCA9IFtcImRpdlwiLCBcImhyXCJdOyAvLyBlbGVtZW50cyBvbiBwYWdlIHRvIGRldGVjdCBmb3IgY29sbGlzaW9uc1xuXG4vKlxyXG4gKiBlU2hlZXAgY2xhc3MuXHJcbiAqIENyZWF0ZSBhIG5ldyBjbGFzcyBvZiB0aGlzIHR5cGUgaWYgeW91IHdhbnQgYSBuZXcgcGV0LiBXaWxsIGNyZWF0ZSB0aGUgY29tcG9uZW50cyBmb3IgdGhlIHBldC5cclxuICogT25jZSBjcmVhdGVkLCB5b3UgY2FuIGNhbGwgW3ZhcmlhYmxlTmFtZV0uU3RhcnQoKSB0byBzdGFydCB0aGUgYW5pbWF0aW9uIHdpdGggeW91ciBkZXNpcmVkIHBldC5cclxuICovXG5cbnZhciBlU2hlZXAgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkge1xuICAvKiBQYXJhbWV0ZXJzIGZvciBvcHRpb25zIFtkZWZhdWx0XTpcclxuICAgKiAtIGFsbG93UGV0czogW25vbmVdLCBhbGxcclxuICAgKiAtIGFsbG93UG9wdXA6IFt5ZXNdLCBub1xyXG4gICAqL1xuICBmdW5jdGlvbiBlU2hlZXAob3B0aW9ucywgaXNDaGlsZCkge1xuICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBlU2hlZXApO1xuXG4gICAgdGhpcy51c2VyT3B0aW9ucyA9IG9wdGlvbnMgPyBvcHRpb25zIDoge1xuICAgICAgYWxsb3dQZXRzOiBcIm5vbmVcIixcbiAgICAgIGFsbG93UG9wdXA6IFwieWVzXCJcbiAgICB9O1xuICAgIGlmICghdGhpcy51c2VyT3B0aW9ucy5hbGxvd1BvcHVwKSB0aGlzLnVzZXJPcHRpb25zLmFsbG93UG9wdXAgPSBcInllc1wiO1xuICAgIGlmICghdGhpcy51c2VyT3B0aW9ucy5hbGxvd1BldHMpIHRoaXMudXNlck9wdGlvbnMuYWxsb3dQZXRzID0gXCJub25lXCI7IC8vIENPUlM6IENyb3NzIGNhbGxzIGFyZSBub3QgYWNjZXB0ZWQgYnkgbmV3IGJyb3dzZXJzLlxuXG4gICAgdGhpcy5hbmltYXRpb25GaWxlID0gREVGQVVMVF9YTUw7XG4gICAgdGhpcy5pZCA9IERhdGUubm93KCkgKyBNYXRoLnJhbmRvbSgpO1xuICAgIHRoaXMuRE9NZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTsgLy8gRGl2IGFkZGVkIHRvIHdlYnBhZ2UsIGNvbnRhaW5pbmcgdGhlIHNoZWVwXG5cbiAgICB0aGlzLkRPTWRpdi5zZXRBdHRyaWJ1dGUoXCJpZFwiLCB0aGlzLmlkKTtcbiAgICB0aGlzLkRPTWltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJpbWdcIik7IC8vIFRpbGUgaW1hZ2UsIHdpbGwgYmUgcG9zaXRpb25lZCBpbnNpZGUgdGhlIGRpdlxuXG4gICAgdGhpcy5ET01pbmZvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTsgLy8gYWJvdXQgZGlhbG9nLCBpZiB5b3UgcHJlc3Mgb24gdGhlIHNoZWVwXG5cbiAgICB0aGlzLnBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsgLy8gWE1MIHBhcnNlclxuXG4gICAgdGhpcy54bWxEb2MgPSBudWxsOyAvLyBwYXJzZWQgWE1MIERvY3VtZW50XG5cbiAgICB0aGlzLnByZXBhcmVUb0RpZSA9IGZhbHNlOyAvLyB3aGVuIHJlbW92ZWQsIGFuaW1hdGlvbnMgc2hvdWxkIGJlIHN0b3BwZWRcblxuICAgIHRoaXMuaXNDaGlsZCA9IGlzQ2hpbGQgIT0gbnVsbDsgLy8gQ2hpbGQgd2lsbCBiZSByZW1vdmVkIG9uY2UgdGhleSByZWFjaGVkIHRoZSBlbmRcblxuICAgIHRoaXMudGlsZXNYID0gMTsgLy8gUXVhbnRpdHkgb2YgaW1hZ2VzIGluc2lkZSBUaWxlXG5cbiAgICB0aGlzLnRpbGVzWSA9IDE7IC8vIFF1YW50aXR5IG9mIGltYWdlcyBpbnNpZGUgVGlsZVxuXG4gICAgdGhpcy5pbWFnZVcgPSAxOyAvLyBXaWR0aCBvZiB0aGUgc3ByaXRlIGltYWdlXG5cbiAgICB0aGlzLmltYWdlSCA9IDE7IC8vIEhlaWdodCBvZiB0aGUgc3ByaXRlIGltYWdlXG5cbiAgICB0aGlzLmltYWdlWCA9IDE7IC8vIFBvc2l0aW9uIG9mIHNwcml0ZSBpbnNpZGUgd2VicGFnZVxuXG4gICAgdGhpcy5pbWFnZVkgPSAxOyAvLyBQb3NpdGlvbiBvZiBzcHJpdGUgaW5zaWRlIHdlYnBhZ2VcblxuICAgIHRoaXMuZmxpcHBlZCA9IGZhbHNlOyAvLyBpZiBzcHJpdGUgaXMgZmxpcHBlZFxuXG4gICAgdGhpcy5kcmFnZ2luZyA9IGZhbHNlOyAvLyBpZiB1c2VyIGlzIGRyYWdnaW5nIHRoZSBzaGVlcFxuXG4gICAgdGhpcy5pbmZvYm94ID0gZmFsc2U7IC8vIGlmIGluZm9ib3ggaXMgdmlzaWJsZVxuXG4gICAgdGhpcy5hbmltYXRpb25JZCA9IDA7IC8vIGN1cnJlbnQgYW5pbWF0aW9uIElEXG5cbiAgICB0aGlzLmFuaW1hdGlvblN0ZXAgPSAwOyAvLyBjdXJyZW50IGFuaW1hdGlvbiBzdGVwXG5cbiAgICB0aGlzLmFuaW1hdGlvbk5vZGUgPSBudWxsOyAvLyBjdXJyZW50IGFuaW1hdGlvbiBET00gbm9kZVxuXG4gICAgdGhpcy5zcHJpdGUgPSBuZXcgSW1hZ2UoKTsgLy8gc3ByaXRlIGltYWdlIChUaWxlcylcblxuICAgIHRoaXMuSFRNTGVsZW1lbnQgPSBudWxsOyAvLyB0aGUgSFRNTCBlbGVtZW50IHdoZXJlIHRoZSBwZXQgaXMgd2Fsa2luZyBvblxuXG4gICAgdGhpcy5yYW5kUyA9IE1hdGgucmFuZG9tKCkgKiAxMDA7IC8vIHJhbmRvbSB2YWx1ZSwgd2lsbCBjaGFuZ2Ugd2hlbiBwYWdlIGlzIHJlbG9hZGVkXG5cbiAgICB0aGlzLnNjcmVlblcgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGggfHwgZG9jdW1lbnQuYm9keS5jbGllbnRXaWR0aDsgLy8gd2luZG93IHdpZHRoXG5cbiAgICB0aGlzLnNjcmVlbkggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCB8fCBkb2N1bWVudC5ib2R5LmNsaWVudEhlaWdodDsgLy8gd2luZG93IGhlaWdodFxuICB9XG4gIC8qXHJcbiAgICogU3RhcnQgbmV3IGFuaW1hdGlvbiBvbiB0aGUgcGFnZS5cclxuICAgKiBpZiBhbmltYXRpb24gaXMgbm90IHNldCwgdGhlIGRlZmF1bHQgc2hlZXAgd2lsbCBiZSB0YWtlblxyXG4gICAqL1xuXG5cbiAgX2NyZWF0ZUNsYXNzKGVTaGVlcCwgW3tcbiAgICBrZXk6IFwiU3RhcnRcIixcbiAgICB2YWx1ZTogZnVuY3Rpb24gU3RhcnQoYW5pbWF0aW9uKSB7XG4gICAgICBpZiAodHlwZW9mIGFuaW1hdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgYW5pbWF0aW9uICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5hbmltYXRpb25GaWxlID0gYW5pbWF0aW9uO1xuICAgICAgfVxuXG4gICAgICB2YXIgYWpheCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgdmFyIHNoZWVwQ2xhc3MgPSB0aGlzO1xuICAgICAgYWpheC5vcGVuKFwiR0VUXCIsIHRoaXMuYW5pbWF0aW9uRmlsZSwgdHJ1ZSk7XG4gICAgICBhamF4LmFkZEV2ZW50TGlzdGVuZXIoXCJyZWFkeXN0YXRlY2hhbmdlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PSA0KSB7XG4gICAgICAgICAgaWYgKHRoaXMuc3RhdHVzID09IDIwMCkgLy8gc3VjY2Vzc2Z1bGx5IGxvYWRlZCBYTUwsIHBhcnNlIGl0IGFuZCBjcmVhdGUgZmlyc3QgZXNoZWVwLlxuICAgICAgICAgICAgc2hlZXBDbGFzcy5fcGFyc2VYTUwodGhpcy5yZXNwb25zZVRleHQpO2Vsc2UgY29uc29sZS5lcnJvcihcIlhNTCBub3QgYXZhaWxhYmxlOlwiICsgdGhpcy5zdGF0dXNUZXh0ICsgXCJcXG5cIiArIHRoaXMucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBhamF4LnNlbmQobnVsbCk7XG4gICAgfVxuICB9LCB7XG4gICAga2V5OiBcInJlbW92ZVwiLFxuICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmUoKSB7XG4gICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuXG4gICAgICB0aGlzLnByZXBhcmVUb0RpZSA9IHRydWU7XG4gICAgICB0aGlzLkRPTWluZm8uSGlkZSgpO1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIF90aGlzLkRPTWRpdiA9IF90aGlzLkRPTWltZyA9IF90aGlzLkRPTWluZm8gPSBudWxsO1xuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChfdGhpcy5pZCkub3V0ZXJIVE1MID0gJyc7XG4gICAgICB9LCA1MDApO1xuICAgIH1cbiAgICAvKlxyXG4gICAgICogUGFyc2UgbG9hZGVkIFhNTCwgY29udGFpbnMgc3Bhd24sIGFuaW1hdGlvbnMgYW5kIGNoaWxkc1xyXG4gICAgICovXG5cbiAgfSwge1xuICAgIGtleTogXCJfcGFyc2VYTUxcIixcbiAgICB2YWx1ZTogZnVuY3Rpb24gX3BhcnNlWE1MKHRleHQpIHtcbiAgICAgIHZhciBfdGhpczIgPSB0aGlzO1xuXG4gICAgICB0aGlzLnhtbERvYyA9IHRoaXMucGFyc2VyLnBhcnNlRnJvbVN0cmluZyh0ZXh0LCAndGV4dC94bWwnKTtcbiAgICAgIHZhciBpbWFnZSA9IHRoaXMueG1sRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbWFnZScpWzBdO1xuICAgICAgdGhpcy50aWxlc1ggPSBpbWFnZS5nZXRFbGVtZW50c0J5VGFnTmFtZShcInRpbGVzeFwiKVswXS50ZXh0Q29udGVudDtcbiAgICAgIHRoaXMudGlsZXNZID0gaW1hZ2UuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJ0aWxlc3lcIilbMF0udGV4dENvbnRlbnQ7IC8vIEV2ZW50IGxpc3RlbmVyOiBTcHJpdGUgd2FzIGxvYWRlZCA9PlxuICAgICAgLy8gICBwbGF5IGFuaW1hdGlvbiBvbmx5IHdoZW4gdGhlIHNwcml0ZSBpcyBsb2FkZWRcblxuICAgICAgdGhpcy5zcHJpdGUuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoQUNUSVZBVEVfREVCVUcpIGNvbnNvbGUubG9nKFwiU3ByaXRlIGltYWdlIGxvYWRlZFwiKTtcbiAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IFwid2lkdGg6XCIgKyBfdGhpczIuc3ByaXRlLndpZHRoICsgXCJweDtcIiArIFwiaGVpZ2h0OlwiICsgX3RoaXMyLnNwcml0ZS5oZWlnaHQgKyBcInB4O1wiICsgXCJwb3NpdGlvbjphYnNvbHV0ZTtcIiArIFwidG9wOjBweDtcIiArIFwibGVmdDowcHg7XCIgKyBcIm1heC13aWR0aDogbm9uZTtcIjtcblxuICAgICAgICBfdGhpczIuRE9NaW1nLnNldEF0dHJpYnV0ZShcInN0eWxlXCIsIGF0dHJpYnV0ZSk7IC8vIHByZXZlbnQgdG8gbW92ZSBpbWFnZSAod2lsbCBzaG93IHRoZSBlbnRpcmUgc3ByaXRlIHNoZWV0IGlmIG5vdCBjYXRjaGVkKVxuXG5cbiAgICAgICAgX3RoaXMyLkRPTWltZy5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ3N0YXJ0XCIsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgX3RoaXMyLmltYWdlVyA9IF90aGlzMi5zcHJpdGUud2lkdGggLyBfdGhpczIudGlsZXNYO1xuICAgICAgICBfdGhpczIuaW1hZ2VIID0gX3RoaXMyLnNwcml0ZS5oZWlnaHQgLyBfdGhpczIudGlsZXNZO1xuICAgICAgICBhdHRyaWJ1dGUgPSBcIndpZHRoOlwiICsgX3RoaXMyLmltYWdlVyArIFwicHg7XCIgKyBcImhlaWdodDpcIiArIF90aGlzMi5pbWFnZUggKyBcInB4O1wiICsgXCJwb3NpdGlvbjpmaXhlZDtcIiArIFwidG9wOlwiICsgX3RoaXMyLmltYWdlWSArIFwicHg7XCIgKyBcImxlZnQ6XCIgKyBfdGhpczIuaW1hZ2VYICsgXCJweDtcIiArIFwidHJhbnNmb3JtOnJvdGF0ZXkoMGRlZyk7XCIgKyBcImN1cnNvcjptb3ZlO1wiICsgXCJ6LWluZGV4OjIwMDA7XCIgKyBcIm92ZXJmbG93OmhpZGRlbjtcIjtcblxuICAgICAgICBfdGhpczIuRE9NZGl2LnNldEF0dHJpYnV0ZShcInN0eWxlXCIsIGF0dHJpYnV0ZSk7XG5cbiAgICAgICAgX3RoaXMyLkRPTWRpdi5hcHBlbmRDaGlsZChfdGhpczIuRE9NaW1nKTtcblxuICAgICAgICBpZiAoX3RoaXMyLmlzQ2hpbGQpIF90aGlzMi5fc3Bhd25DaGlsZCgpO2Vsc2UgX3RoaXMyLl9zcGF3bkVTaGVlcCgpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNwcml0ZS5zcmMgPSAnZGF0YTppbWFnZS9wbmc7YmFzZTY0LCcgKyBpbWFnZS5nZXRFbGVtZW50c0J5VGFnTmFtZShcInBuZ1wiKVswXS50ZXh0Q29udGVudDtcbiAgICAgIHRoaXMuRE9NaW1nLnNldEF0dHJpYnV0ZShcInNyY1wiLCB0aGlzLnNwcml0ZS5zcmMpOyAvLyBNb3VzZSBtb3ZlIG92ZXIgZVNoZWVwLCBjaGVjayBpZiBlU2hlZXAgc2hvdWxkIGJlIG1vdmVkIG92ZXIgdGhlIHNjcmVlblxuXG4gICAgICB0aGlzLkRPTWRpdi5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgIGlmICghX3RoaXMyLmRyYWdnaW5nICYmIGUuYnV0dG9ucyA9PSAxICYmIGUuYnV0dG9uID09IDApIHtcbiAgICAgICAgICBfdGhpczIuZHJhZ2dpbmcgPSB0cnVlO1xuICAgICAgICAgIF90aGlzMi5IVE1MZWxlbWVudCA9IG51bGw7XG5cbiAgICAgICAgICB2YXIgY2hpbGRzUm9vdCA9IF90aGlzMi54bWxEb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2FuaW1hdGlvbnMnKVswXTtcblxuICAgICAgICAgIHZhciBjaGlsZHMgPSBjaGlsZHNSb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhbmltYXRpb24nKTtcblxuICAgICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgY2hpbGRzLmxlbmd0aDsgaysrKSB7XG4gICAgICAgICAgICBpZiAoY2hpbGRzW2tdLmdldEVsZW1lbnRzQnlUYWdOYW1lKCduYW1lJylbMF0udGV4dENvbnRlbnQgPT0gXCJkcmFnXCIpIHtcbiAgICAgICAgICAgICAgX3RoaXMyLmFuaW1hdGlvbklkID0gY2hpbGRzW2tdLmdldEF0dHJpYnV0ZShcImlkXCIpO1xuICAgICAgICAgICAgICBfdGhpczIuYW5pbWF0aW9uU3RlcCA9IDA7XG4gICAgICAgICAgICAgIF90aGlzMi5hbmltYXRpb25Ob2RlID0gY2hpbGRzW2tdO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pOyAvLyBBZGQgZXZlbnQgbGlzdGVuZXIgdG8gYm9keSwgaWYgbW91c2UgbW92ZWQgdG9vIGZhc3Qgb3ZlciB0aGUgZHJhZ2dpbmcgZVNoZWVwXG5cbiAgICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlbW92ZVwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBpZiAoX3RoaXMyLmRyYWdnaW5nKSB7XG4gICAgICAgICAgX3RoaXMyLmltYWdlWCA9IHBhcnNlSW50KGUuY2xpZW50WCkgLSBfdGhpczIuaW1hZ2VXIC8gMjtcbiAgICAgICAgICBfdGhpczIuaW1hZ2VZID0gcGFyc2VJbnQoZS5jbGllbnRZKSAtIF90aGlzMi5pbWFnZUggLyAyO1xuICAgICAgICAgIF90aGlzMi5ET01kaXYuc3R5bGUubGVmdCA9IF90aGlzMi5pbWFnZVggKyBcInB4XCI7XG4gICAgICAgICAgX3RoaXMyLkRPTWRpdi5zdHlsZS50b3AgPSBfdGhpczIuaW1hZ2VZICsgXCJweFwiO1xuICAgICAgICAgIF90aGlzMi5ET01pbmZvLnN0eWxlLmxlZnQgPSBwYXJzZUludChfdGhpczIuaW1hZ2VYICsgX3RoaXMyLmltYWdlVyAvIDIpICsgXCJweFwiO1xuICAgICAgICAgIF90aGlzMi5ET01pbmZvLnN0eWxlLnRvcCA9IF90aGlzMi5pbWFnZVkgKyBcInB4XCI7XG4gICAgICAgIH1cbiAgICAgIH0pOyAvLyBXaW5kb3cgcmVzaXplZCwgcmVjYWxjdWxhdGUgZVNoZWVwIGJvdW5kc1xuXG4gICAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICBfdGhpczIuc2NyZWVuVyA9IHdpbmRvdy5pbm5lcldpZHRoIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCB8fCBkb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoO1xuICAgICAgICBfdGhpczIuc2NyZWVuSCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0IHx8IGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0O1xuXG4gICAgICAgIGlmIChfdGhpczIuaW1hZ2VZICsgX3RoaXMyLmltYWdlSCA+IF90aGlzMi5zY3JlZW5IKSB7XG4gICAgICAgICAgX3RoaXMyLmltYWdlWSA9IF90aGlzMi5zY3JlZW5IIC0gX3RoaXMyLmltYWdlSDtcbiAgICAgICAgICBfdGhpczIuRE9NZGl2LnN0eWxlLnRvcCA9IF90aGlzMi5pbWFnZVkgKyBcInB4XCI7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoX3RoaXMyLmltYWdlWCArIF90aGlzMi5pbWFnZVcgPiBfdGhpczIuc2NyZWVuVykge1xuICAgICAgICAgIF90aGlzMi5pbWFnZVggPSBfdGhpczIuc2NyZWVuVyAtIF90aGlzMi5pbWFnZVc7XG4gICAgICAgICAgX3RoaXMyLkRPTWRpdi5zdHlsZS5sZWZ0ID0gX3RoaXMyLmltYWdlWCArIFwicHhcIjtcbiAgICAgICAgfVxuICAgICAgfSk7IC8vIERvbid0IGFsbG93IGNvbnRleHRtZW51IG92ZXIgdGhlIHNoZWVwXG5cbiAgICAgIHRoaXMuRE9NZGl2LmFkZEV2ZW50TGlzdGVuZXIoXCJjb250ZXh0bWVudVwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0pOyAvLyBNb3VzZSByZWxlYXNlZFxuXG4gICAgICB0aGlzLkRPTWRpdi5hZGRFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBpZiAoX3RoaXMyLmRyYWdnaW5nKSB7XG4gICAgICAgICAgX3RoaXMyLmRyYWdnaW5nID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAoX3RoaXMyLmluZm9ib3gpIHtcbiAgICAgICAgICBfdGhpczIuRE9NaW5mby5IaWRlKCk7XG5cbiAgICAgICAgICBfdGhpczIuaW5mb2JveCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChfdGhpczIudXNlck9wdGlvbnMuYWxsb3dQb3B1cCA9PT0gXCJ5ZXNcIikge1xuICAgICAgICAgICAgX3RoaXMyLkRPTWluZm8uc3R5bGUubGVmdCA9IE1hdGgubWluKF90aGlzMi5zY3JlZW5XIC0gX3RoaXMyLmltYWdlVywgTWF0aC5tYXgoX3RoaXMyLmltYWdlVywgcGFyc2VJbnQoX3RoaXMyLmltYWdlWCArIF90aGlzMi5pbWFnZVcgLyAyKSkpICsgXCJweFwiO1xuICAgICAgICAgICAgX3RoaXMyLkRPTWluZm8uc3R5bGUudG9wID0gcGFyc2VJbnQoX3RoaXMyLmltYWdlWSkgKyBcInB4XCI7XG5cbiAgICAgICAgICAgIF90aGlzMi5ET01pbmZvLlNob3coKTtcblxuICAgICAgICAgICAgX3RoaXMyLmluZm9ib3ggPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7IC8vIE1vdXNlIHJlbGVhc2VkIG92ZXIgdGhlIGluZm8gYm94XG5cbiAgICAgIHRoaXMuRE9NaW5mby5hZGRFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBfdGhpczIuRE9NaW5mby5IaWRlKCk7XG5cbiAgICAgICAgX3RoaXMyLmluZm9ib3ggPSBmYWxzZTtcbiAgICAgIH0pOyAvLyBDcmVhdGUgQWJvdXQgYm94XG5cbiAgICAgIHZhciBhdHRyaWJ1dGUgPSBcIndpZHRoOjIwMHB4O1wiICsgXCJoZWlnaHQ6MTAwcHg7XCIgKyBcInRyYW5zZm9ybTp0cmFuc2xhdGUoLTUwJSwgLTUwJSkgc2NhbGUoMC4xKTtcIiArIFwicG9zaXRpb246Zml4ZWQ7XCIgKyBcInRvcDoxMDBweDtsZWZ0OjEwcHg7XCIgKyBcImRpc3BsYXk6bm9uZTtcIiArIFwiYm9yZGVyLXdpZHRoOjJweDtcIiArIFwiYm9yZGVyLXJhZGl1czo1cHg7XCIgKyBcImJvcmRlci1zdHlsZTpyaWRnZTtcIiArIFwiYm9yZGVyLWNvbG9yOiMwMDAwYWI7XCIgKyBcInRleHQtYWxpZ246Y2VudGVyO1wiICsgXCJ0ZXh0LXNoYWRvdzogMXB4IDFweCAzcHggI2ZmZmY4ODtcIiArIFwiYm94LXNoYWRvdzogM3B4IDNweCAxMHB4ICM4ODg4ODg7XCIgKyBcImNvbG9yOmJsYWNrO1wiICsgXCJvcGFjaXR5OjAuOTtcIiArIFwiei1pbmRleDo5OTk5O1wiICsgXCJvdmVyZmxvdzphdXRvO1wiICsgXCJ0cmFuc2l0aW9uOnRyYW5zZm9ybSAwLjNzIGVhc2U7XCIgKyBcImJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCh0byBib3R0b20gcmlnaHQsIHJnYmEoMTI4LDEyOCwyNTUsMC43KSwgcmdiYSgyMDAsMjAwLDI1NSwwLjQpKTtcIjtcbiAgICAgIHRoaXMuRE9NaW5mby5zZXRBdHRyaWJ1dGUoXCJzdHlsZVwiLCBhdHRyaWJ1dGUpO1xuICAgICAgdmFyIGhlYWRlck5vZGUgPSB0aGlzLnhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZGVyJylbMF07XG4gICAgICB2YXIgaHRtbFQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYlwiKS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShoZWFkZXJOb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0aXRsZScpWzBdLnRleHRDb250ZW50KSk7XG4gICAgICB2YXIgaHRtbFYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3VwXCIpO1xuICAgICAgdmFyIGh0bWxMID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIik7XG4gICAgICB2YXIgaHRtbFAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwicFwiKTtcbiAgICAgIGh0bWxWLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFwiQXBwIHYuXCIgKyBWRVJTSU9OKSk7XG4gICAgICBodG1sVi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnJcIikpO1xuICAgICAgaHRtbFYuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoXCJQZXQgdi5cIiArIGhlYWRlck5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3ZlcnNpb24nKVswXS50ZXh0Q29udGVudCkpO1xuICAgICAgaHRtbFYuc2V0QXR0cmlidXRlKFwic3R5bGVcIiwgXCJmbG9hdDpyaWdodDt0ZXh0LWFsaWduOnJpZ2h0O1wiKTtcbiAgICAgIGh0bWxMLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFwiXFx1RDgzQ1xcdURGRTBcIikpO1xuICAgICAgaHRtbEwuc2V0QXR0cmlidXRlKFwiaHJlZlwiLCBcImh0dHBzOi8vZ2l0aHViLmNvbS9BZHJpYW5vdGlnZXIvd2ViLWVzaGVlcFwiKTtcbiAgICAgIGh0bWxMLnNldEF0dHJpYnV0ZShcInRhcmdldFwiLCBcIl9ibGFua1wiKTtcbiAgICAgIGh0bWxMLnNldEF0dHJpYnV0ZShcInN0eWxlXCIsIFwiZmxvYXQ6bGVmdFwiKTtcbiAgICAgIGh0bWxQLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGhlYWRlck5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2luZm8nKVswXS50ZXh0Q29udGVudCkpO1xuICAgICAgaHRtbFAuc2V0QXR0cmlidXRlKFwic3R5bGVcIiwgXCJmb250LXNpemU6XCIgKyAoMTAwIC0gcGFyc2VJbnQoaGVhZGVyTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5mbycpWzBdLnRleHRDb250ZW50Lmxlbmd0aCAvIDEwKSkgKyBcIiU7XCIpO1xuICAgICAgdGhpcy5ET01pbmZvLmFwcGVuZENoaWxkKGh0bWxWKTtcbiAgICAgIHRoaXMuRE9NaW5mby5hcHBlbmRDaGlsZChodG1sTCk7XG5cbiAgICAgIGlmICh0aGlzLnVzZXJPcHRpb25zLmFsbG93UGV0cyAhPT0gXCJub25lXCIpIHtcbiAgICAgICAgaHRtbEwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYVwiKTtcbiAgICAgICAgaHRtbEwuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoXCJcXHUyNjk5XCIpKTtcbiAgICAgICAgaHRtbEwuc2V0QXR0cmlidXRlKFwiaHJlZlwiLCBcImphdmFzY3JpcHQ6O1wiKTtcbiAgICAgICAgaHRtbEwuc2V0QXR0cmlidXRlKFwic3R5bGVcIiwgXCJmbG9hdDpsZWZ0XCIpO1xuICAgICAgICB0aGlzLkRPTWluZm8uYXBwZW5kQ2hpbGQoaHRtbEwpO1xuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBfdGhpczIuX2xvYWRQZXRMaXN0KGh0bWxMKTtcbiAgICAgICAgfSwgMTAwKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5ET01pbmZvLmFwcGVuZENoaWxkKGh0bWxUKTtcbiAgICAgIHRoaXMuRE9NaW5mby5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnJcIikpO1xuICAgICAgdGhpcy5ET01pbmZvLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJoclwiKSk7XG4gICAgICB0aGlzLkRPTWluZm8uYXBwZW5kQ2hpbGQoaHRtbFApOyAvLyBBZGQgYWJvdXQgYW5kIHNoZWVwIGVsZW1lbnRzIHRvIHRoZSBib2R5XG5cbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5ET01pbmZvKTtcbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5ET01kaXYpO1xuXG4gICAgICB0aGlzLkRPTWluZm8uU2hvdyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgX3RoaXMyLkRPTWluZm8uc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcbiAgICAgICAgX3RoaXMyLkRPTWluZm8uc3R5bGUudHJhbnNmb3JtID0gXCJ0cmFuc2xhdGUoLTUwJSwgLTEwMCUpIHNjYWxlKDEuMClcIjtcbiAgICAgIH07XG5cbiAgICAgIHRoaXMuRE9NaW5mby5IaWRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBfdGhpczIuRE9NaW5mby5zdHlsZS50cmFuc2Zvcm0gPSBcInRyYW5zbGF0ZSgtNTAlLCAtNTAlKSBzY2FsZSgwLjEpXCI7XG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIF90aGlzMi5ET01pbmZvLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICAgICAgfSwgMzAwKTtcbiAgICAgIH07XG4gICAgfVxuICB9LCB7XG4gICAga2V5OiBcIl9zZXRQb3NpdGlvblwiLFxuXG4gICAgLypcclxuICAgICAqIFNldCBuZXcgcG9zaXRpb24gZm9yIHRoZSBwZXRcclxuICAgICAqIElmIGFic29sdXRlIGlzIHRydWUsIHRoZSB4IGFuZCB5IGNvb3JkaW5hdGVzIGFyZSB1c2VkIGFzIGFic29sdXRlIHZhbHVlcy5cclxuICAgICAqIElmIGZhbHNlLCB4IGFuZCB5IGFyZSBhZGRlZCB0byB0aGUgY3VycmVudCBwb3NpdGlvblxyXG4gICAgICovXG4gICAgdmFsdWU6IGZ1bmN0aW9uIF9zZXRQb3NpdGlvbih4LCB5LCBhYnNvbHV0ZSkge1xuICAgICAgaWYgKHRoaXMuRE9NZGl2KSB7XG4gICAgICAgIGlmIChhYnNvbHV0ZSkge1xuICAgICAgICAgIHRoaXMuaW1hZ2VYID0gcGFyc2VJbnQoeCk7XG4gICAgICAgICAgdGhpcy5pbWFnZVkgPSBwYXJzZUludCh5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmltYWdlWCA9IHBhcnNlSW50KHRoaXMuaW1hZ2VYKSArIHBhcnNlSW50KHgpO1xuICAgICAgICAgIHRoaXMuaW1hZ2VZID0gcGFyc2VJbnQodGhpcy5pbWFnZVkpICsgcGFyc2VJbnQoeSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLkRPTWRpdi5zdHlsZS5sZWZ0ID0gdGhpcy5pbWFnZVggKyBcInB4XCI7XG4gICAgICAgIHRoaXMuRE9NZGl2LnN0eWxlLnRvcCA9IHRoaXMuaW1hZ2VZICsgXCJweFwiO1xuICAgICAgfVxuICAgIH1cbiAgICAvKlxyXG4gICAgICogU3Bhd24gbmV3IGVzaGVlcCwgdGhpcyBpcyBjYWxsZWQgaWYgdGhlIFhNTCB3YXMgbG9hZGVkIHN1Y2Nlc3NmdWxseVxyXG4gICAgICovXG5cbiAgfSwge1xuICAgIGtleTogXCJfc3Bhd25FU2hlZXBcIixcbiAgICB2YWx1ZTogZnVuY3Rpb24gX3NwYXduRVNoZWVwKCkge1xuICAgICAgdmFyIHNwYXduc1Jvb3QgPSB0aGlzLnhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc3Bhd25zJylbMF07XG4gICAgICB2YXIgc3Bhd25zID0gc3Bhd25zUm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc3Bhd24nKTtcbiAgICAgIHZhciBwcm9iID0gMDtcblxuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGF3bnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcHJvYiArPSBwYXJzZUludChzcGF3bnNbMF0uZ2V0QXR0cmlidXRlKFwicHJvYmFiaWxpdHlcIikpO1xuICAgICAgfVxuXG4gICAgICB2YXIgcmFuZCA9IE1hdGgucmFuZG9tKCkgKiBwcm9iO1xuICAgICAgcHJvYiA9IDA7XG5cbiAgICAgIGZvciAoaSA9IDA7IGkgPCBzcGF3bnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcHJvYiArPSBwYXJzZUludChzcGF3bnNbaV0uZ2V0QXR0cmlidXRlKFwicHJvYmFiaWxpdHlcIikpO1xuXG4gICAgICAgIGlmIChwcm9iID49IHJhbmQgfHwgaSA9PSBzcGF3bnMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgIHRoaXMuX3NldFBvc2l0aW9uKHRoaXMuX3BhcnNlS2V5V29yZHMoc3Bhd25zW2ldLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd4JylbMF0udGV4dENvbnRlbnQpLCB0aGlzLl9wYXJzZUtleVdvcmRzKHNwYXduc1tpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgneScpWzBdLnRleHRDb250ZW50KSwgdHJ1ZSk7XG5cbiAgICAgICAgICBpZiAoQUNUSVZBVEVfREVCVUcpIGNvbnNvbGUubG9nKFwiU3Bhd246IFwiICsgdGhpcy5pbWFnZVggKyBcIiwgXCIgKyB0aGlzLmltYWdlWSk7XG4gICAgICAgICAgdGhpcy5hbmltYXRpb25JZCA9IHNwYXduc1tpXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbmV4dCcpWzBdLnRleHRDb250ZW50O1xuICAgICAgICAgIHRoaXMuYW5pbWF0aW9uU3RlcCA9IDA7XG4gICAgICAgICAgdmFyIGNoaWxkc1Jvb3QgPSB0aGlzLnhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYW5pbWF0aW9ucycpWzBdO1xuICAgICAgICAgIHZhciBjaGlsZHMgPSBjaGlsZHNSb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhbmltYXRpb24nKTtcblxuICAgICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgY2hpbGRzLmxlbmd0aDsgaysrKSB7XG4gICAgICAgICAgICBpZiAoY2hpbGRzW2tdLmdldEF0dHJpYnV0ZShcImlkXCIpID09IHRoaXMuYW5pbWF0aW9uSWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5hbmltYXRpb25Ob2RlID0gY2hpbGRzW2tdOyAvLyBDaGVjayBpZiBjaGlsZCBzaG91bGQgYmUgbG9hZGVkIHRvZ2hldGhlciB3aXRoIHRoaXMgYW5pbWF0aW9uXG5cbiAgICAgICAgICAgICAgdmFyIGNoaWxkc1Jvb3QgPSB0aGlzLnhtbERvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnY2hpbGRzJylbMF07XG4gICAgICAgICAgICAgIHZhciBjaGlsZHMgPSBjaGlsZHNSb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdjaGlsZCcpO1xuXG4gICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY2hpbGRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkc1tqXS5nZXRBdHRyaWJ1dGUoXCJhbmltYXRpb25pZFwiKSA9PSB0aGlzLmFuaW1hdGlvbklkKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoQUNUSVZBVEVfREVCVUcpIGNvbnNvbGUubG9nKFwiQ2hpbGQgZnJvbSBTcGF3blwiKTtcbiAgICAgICAgICAgICAgICAgIHZhciBlU2hlZXBDaGlsZCA9IG5ldyBlU2hlZXAobnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICBlU2hlZXBDaGlsZC5hbmltYXRpb25JZCA9IGNoaWxkc1tqXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbmV4dCcpWzBdLnRleHRDb250ZW50O1xuICAgICAgICAgICAgICAgICAgdmFyIHggPSBjaGlsZHNbal0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3gnKVswXS50ZXh0Q29udGVudDsgLy9cblxuICAgICAgICAgICAgICAgICAgdmFyIHkgPSBjaGlsZHNbal0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3knKVswXS50ZXh0Q29udGVudDtcblxuICAgICAgICAgICAgICAgICAgZVNoZWVwQ2hpbGQuX3NldFBvc2l0aW9uKHRoaXMuX3BhcnNlS2V5V29yZHMoeCksIHRoaXMuX3BhcnNlS2V5V29yZHMoeSksIHRydWUpOyAvLyBTdGFydCBhbmltYXRpb25cblxuXG4gICAgICAgICAgICAgICAgICBlU2hlZXBDaGlsZC5TdGFydCh0aGlzLmFuaW1hdGlvbkZpbGUpO1xuICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH0gLy8gUGxheSBuZXh0IHN0ZXBcblxuXG4gICAgICB0aGlzLl9uZXh0RVNoZWVwU3RlcCgpO1xuICAgIH1cbiAgICAvKlxyXG4gICAgICogTGlrZSBzcGF3bkVTaGVlcCwgYnV0IGZvciBDaGlsZHNcclxuICAgICAqL1xuXG4gIH0sIHtcbiAgICBrZXk6IFwiX3NwYXduQ2hpbGRcIixcbiAgICB2YWx1ZTogZnVuY3Rpb24gX3NwYXduQ2hpbGQoKSB7XG4gICAgICB2YXIgY2hpbGRzUm9vdCA9IHRoaXMueG1sRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhbmltYXRpb25zJylbMF07XG4gICAgICB2YXIgY2hpbGRzID0gY2hpbGRzUm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYW5pbWF0aW9uJyk7XG5cbiAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgY2hpbGRzLmxlbmd0aDsgaysrKSB7XG4gICAgICAgIGlmIChjaGlsZHNba10uZ2V0QXR0cmlidXRlKFwiaWRcIikgPT0gdGhpcy5hbmltYXRpb25JZCkge1xuICAgICAgICAgIHRoaXMuYW5pbWF0aW9uTm9kZSA9IGNoaWxkc1trXTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLl9uZXh0RVNoZWVwU3RlcCgpO1xuICAgIH0gLy8gUGFyc2UgdGhlIGh1bWFuIHJlYWRhYmxlIGV4cHJlc3Npb24gZnJvbSBYTUwgdG8gYSBjb21wdXRlciByZWFkYWJsZSBleHByZXNzaW9uXG5cbiAgfSwge1xuICAgIGtleTogXCJfcGFyc2VLZXlXb3Jkc1wiLFxuICAgIHZhbHVlOiBmdW5jdGlvbiBfcGFyc2VLZXlXb3Jkcyh2YWx1ZSkge1xuICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9zY3JlZW5XL2csIHRoaXMuc2NyZWVuVyk7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL3NjcmVlbkgvZywgdGhpcy5zY3JlZW5IKTtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvYXJlYVcvZywgdGhpcy5zY3JlZW5IKTtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvYXJlYUgvZywgdGhpcy5zY3JlZW5IKTtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvaW1hZ2VXL2csIHRoaXMuaW1hZ2VXKTtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvaW1hZ2VIL2csIHRoaXMuaW1hZ2VIKTtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvcmFuZG9tL2csIE1hdGgucmFuZG9tKCkgKiAxMDApO1xuICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9yYW5kUy9nLCB0aGlzLnJhbmRTKTtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvaW1hZ2VYL2csIHRoaXMuaW1hZ2VYKTtcbiAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvaW1hZ2VZL2csIHRoaXMuaW1hZ2VZKTtcbiAgICAgIHZhciByZXQgPSAwO1xuXG4gICAgICB0cnkge1xuICAgICAgICByZXQgPSBldmFsKHZhbHVlKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiVW5hYmxlIHRvIHBhcnNlIHRoaXMgcG9zaXRpb246IFxcbidcIiArIHZhbHVlICsgXCInXFxuIEVycm9yIG1lc3NhZ2U6IFxcblwiICsgZXJyLm1lc3NhZ2UpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICAvKlxyXG4gICAgICogT25jZSB0aGUgYW5pbWF0aW9uIGlzIG92ZXIsIGdldCB0aGUgbmV4dCBhbmltYXRpb24gdG8gcGxheVxyXG4gICAgICovXG5cbiAgfSwge1xuICAgIGtleTogXCJfZ2V0TmV4dFJhbmRvbU5vZGVcIixcbiAgICB2YWx1ZTogZnVuY3Rpb24gX2dldE5leHRSYW5kb21Ob2RlKHBhcmVudE5vZGUpIHtcbiAgICAgIHZhciBiYXNlTm9kZSA9IHBhcmVudE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ25leHQnKTtcbiAgICAgIHZhciBjaGlsZHNSb290ID0gdGhpcy54bWxEb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2FuaW1hdGlvbnMnKVswXTtcbiAgICAgIHZhciBjaGlsZHMgPSBjaGlsZHNSb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhbmltYXRpb24nKTtcbiAgICAgIHZhciBwcm9iID0gMDtcbiAgICAgIHZhciBub2RlRm91bmQgPSBmYWxzZTsgLy8gbm8gbW9yZSBhbmltYXRpb25zIChpdCB3YXMgdGhlIGxhc3Qgb25lKVxuXG4gICAgICBpZiAoYmFzZU5vZGUubGVuZ3RoID09IDApIHtcbiAgICAgICAgLy8gSWYgaXQgaXMgYSBjaGlsZCwgcmVtb3ZlIHRoZSBjaGlsZCBmcm9tIGRvY3VtZW50XG4gICAgICAgIGlmICh0aGlzLmlzQ2hpbGQpIHtcbiAgICAgICAgICAvLyByZW1vdmUgY2hpbGRcbiAgICAgICAgICBpZiAoQUNUSVZBVEVfREVCVUcpIGNvbnNvbGUubG9nKFwiUmVtb3ZlIGNoaWxkXCIpO1xuICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5ET01pbmZvKTtcbiAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuRE9NZGl2KTtcbiAgICAgICAgICBkZWxldGUgdGhpcztcbiAgICAgICAgfSAvLyBlbHNlLCBzcGF3biBzaGVlcCBhZ2FpblxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3NwYXduRVNoZWVwKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBiYXNlTm9kZS5sZW5ndGg7IGsrKykge1xuICAgICAgICBwcm9iICs9IHBhcnNlSW50KGJhc2VOb2RlW2tdLmdldEF0dHJpYnV0ZShcInByb2JhYmlsaXR5XCIpKTtcbiAgICAgIH1cblxuICAgICAgdmFyIHJhbmQgPSBNYXRoLnJhbmRvbSgpICogcHJvYjtcbiAgICAgIHZhciBpbmRleCA9IDA7XG4gICAgICBwcm9iID0gMDtcblxuICAgICAgZm9yIChrID0gMDsgayA8IGJhc2VOb2RlLmxlbmd0aDsgaysrKSB7XG4gICAgICAgIHByb2IgKz0gcGFyc2VJbnQoYmFzZU5vZGVba10uZ2V0QXR0cmlidXRlKFwicHJvYmFiaWxpdHlcIikpO1xuXG4gICAgICAgIGlmIChwcm9iID49IHJhbmQpIHtcbiAgICAgICAgICBpbmRleCA9IGs7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZm9yIChrID0gMDsgayA8IGNoaWxkcy5sZW5ndGg7IGsrKykge1xuICAgICAgICBpZiAoY2hpbGRzW2tdLmdldEF0dHJpYnV0ZShcImlkXCIpID09IGJhc2VOb2RlW2luZGV4XS50ZXh0Q29udGVudCkge1xuICAgICAgICAgIHRoaXMuYW5pbWF0aW9uSWQgPSBjaGlsZHNba10uZ2V0QXR0cmlidXRlKFwiaWRcIik7XG4gICAgICAgICAgdGhpcy5hbmltYXRpb25TdGVwID0gMDtcbiAgICAgICAgICB0aGlzLmFuaW1hdGlvbk5vZGUgPSBjaGlsZHNba107XG4gICAgICAgICAgbm9kZUZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAobm9kZUZvdW5kKSAvLyBjcmVhdGUgQ2hpbGQsIGlmIHByZXNlbnRcbiAgICAgICAge1xuICAgICAgICAgIHZhciBjaGlsZHNSb290ID0gdGhpcy54bWxEb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2NoaWxkcycpWzBdO1xuICAgICAgICAgIHZhciBjaGlsZHMgPSBjaGlsZHNSb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdjaGlsZCcpO1xuXG4gICAgICAgICAgZm9yIChrID0gMDsgayA8IGNoaWxkcy5sZW5ndGg7IGsrKykge1xuICAgICAgICAgICAgaWYgKGNoaWxkc1trXS5nZXRBdHRyaWJ1dGUoXCJhbmltYXRpb25pZFwiKSA9PSB0aGlzLmFuaW1hdGlvbklkKSB7XG4gICAgICAgICAgICAgIGlmIChBQ1RJVkFURV9ERUJVRykgY29uc29sZS5sb2coXCJDaGlsZCBmcm9tIEFuaW1hdGlvblwiKTtcbiAgICAgICAgICAgICAgdmFyIGVTaGVlcENoaWxkID0gbmV3IGVTaGVlcChudWxsLCB0cnVlKTtcbiAgICAgICAgICAgICAgZVNoZWVwQ2hpbGQuYW5pbWF0aW9uSWQgPSBjaGlsZHNba10uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ25leHQnKVswXS50ZXh0Q29udGVudDtcbiAgICAgICAgICAgICAgdmFyIHggPSBjaGlsZHNba10uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3gnKVswXS50ZXh0Q29udGVudDsgLy9cblxuICAgICAgICAgICAgICB2YXIgeSA9IGNoaWxkc1trXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgneScpWzBdLnRleHRDb250ZW50O1xuXG4gICAgICAgICAgICAgIGVTaGVlcENoaWxkLl9zZXRQb3NpdGlvbih0aGlzLl9wYXJzZUtleVdvcmRzKHgpLCB0aGlzLl9wYXJzZUtleVdvcmRzKHkpLCB0cnVlKTtcblxuICAgICAgICAgICAgICBlU2hlZXBDaGlsZC5TdGFydCh0aGlzLmFuaW1hdGlvbkZpbGUpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgcmV0dXJuIG5vZGVGb3VuZDtcbiAgICB9XG4gICAgLypcclxuICAgICAqIENoZWNrIGlmIHNoZWVwIGlzIHdhbGtpbmcgb3ZlciBhIGRlZmluZWQgSFRNTCBUQUctZWxlbWVudFxyXG4gICAgICovXG5cbiAgfSwge1xuICAgIGtleTogXCJfY2hlY2tPdmVybGFwcGluZ1wiLFxuICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hlY2tPdmVybGFwcGluZygpIHtcbiAgICAgIHZhciB4ID0gdGhpcy5pbWFnZVg7XG4gICAgICB2YXIgeSA9IHRoaXMuaW1hZ2VZICsgdGhpcy5pbWFnZUg7XG4gICAgICB2YXIgcmVjdDtcbiAgICAgIHZhciBtYXJnaW4gPSAyMDtcbiAgICAgIGlmICh0aGlzLkhUTUxlbGVtZW50KSBtYXJnaW4gPSA1O1xuXG4gICAgICBmb3IgKHZhciBpbmRleCBpbiBDT0xMSVNJT05fV0lUSCkge1xuICAgICAgICB2YXIgZWxzID0gZG9jdW1lbnQuYm9keS5nZXRFbGVtZW50c0J5VGFnTmFtZShDT0xMSVNJT05fV0lUSFtpbmRleF0pO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgcmVjdCA9IGVsc1tpXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgICAgIGlmICh5ID4gcmVjdC50b3AgLSAyICYmIHkgPCByZWN0LnRvcCArIG1hcmdpbikge1xuICAgICAgICAgICAgaWYgKHggPiByZWN0LmxlZnQgJiYgeCA8IHJlY3QucmlnaHQgLSB0aGlzLmltYWdlVykge1xuICAgICAgICAgICAgICB2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbHNbaV0pO1xuXG4gICAgICAgICAgICAgIGlmIChzdHlsZS5ib3JkZXJUb3BTdHlsZSAhPSBcIlwiICYmIHN0eWxlLmJvcmRlclRvcFN0eWxlICE9IFwibm9uZVwiICYmIHN0eWxlLmRpc3BsYXkgIT0gXCJub25lXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZWxzW2ldO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgLypcclxuICAgICAqIFRyeSB0byBnZXQgdGhlIHZhbHVlIG9mIGEgbm9kZSAoZnJvbSB0aGUgY3VycmVudCBhbmltYXRpb25Ob2RlKSwgaWYgaXQgaXMgbm90IHBvc3NpYmxlIHJldHVybnMgdGhlIGRlZmF1bHRWYWx1ZVxyXG4gICAgICovXG5cbiAgfSwge1xuICAgIGtleTogXCJfZ2V0Tm9kZVZhbHVlXCIsXG4gICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXROb2RlVmFsdWUobm9kZU5hbWUsIHZhbHVlTmFtZSwgZGVmYXVsdFZhbHVlKSB7XG4gICAgICBpZiAoIXRoaXMuYW5pbWF0aW9uTm9kZSB8fCAhdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKG5vZGVOYW1lKSkgcmV0dXJuO1xuXG4gICAgICBpZiAodGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKG5vZGVOYW1lKVswXS5nZXRFbGVtZW50c0J5VGFnTmFtZSh2YWx1ZU5hbWUpWzBdKSB7XG4gICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZShub2RlTmFtZSlbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUodmFsdWVOYW1lKVswXS50ZXh0Q29udGVudDtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlS2V5V29yZHModmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgLypcclxuICAgICAqIE5leHQgc3RlcCAoZWFjaCBmcmFtZSBpcyBhIHN0ZXApXHJcbiAgICAgKi9cblxuICB9LCB7XG4gICAga2V5OiBcIl9uZXh0RVNoZWVwU3RlcFwiLFxuICAgIHZhbHVlOiBmdW5jdGlvbiBfbmV4dEVTaGVlcFN0ZXAoKSB7XG4gICAgICBpZiAodGhpcy5wcmVwYXJlVG9EaWUpIHJldHVybjtcblxuICAgICAgdmFyIHgxID0gdGhpcy5fZ2V0Tm9kZVZhbHVlKCdzdGFydCcsICd4JywgMCk7XG5cbiAgICAgIHZhciB5MSA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnc3RhcnQnLCAneScsIDApO1xuXG4gICAgICB2YXIgb2ZmMSA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnc3RhcnQnLCAnb2Zmc2V0eScsIDApO1xuXG4gICAgICB2YXIgb3BhMSA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnc3RhcnQnLCAnb3BhY2l0eScsIDEpO1xuXG4gICAgICB2YXIgZGVsMSA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnc3RhcnQnLCAnaW50ZXJ2YWwnLCAxMDAwKTtcblxuICAgICAgdmFyIHgyID0gdGhpcy5fZ2V0Tm9kZVZhbHVlKCdlbmQnLCAneCcsIDApO1xuXG4gICAgICB2YXIgeTIgPSB0aGlzLl9nZXROb2RlVmFsdWUoJ2VuZCcsICd5JywgMCk7XG5cbiAgICAgIHZhciBvZmYyID0gdGhpcy5fZ2V0Tm9kZVZhbHVlKCdlbmQnLCAnb2Zmc2V0eScsIDApO1xuXG4gICAgICB2YXIgb3BhMiA9IHRoaXMuX2dldE5vZGVWYWx1ZSgnZW5kJywgJ2ludGVydmFsJywgMSk7XG5cbiAgICAgIHZhciBkZWwyID0gdGhpcy5fZ2V0Tm9kZVZhbHVlKCdlbmQnLCAnaW50ZXJ2YWwnLCAxMDAwKTtcblxuICAgICAgdmFyIHJlcGVhdCA9IHRoaXMuX3BhcnNlS2V5V29yZHModGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzZXF1ZW5jZScpWzBdLmdldEF0dHJpYnV0ZSgncmVwZWF0JykpO1xuXG4gICAgICB2YXIgcmVwZWF0ZnJvbSA9IHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2VxdWVuY2UnKVswXS5nZXRBdHRyaWJ1dGUoJ3JlcGVhdGZyb20nKTtcbiAgICAgIHZhciBncmF2aXR5ID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdncmF2aXR5Jyk7XG4gICAgICB2YXIgYm9yZGVyID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib3JkZXInKTtcbiAgICAgIHZhciBzdGVwcyA9IHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZnJhbWUnKS5sZW5ndGggKyAodGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmcmFtZScpLmxlbmd0aCAtIHJlcGVhdGZyb20pICogcmVwZWF0O1xuICAgICAgdmFyIGluZGV4O1xuICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uU3RlcCA8IHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZnJhbWUnKS5sZW5ndGgpIGluZGV4ID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmcmFtZScpW3RoaXMuYW5pbWF0aW9uU3RlcF0udGV4dENvbnRlbnQ7ZWxzZSBpZiAocmVwZWF0ZnJvbSA9PSAwKSBpbmRleCA9IHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZnJhbWUnKVt0aGlzLmFuaW1hdGlvblN0ZXAgJSB0aGlzLmFuaW1hdGlvbk5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ZyYW1lJykubGVuZ3RoXS50ZXh0Q29udGVudDtlbHNlIGluZGV4ID0gdGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmcmFtZScpW3BhcnNlSW50KHJlcGVhdGZyb20pICsgcGFyc2VJbnQoKHRoaXMuYW5pbWF0aW9uU3RlcCAtIHJlcGVhdGZyb20pICUgKHRoaXMuYW5pbWF0aW9uTm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZnJhbWUnKS5sZW5ndGggLSByZXBlYXRmcm9tKSldLnRleHRDb250ZW50O1xuICAgICAgdGhpcy5ET01pbWcuc3R5bGUubGVmdCA9IC10aGlzLmltYWdlVyAqIChpbmRleCAlIHRoaXMudGlsZXNYKSArIFwicHhcIjtcbiAgICAgIHRoaXMuRE9NaW1nLnN0eWxlLnRvcCA9IC10aGlzLmltYWdlSCAqIHBhcnNlSW50KGluZGV4IC8gdGhpcy50aWxlc1gpICsgXCJweFwiO1xuXG4gICAgICBpZiAodGhpcy5kcmFnZ2luZyB8fCB0aGlzLmluZm9ib3gpIHtcbiAgICAgICAgdGhpcy5hbmltYXRpb25TdGVwKys7XG4gICAgICAgIHNldFRpbWVvdXQodGhpcy5fbmV4dEVTaGVlcFN0ZXAuYmluZCh0aGlzKSwgNTApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmZsaXBwZWQpIHtcbiAgICAgICAgeDEgPSAteDE7XG4gICAgICAgIHgyID0gLXgyO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5hbmltYXRpb25TdGVwID09IDApIHRoaXMuX3NldFBvc2l0aW9uKHgxLCB5MSwgZmFsc2UpO2Vsc2UgdGhpcy5fc2V0UG9zaXRpb24ocGFyc2VJbnQoeDEpICsgcGFyc2VJbnQoKHgyIC0geDEpICogdGhpcy5hbmltYXRpb25TdGVwIC8gc3RlcHMpLCBwYXJzZUludCh5MSkgKyBwYXJzZUludCgoeTIgLSB5MSkgKiB0aGlzLmFuaW1hdGlvblN0ZXAgLyBzdGVwcyksIGZhbHNlKTtcbiAgICAgIHRoaXMuYW5pbWF0aW9uU3RlcCsrO1xuXG4gICAgICBpZiAodGhpcy5hbmltYXRpb25TdGVwID49IHN0ZXBzKSB7XG4gICAgICAgIGlmICh0aGlzLmFuaW1hdGlvbk5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2FjdGlvbicpWzBdKSB7XG4gICAgICAgICAgc3dpdGNoICh0aGlzLmFuaW1hdGlvbk5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2FjdGlvbicpWzBdLnRleHRDb250ZW50KSB7XG4gICAgICAgICAgICBjYXNlIFwiZmxpcFwiOlxuICAgICAgICAgICAgICBpZiAodGhpcy5ET01kaXYuc3R5bGUudHJhbnNmb3JtID09IFwicm90YXRlWSgwZGVnKVwiKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ET01kaXYuc3R5bGUudHJhbnNmb3JtID0gXCJyb3RhdGVZKDE4MGRlZylcIjtcbiAgICAgICAgICAgICAgICB0aGlzLmZsaXBwZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuRE9NZGl2LnN0eWxlLnRyYW5zZm9ybSA9IFwicm90YXRlWSgwZGVnKVwiO1xuICAgICAgICAgICAgICAgIHRoaXMuZmxpcHBlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5fZ2V0TmV4dFJhbmRvbU5vZGUodGhpcy5hbmltYXRpb25Ob2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzZXF1ZW5jZScpWzBdKSkgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB2YXIgc2V0TmV4dCA9IGZhbHNlO1xuXG4gICAgICBpZiAoYm9yZGVyICYmIGJvcmRlclswXSAmJiBib3JkZXJbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ25leHQnKSkge1xuICAgICAgICBpZiAoeDIgPCAwICYmIHRoaXMuaW1hZ2VYIDwgMCkge1xuICAgICAgICAgIHRoaXMuaW1hZ2VYID0gMDtcbiAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh4MiA+IDAgJiYgdGhpcy5pbWFnZVggPiB0aGlzLnNjcmVlblcgLSB0aGlzLmltYWdlVykge1xuICAgICAgICAgIHRoaXMuaW1hZ2VYID0gdGhpcy5zY3JlZW5XIC0gdGhpcy5pbWFnZVc7XG4gICAgICAgICAgdGhpcy5ET01kaXYuc3R5bGUubGVmdCA9IHBhcnNlSW50KHRoaXMuaW1hZ2VYKSArIFwicHhcIjtcbiAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh5MiA8IDAgJiYgdGhpcy5pbWFnZVkgPCAwKSB7XG4gICAgICAgICAgdGhpcy5pbWFnZVkgPSAwO1xuICAgICAgICAgIHNldE5leHQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHkyID4gMCAmJiB0aGlzLmltYWdlWSA+IHRoaXMuc2NyZWVuSCAtIHRoaXMuaW1hZ2VIKSB7XG4gICAgICAgICAgdGhpcy5pbWFnZVkgPSB0aGlzLnNjcmVlbkggLSB0aGlzLmltYWdlSDtcbiAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh5MiA+IDApIHtcbiAgICAgICAgICBpZiAodGhpcy5fY2hlY2tPdmVybGFwcGluZygpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pbWFnZVkgPiB0aGlzLmltYWdlSCkge1xuICAgICAgICAgICAgICB0aGlzLkhUTUxlbGVtZW50ID0gdGhpcy5fY2hlY2tPdmVybGFwcGluZygpO1xuICAgICAgICAgICAgICB0aGlzLmltYWdlWSA9IE1hdGguY2VpbCh0aGlzLkhUTUxlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCkgLSB0aGlzLmltYWdlSDtcbiAgICAgICAgICAgICAgc2V0TmV4dCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuSFRNTGVsZW1lbnQpIHtcbiAgICAgICAgICBpZiAoIXRoaXMuX2NoZWNrT3ZlcmxhcHBpbmcoKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuaW1hZ2VZICsgdGhpcy5pbWFnZUggPiB0aGlzLkhUTUxlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCArIDMgfHwgdGhpcy5pbWFnZVkgKyB0aGlzLmltYWdlSCA8IHRoaXMuSFRNTGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wIC0gMykge1xuICAgICAgICAgICAgICB0aGlzLkhUTUxlbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbWFnZVggPCB0aGlzLkhUTUxlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQpIHtcbiAgICAgICAgICAgICAgdGhpcy5pbWFnZVggPSBwYXJzZUludCh0aGlzLmltYWdlWCArIDMpO1xuICAgICAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMuaW1hZ2VYID0gcGFyc2VJbnQodGhpcy5pbWFnZVggLSAzKTtcbiAgICAgICAgICAgICAgc2V0TmV4dCA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuRE9NZGl2LnN0eWxlLmxlZnQgPSBwYXJzZUludCh0aGlzLmltYWdlWCkgKyBcInB4XCI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHNldE5leHQpIHtcbiAgICAgICAgICBpZiAoIXRoaXMuX2dldE5leHRSYW5kb21Ob2RlKGJvcmRlclswXSkpIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoIXNldE5leHQgJiYgZ3Jhdml0eSAmJiBncmF2aXR5WzBdICYmIGdyYXZpdHlbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ25leHQnKSkge1xuICAgICAgICBpZiAodGhpcy5pbWFnZVkgPCB0aGlzLnNjcmVlbkggLSB0aGlzLmltYWdlSCAtIDIpIHtcbiAgICAgICAgICBpZiAodGhpcy5IVE1MZWxlbWVudCA9PSBudWxsKSB7XG4gICAgICAgICAgICBzZXROZXh0ID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCF0aGlzLl9jaGVja092ZXJsYXBwaW5nKCkpIHtcbiAgICAgICAgICAgICAgc2V0TmV4dCA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMuSFRNTGVsZW1lbnQgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChzZXROZXh0KSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX2dldE5leHRSYW5kb21Ob2RlKGdyYXZpdHlbMF0pKSByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICghc2V0TmV4dCkge1xuICAgICAgICBpZiAodGhpcy5pbWFnZVggPCAtdGhpcy5pbWFnZVcgJiYgeDIgPCAwIHx8IHRoaXMuaW1hZ2VYID4gdGhpcy5zY3JlZW5XICYmIHgyID4gMCB8fCB0aGlzLmltYWdlWSA8IC10aGlzLmltYWdlSCAmJiB5MSA8IDAgfHwgdGhpcy5pbWFnZVkgPiB0aGlzLnNjcmVlbkggJiYgeTIgPiAwKSB7XG4gICAgICAgICAgc2V0TmV4dCA9IHRydWU7XG5cbiAgICAgICAgICBpZiAoIXRoaXMuaXNDaGlsZCkge1xuICAgICAgICAgICAgdGhpcy5fc3Bhd25FU2hlZXAoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgc2V0VGltZW91dCh0aGlzLl9uZXh0RVNoZWVwU3RlcC5iaW5kKHRoaXMpLCBwYXJzZUludChkZWwxKSArIHBhcnNlSW50KChkZWwyIC0gZGVsMSkgKiB0aGlzLmFuaW1hdGlvblN0ZXAgLyBzdGVwcykpO1xuICAgIH1cbiAgICAvKlxyXG4gICAgICogTG9hZCBQZXQgTGlzdCBmcm9tIEdpdEh1Yiwgc28gdXNlciBjYW4gY2hhbmdlIGl0XHJcbiAgICAgKi9cblxuICB9LCB7XG4gICAga2V5OiBcIl9sb2FkUGV0TGlzdFwiLFxuICAgIHZhbHVlOiBmdW5jdGlvbiBfbG9hZFBldExpc3QoZWxlbWVudCkge1xuICAgICAgdmFyIF90aGlzMyA9IHRoaXM7XG5cbiAgICAgIGZldGNoKFwiaHR0cHM6Ly9hZHJpYW5vdGlnZXIuZ2l0aHViLmlvL2Rlc2t0b3BQZXQvUGV0cy9wZXRzLmpzb25cIiwge1xuICAgICAgICBjcmVkZW50aWFsczogJ3NhbWUtb3JpZ2luJyxcbiAgICAgICAgY2FjaGU6IFwiZm9yY2UtY2FjaGVcIlxuICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGpzb24pIHtcbiAgICAgICAgY29uc29sZS5sb2coanNvbik7XG5cbiAgICAgICAgaWYgKGpzb24ucGV0cykge1xuICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgICAgIGRpdi5zZXRBdHRyaWJ1dGUoXCJzdHlsZVwiLCBcInBvc2l0aW9uOmFic29sdXRlO2xlZnQ6MHB4O3RvcDoyMHB4O3dpZHRoOjE4M3B4O21pbi1oZWlnaHQ6MTAwcHg7YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQodG8gYm90dG9tLCAjODA4MGZmLCAjMzAzMGExKTtjb2xvcjp5ZWxsb3c7XCIpO1xuICAgICAgICAgICAgZWxlbWVudC5wYXJlbnROb2RlLmFwcGVuZENoaWxkKGRpdik7XG5cbiAgICAgICAgICAgIHZhciBfbG9vcCA9IGZ1bmN0aW9uIF9sb29wKGspIHtcbiAgICAgICAgICAgICAgcGV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJcIik7XG4gICAgICAgICAgICAgIHBldC5zZXRBdHRyaWJ1dGUoXCJzdHlsZVwiLCBcImN1cnNvcjpwb2ludGVyO2Rpc3BsYXk6YmxvY2s7XCIpO1xuICAgICAgICAgICAgICBwZXQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoanNvbi5wZXRzW2tdLmZvbGRlcikpO1xuICAgICAgICAgICAgICBwZXQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgeCA9IG5ldyBlU2hlZXAoX3RoaXMzLnVzZXJPcHRpb25zKTtcbiAgICAgICAgICAgICAgICB4LlN0YXJ0KFwiaHR0cHM6Ly9hZHJpYW5vdGlnZXIuZ2l0aHViLmlvL2Rlc2t0b3BQZXQvUGV0cy9cIiArIGpzb24ucGV0c1trXS5mb2xkZXIgKyBcIi9hbmltYXRpb25zLnhtbFwiKTtcblxuICAgICAgICAgICAgICAgIF90aGlzMy5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChwZXQpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgZm9yICh2YXIgayBpbiBqc29uLnBldHMpIHtcbiAgICAgICAgICAgICAgdmFyIHBldDtcblxuICAgICAgICAgICAgICBfbG9vcChrKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZGl2KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1dKTtcblxuICByZXR1cm4gZVNoZWVwO1xufSgpO1xuXG47Il0sImZpbGUiOiJlc2hlZXAubWluLmpzIn0=
